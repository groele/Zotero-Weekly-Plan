# 📝 任务编辑增强功能说明

## 🎯 功能概述

**版本**：1.0.0  
**更新日期**：2025-10-17  
**解决问题**：任务条目编辑体验差，难以快速复制任务信息

---

## ✨ 新增功能

### 1. 双击复制任务内容 ⭐

**操作方式**：双击任务文字区域

**功能说明**：

- 🎯 双击任务内容即可将文字复制到系统剪贴板
- ✅ 复制成功后显示绿色"已复制！"提示
- ❌ 复制失败时显示红色"复制失败"提示
- 📋 同时自动选中全部文字内容，方便查看

**使用场景**：

- 快速复制任务标题用于其他地方
- 分享任务内容给他人
- 备份重要任务信息

**视觉反馈**：

- 绿色气泡提示（成功）
- 红色气泡提示（失败）
- 0.6秒后自动消失
- 文字被自动选中高亮

---

### 2. 快捷键支持 ⌨️

**Enter 键保存**

- 按下 `Enter` 键：保存当前编辑并退出编辑模式
- 按下 `Shift + Enter`：在内容中插入换行符

**Esc 键取消**

- 按下 `Esc` 键：取消本次编辑，恢复原内容

**组合键说明**：

```
Enter           → 保存并退出编辑
Shift + Enter   → 换行（多行任务）
Esc             → 取消编辑，恢复原内容
```

---

### 3. 编辑体验优化 🎨

#### 禁用拼写检查

- 关闭浏览器自动拼写检查（红色波浪线）
- 提升编辑流畅度，减少干扰

#### 悬停提示

- 鼠标悬停在任务内容上时显示操作提示：
  ```
  双击复制 | Enter保存 | Shift+Enter换行 | Esc取消
  ```

#### 视觉反馈增强

- 悬停时：淡蓝色背景高亮
- 聚焦时：蓝色边框 + 淡蓝色背景
- 编辑时：文本光标 (`I`) 明确显示
- 拖拽时：手形光标 (`✋`) 清晰指示

---

## 🎬 使用演示

### 场景 1：复制任务内容

```
1. 找到你想复制的任务
   ↓
2. 双击任务文字区域
   ↓
3. 看到绿色"已复制！"提示
   ✅ 文字已复制到剪贴板
   ✅ 文字被自动选中高亮
   ↓
4. 在其他地方 Ctrl+V 粘贴使用
```

### 场景 2：快速编辑任务

```
1. 单击任务文字区域
   ↓ 进入编辑模式（蓝色边框）

2. 修改文字内容
   ↓ 输入新内容

3. 按 Enter 键保存
   ✅ 自动退出编辑模式
   ✅ 内容已保存到数据库
```

### 场景 3：多行任务编辑

```
1. 单击任务进入编辑模式
   ↓
2. 输入第一行内容
   ↓
3. 按 Shift + Enter 换行
   ↓
4. 输入第二行内容
   ↓
5. 按 Enter 保存
   ✅ 多行任务保存成功
```

### 场景 4：取消错误编辑

```
1. 单击任务进入编辑模式
   ↓
2. 不小心输入了错误内容
   ↓
3. 按 Esc 键取消
   ✅ 内容恢复为修改前的状态
   ✅ 自动退出编辑模式
```

---

## 🔍 技术实现细节

### TypeScript 实现

**文件**：`src/modules/weekPlan.ts`

**核心代码**：

```typescript
// 1. 禁用拼写检查
content.setAttribute("spellcheck", "false");

// 2. 双击复制功能
content.addEventListener("dblclick", (e: Event) => {
  e.preventDefault();
  e.stopPropagation();

  const text = content.textContent?.trim() || "";
  if (!text) return;

  try {
    // 使用 Zotero 的剪贴板 API
    const clipboardHelper = (Components.classes as any)[
      "@mozilla.org/widget/clipboardhelper;1"
    ].getService((Components.interfaces as any).nsIClipboardHelper);
    clipboardHelper.copyString(text);

    // 显示成功提示
    this.showCopyFeedback(content, "已复制！");

    // 选中全部文本
    const selection = this.panelDoc!.defaultView?.getSelection();
    const range = this.panelDoc!.createRange();
    range.selectNodeContents(content);
    selection?.removeAllRanges();
    selection?.addRange(range);
  } catch (err) {
    this.showCopyFeedback(content, "复制失败", true);
  }
});

// 3. 快捷键支持
content.addEventListener("keydown", (e: KeyboardEvent) => {
  // Enter 保存
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    content.blur(); // 触发保存
  }
  // Esc 取消
  if (e.key === "Escape") {
    e.preventDefault();
    content.textContent = taskData.text || "";
    content.blur();
  }
});

// 4. 悬停提示
content.title = "双击复制 | Enter保存 | Shift+Enter换行 | Esc取消";
```

**showCopyFeedback 方法**：

```typescript
private showCopyFeedback(
  element: HTMLElement,
  message: string,
  isError: boolean = false,
): void {
  if (!this.panelDoc) return;

  // 创建提示元素
  const feedback = this.panelDoc.createElement("div");
  feedback.className = "zoteroplan-copy-feedback";
  feedback.textContent = message;
  feedback.style.cssText = `
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: ${isError ? "#fa5252" : "#20c997"};
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    pointer-events: none;
    animation: copyFeedbackPulse 0.6s ease-out;
  `;

  // 添加到任务元素
  const taskElement = element.closest(".zoteroplan-task") as HTMLElement;
  if (taskElement) {
    const originalPosition = taskElement.style.position;
    taskElement.style.position = "relative";
    taskElement.appendChild(feedback);

    // 600ms 后移除
    setTimeout(() => {
      feedback.remove();
      taskElement.style.position = originalPosition;
    }, 600);
  }
}
```

### CSS 样式

**文件**：`addon/content/weekPlan.css`

**新增样式**：

```css
/* 任务内容悬停效果 */
.zoteroplan-task-content:hover {
  background: rgba(0, 123, 255, 0.02);
  border-radius: 4px;
}

/* 复制反馈动画 */
@keyframes copyFeedbackPulse {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.95);
  }
}

.zoteroplan-copy-feedback {
  animation: copyFeedbackPulse 0.6s ease-out;
}
```

---

## 📊 功能对比表

| 功能         | 修改前                 | 修改后             |
| ------------ | ---------------------- | ------------------ |
| 复制任务内容 | ❌ 需要手动选中+Ctrl+C | ✅ 双击即可复制    |
| 保存编辑     | ❌ 只能点击外部区域    | ✅ Enter键快速保存 |
| 取消编辑     | ❌ 需要刷新页面        | ✅ Esc键取消编辑   |
| 多行任务     | ❌ 不支持              | ✅ Shift+Enter换行 |
| 拼写检查     | ❌ 红色波浪线干扰      | ✅ 已禁用          |
| 操作提示     | ❌ 无提示              | ✅ 悬停显示提示    |
| 复制反馈     | ❌ 无反馈              | ✅ 绿色气泡提示    |
| 文字选中     | ❌ 需要手动选中        | ✅ 双击自动选中    |

---

## 🧪 测试清单

### ✅ 基础功能测试

- [ ] 双击任务文字可以复制到剪贴板
- [ ] 复制成功显示绿色"已复制！"提示
- [ ] 提示 0.6 秒后自动消失
- [ ] 双击后文字被自动选中高亮
- [ ] 粘贴的内容与任务内容一致

### ✅ 快捷键测试

- [ ] Enter 键可以保存编辑并退出
- [ ] Shift+Enter 可以插入换行
- [ ] Esc 键可以取消编辑恢复原内容
- [ ] 单击外部区域也能保存编辑

### ✅ 编辑体验测试

- [ ] 悬停任务时显示淡蓝色背景
- [ ] 聚焦时显示蓝色边框
- [ ] 悬停时显示操作提示文字
- [ ] 拼写检查已被禁用（无红色波浪线）
- [ ] 编辑时光标为文本光标（`I`）

### ✅ 兼容性测试

- [ ] 双击复制不影响拖拽功能
- [ ] 编辑时不会触发拖拽
- [ ] 复制后仍可正常编辑
- [ ] 多行任务可以正常保存
- [ ] 空任务双击不会出错

---

## 🎯 使用技巧

### 技巧 1：快速复制多个任务

```
1. 双击第一个任务复制
2. 粘贴到笔记本
3. 双击第二个任务复制
4. 粘贴到笔记本
... 重复操作
```

### 技巧 2：创建多行详细任务

```
1. 单击任务进入编辑
2. 输入任务标题
3. Shift+Enter 换行
4. 输入任务详情
5. Shift+Enter 换行
6. 输入更多内容
7. Enter 保存
```

### 技巧 3：快速编辑工作流

```
单击 → 编辑 → Enter 保存
单击 → 编辑 → Esc 取消
```

### 技巧 4：批量整理任务

```
1. 双击复制任务 A
2. 拖拽任务 A 到其他列
3. 双击复制任务 B
4. 拖拽任务 B 到其他列
... 快速整理
```

---

## ⚠️ 注意事项

### 双击复制的限制

1. **必须双击文字区域**
   - ✅ 双击任务内容文字
   - ❌ 双击任务卡片边缘、元数据区域无效

2. **空任务无法复制**
   - 空白任务双击不会触发复制
   - 只有文字内容的任务才能复制

3. **剪贴板权限**
   - Zotero 内置剪贴板 API 通常有权限
   - 极少数情况下可能复制失败

### 快捷键冲突

- `Enter` 键在编辑模式下会保存
- 如果需要换行，必须使用 `Shift+Enter`
- `Esc` 键会取消编辑，慎用

### 拖拽与编辑

- 编辑时不能拖拽（内容区域阻止了拖拽事件）
- 拖拽时必须点击任务卡片的边缘区域
- 这是为了避免冲突的设计

---

## 🔧 调试信息

### 控制台日志

双击复制时会在控制台输出：

```
任务内容已复制: 这是任务内容
```

复制失败时会输出：

```
复制失败: [Error object]
```

### 查看日志

1. 按 `F12` 打开浏览器开发者工具
2. 切换到 **Console** 标签
3. 双击任务进行测试
4. 查看日志输出

---

## 📚 相关文档

- [拖拽功能修复文档](./DRAG_FIX_CONTENTEDITABLE.md)
- [拖拽功能验证指南](./拖拽功能验证指南.md)
- [布局优化文档](./DRAG_AND_LAYOUT_FIX.md)

---

## 🎉 功能总结

### 修改前的问题

❌ 复制任务内容需要手动选中文字  
❌ 编辑只能点击外部保存，不够直观  
❌ 没有快捷键支持，效率低  
❌ 拼写检查干扰编辑体验  
❌ 无操作提示，新手不友好

### 修改后的优势

✅ **双击复制**：一键复制任务内容到剪贴板  
✅ **快捷键支持**：Enter保存、Esc取消、Shift+Enter换行  
✅ **视觉反馈**：绿色气泡提示复制成功  
✅ **禁用拼写检查**：无红色波浪线干扰  
✅ **操作提示**：悬停显示快捷键说明  
✅ **自动选中**：双击后自动高亮文字  
✅ **编辑体验**：流畅的悬停和聚焦效果

---

**版本**：1.0.0  
**开发团队**：Zotero Weekly Plan Team  
**更新日期**：2025-10-17

🎯 **现在任务编辑更快捷、更友好、更高效！**
