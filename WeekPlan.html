<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Âë®‰ªªÂä°Èù¢Êùø ‚Äî È´òÁ∫ßÁâà</title>
  <style>
    :root{
      --bg: #f8f9fa; --card-bg: #ffffff; --accent: #007bff; --text-main: #343a40; 
      --text-muted: #6c757d; --border-color: rgba(0,0,0,0.1); --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      --col-plan: #339af0; --col-todo: #845ef7; --col-doing: #fd7e14; --col-done: #20c997;
      --col-plan-light: rgba(51, 154, 240, 0.08); --col-todo-light: rgba(132, 94, 247, 0.08);
      --col-doing-light: rgba(253, 126, 20, 0.08); --col-done-light: rgba(32, 201, 151, 0.08);
      --danger-text: #e03131; --danger-bg-hover: rgba(224, 49, 49, 0.1);
      --col-gap:18px; --radius:12px; --panel-padding:18px;
      --priority-high: #fa5252; --priority-medium: #ffd43b; --priority-low: #51cf66;
    }
    [data-theme="dark"] {
      --bg: #1a1a1a; --card-bg: #2d2d2d; --accent: #4dabf7; --text-main: #e9ecef; 
      --text-muted: #adb5bd; --border-color: rgba(255,255,255,0.1); --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      --col-plan-light: rgba(51, 154, 240, 0.15); --col-todo-light: rgba(132, 94, 247, 0.15);
      --col-doing-light: rgba(253, 126, 20, 0.15); --col-done-light: rgba(32, 201, 151, 0.15);
      --danger-text: #ff6b6b; --danger-bg-hover: rgba(255, 107, 107, 0.1);
    }
    *{box-sizing:border-box;font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", "Microsoft Yahei", sans-serif;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text-main); scroll-behavior: smooth;}
    
    /* È°µÈù¢Âä†ËΩΩÂä®Áîª */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .app{max-width:1200px;margin:28px auto;padding:18px; animation: fadeInUp 0.6s ease-out;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px; flex-wrap: wrap; gap: 12px;}
    header h1{font-size:28px;margin:0; color: var(--text-main); font-weight: 700; letter-spacing: -0.5px;}
    .header-info { display: flex; align-items: center; gap: 16px; }
    .week-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    #currentDate { font-size: 15px; color: var(--accent); font-weight: 600; margin-right: 12px; padding: 6px 12px; background: rgba(0, 123, 255, 0.08); border-radius: 6px; }
    #liveClock { font-size: 17px; color: var(--text-main); font-weight: 600; font-variant-numeric: tabular-nums; }
    .btn{background:var(--card-bg);border:1px solid var(--border-color);padding:9px 14px;border-radius:8px;cursor:pointer;color: var(--text-main);transition: all 0.2s ease; font-weight: 500;}
    .btn:hover{background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 2px 8px rgba(0, 123, 255, 0.25); transform: translateY(-1px);}
    .btn:active{transform:translateY(0px)}
    .btn:disabled {cursor: not-allowed; opacity: 0.5; background: #f1f3f5; transform: none;}
    .btn.danger { color: var(--danger-text); border-color: var(--danger-text); }
    .btn.danger:hover { background: var(--danger-text); color: white; box-shadow: 0 2px 8px rgba(224, 49, 49, 0.25); }
    .board{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--col-gap)}
    .column{background: var(--card-bg);padding:var(--panel-padding);border-radius:var(--radius);min-height:320px;border-top: 4px solid;transition: all 0.3s ease; position: relative; overflow: hidden;}
    .column::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.05; pointer-events: none; transition: opacity 0.3s; }
    .column:hover::before { opacity: 0.08; }
    [data-theme="dark"] .column { background: #262626; }
    .column[data-column="planning"] { border-color: var(--col-plan); }
    .column[data-column="planning"]::before { background: linear-gradient(135deg, var(--col-plan) 0%, #4dabf7 100%); }
    .column[data-column="todo"] { border-color: var(--col-todo); }
    .column[data-column="todo"]::before { background: linear-gradient(135deg, var(--col-todo) 0%, #9775fa 100%); }
    .column[data-column="doing"] { border-color: var(--col-doing); }
    .column[data-column="doing"]::before { background: linear-gradient(135deg, var(--col-doing) 0%, #ff922b 100%); }
    .column[data-column="done"] { border-color: var(--col-done); }
    .column[data-column="done"]::before { background: linear-gradient(135deg, var(--col-done) 0%, #51cf66 100%); }
    .col-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .col-title{font-weight:700; font-size: 1.15em; letter-spacing: -0.3px;}
    .task-count { background: var(--accent); color: white; padding: 3px 9px; border-radius: 12px; font-size: 12px; margin-left: 8px; font-weight: 600; min-width: 24px; text-align: center; box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3); }
    .col-list{min-height:200px;display:flex;flex-direction:column;gap:10px}
    .task{background: var(--card-bg);padding:14px;border-radius:10px;border:1px solid var(--border-color);cursor:grab; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;}
    .task:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12); border-color: var(--accent); }
    /* ‰ªªÂä°Âç°ÁâáÊåâÊ†èÁõÆÁùÄËâ≤ */
    .column[data-column="planning"] .task { border-left: 3px solid var(--col-plan); background: linear-gradient(to right, var(--col-plan-light), var(--card-bg)); }
    .column[data-column="todo"] .task { border-left: 3px solid var(--col-todo); background: linear-gradient(to right, var(--col-todo-light), var(--card-bg)); }
    .column[data-column="doing"] .task { border-left: 3px solid var(--col-doing); background: linear-gradient(to right, var(--col-doing-light), var(--card-bg)); }
    .column[data-column="done"] .task { border-left: 3px solid var(--col-done); background: linear-gradient(to right, var(--col-done-light), var(--card-bg)); }
    /* ‰ªªÂä°Ê∑ªÂä†Âä®Áîª */
    @keyframes taskSlideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .task.newly-added { animation: taskSlideIn 0.4s ease-out; }
    .task[data-priority="high"] { border-left: 4px solid var(--priority-high); }
    .task[data-priority="medium"] { border-left: 4px solid var(--priority-medium); }
    .task[data-priority="low"] { border-left: 4px solid var(--priority-low); }
    .task-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
    .tag { background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .priority-badge { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; border-radius: 50%; }
    .priority-badge.high { background: var(--priority-high); }
    .priority-badge.medium { background: var(--priority-medium); }
    .priority-badge.low { background: var(--priority-low); }
    .task-note { font-size: 12px; color: var(--text-muted); margin-top: 6px; font-style: italic; border-top: 1px dashed var(--border-color); padding-top: 6px; }
    .task.dragging{opacity:0.9;transform:scale(0.98);background: var(--accent); color: white;}
    .task.dragging .meta, .task.dragging .del-btn { color: white; opacity: 0.8; }
    .task .content:focus { outline:2px solid var(--accent); }
    .meta{display:flex;justify-content:space-between;align-items: center;margin-top:8px;font-size:12px;color:var(--text-muted)}
    .del-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px 5px; border-radius: 4px; font-size: 14px; }
    .del-btn:hover { background-color: var(--danger-bg-hover); color: var(--danger-text); }
    .drop-indicator { height: 50px; background-color: rgba(0, 123, 255, 0.1); border: 2px dashed var(--accent); border-radius: 8px; margin: 5px 0; }
    .small{font-size:13px;color:var(--text-muted)}
    #weekNumberLabel { font-weight: 500; color: var(--accent); margin-left: 4px; }
    .add-row{display:flex;gap:6px;margin-top:12px}
    .add-row button { transition: all 0.2s ease; }
    .add-row button:not(:disabled):hover { transform: scale(1.05); }
    input[type='text']{flex:1;padding:10px 14px;border-radius:8px;border:2px solid var(--border-color);background:var(--card-bg);color:inherit; transition: all 0.2s ease; font-size: 14px;}
    input[type='text']:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(0,123,255,0.12); transform: translateY(-1px); }
    footer{margin-top:24px;color:var(--text-muted);font-size:13px; text-align: center; padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);}
    footer::before { content: 'üí° '; }
    footer .shortcut-hint { display: inline-block; margin-left: 12px; padding: 4px 8px; background: var(--bg); border-radius: 4px; font-size: 11px; }
    
    /* ‚ú® Êñ∞Â¢ûÔºöËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1000; }
    .modal.visible { opacity: 1; pointer-events: auto; }
    .modal-content { background: var(--card-bg); padding: 24px; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
    .modal.visible .modal-content { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;}
    .modal-header h2 { margin: 0; font-size: 18px; }
    .close-btn { font-size: 24px; cursor: pointer; color: var(--text-muted); background: none; border: none; }
    .settings-section { margin-bottom: 20px; }
    .settings-section h3 { margin: 0 0 12px; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .settings-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .search-bar { display: flex; align-items: center; }
    .search-bar input { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .stat-card { background: var(--card-bg); padding: 16px; border-radius: 10px; text-align: center; border: 2px solid var(--border-color); transition: all 0.2s ease; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15); border-color: var(--accent); }
    .stat-number { font-size: 28px; font-weight: 800; color: var(--accent); letter-spacing: -1px; }
    .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    .toggle-switch { position: relative; display: inline-block; width: 48px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(24px); }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
    /* Á©∫Áä∂ÊÄÅÊèêÁ§∫ */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-text { font-size: 14px; line-height: 1.6; }
    
    /* ËøõÂ∫¶Êù°‰ºòÂåñ */
    .progress-bar { width: 100%; height: 10px; background: var(--border-color); border-radius: 5px; overflow: hidden; margin-top: 8px; position: relative; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent) 0%, #4dabf7 100%); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
    .progress-fill::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Áî®Êà∑Âç°ÁâáÊ†∑Âºè */
    .user-card { background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%), var(--card-bg); border-radius: var(--radius); padding: 24px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); margin-bottom: 28px; display: flex; align-items: center; gap: 20px; border: 2px solid rgba(102, 126, 234, 0.15); transition: all 0.3s ease; }
    .user-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.3); }
    .user-avatar-wrapper { position: relative; }
    .user-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent); cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: 700; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .user-avatar:hover { transform: scale(1.08) rotate(5deg); border-color: var(--col-doing); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .avatar-upload-btn { position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; border: 2px solid var(--card-bg); border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    .avatar-upload-btn:hover { background: var(--col-doing); }
    .user-info { flex: 1; }
    .user-id { font-size: 22px; font-weight: 700; color: var(--text-main); margin: 0 0 8px 0; display: flex; align-items: center; gap: 10px; }
    .user-id-edit { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 4px; transition: background 0.2s; }
    .user-id-edit:hover { background: var(--border-color); }
    .user-motto { font-size: 15px; color: var(--text-muted); font-style: italic; margin: 0 0 10px 0; line-height: 1.6; cursor: pointer; transition: all 0.2s; }
    .user-motto:hover { color: var(--accent); transform: translateX(2px); }
    .user-motto::before { content: '"'; }
    .user-motto::after { content: '"'; }
    .user-stats-mini { display: flex; gap: 12px; margin-top: 8px; }
    .user-stat-item { font-size: 13px; color: var(--text-muted); font-weight: 500; }
    .user-stat-item strong { color: var(--accent); font-weight: 700; font-size: 15px; }
    
    /* Âø´Êç∑ÈîÆÊèêÁ§∫ */
    .keyboard-hint { position: fixed; bottom: 20px; right: 20px; background: var(--card-bg); padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 12px; color: var(--text-muted); border: 1px solid var(--border-color); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; }
    .keyboard-hint.show { opacity: 1; }
    .keyboard-hint kbd { background: var(--bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color); font-family: monospace; margin: 0 2px; }
    
    @media (max-width:900px){.board{grid-template-columns:repeat(2,1fr)}.stats-grid{grid-template-columns:repeat(2,1fr)}.keyboard-hint{display:none;}}
    @media (max-width:600px){.board{grid-template-columns:1fr}.app{padding:12px}.header-info{width:100%;justify-content:space-between}.stats-grid{grid-template-columns:repeat(2,1fr)}.user-card{flex-direction:column;text-align:center}.user-avatar{width:70px;height:70px}}
  </style>
</head>
<body>
  <div class="app">
    <!-- Áî®Êà∑‰∏™‰∫∫‰ø°ÊÅØÂç°Áâá -->
    <div class="user-card">
      <div class="user-avatar-wrapper">
        <div class="user-avatar" id="userAvatar">
          <span id="avatarInitial">U</span>
          <img id="avatarImg" style="display:none; width:100%; height:100%; border-radius:50%; object-fit:cover;" />
        </div>
        <div class="avatar-upload-btn" id="avatarUploadBtn" title="‰∏ä‰º†Â§¥ÂÉè">üì∑</div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none;" />
      </div>
      <div class="user-info">
        <h2 class="user-id">
          <span id="userIdDisplay">ÊàëÁöÑ‰ªªÂä°ÁúãÊùø</span>
          <button class="user-id-edit" id="editUserId" title="ÁºñËæëÁî®Êà∑ID">‚úèÔ∏è</button>
        </h2>
        <p class="user-motto" id="userMotto" title="ÁÇπÂáªÁºñËæëÊ†ºË®Ä">‰ªäÊó•‰∫ã, ‰ªäÊó•ÊØï üöÄ</p>
        <div class="user-stats-mini">
          <span class="user-stat-item">üéØ Êú¨Âë®‰ªªÂä°: <strong id="userWeekTotal">0</strong></span>
          <span class="user-stat-item">‚úÖ Â∑≤ÂÆåÊàê: <strong id="userWeekDone">0</strong></span>
        </div>
      </div>
    </div>

    <header>
      <h1>üìä Âë®‰ªªÂä°ÁúãÊùø</h1>
      <div class="header-info">
        <div class="week-controls">
          <div id="currentDate" style="font-size: 13px; color: var(--text-muted); margin-right: 12px;"></div>
          <button class="btn" id="prevWeek" title="‰∏ä‰∏ÄÂë®">‚óÄ</button>
          <div class="small" id="weekLabel">‚Äî‚Äî</div>
          <div class="small" id="weekNumberLabel"></div>
          <button class="btn" id="nextWeek" title="‰∏ã‰∏ÄÂë®">‚ñ∂</button>
          <button class="btn" id="todayBtn">Êú¨Âë®</button>
          <button class="btn danger" id="clearBtn" title="Ê∏ÖÁ©∫Êú¨Âë®ÊâÄÊúâ‰ªªÂä°">Ê∏ÖÁ©∫</button>
        </div>
        <div id="liveClock"></div>
        <label class="toggle-switch" title="ÂàáÊç¢Ê∑±Ëâ≤Ê®°Âºè">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <button class="btn" id="settingsBtn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
      </div>
    </header>

    <!-- ÊêúÁ¥¢ÂíåÂ∑•ÂÖ∑Ê†è -->
    <div class="toolbar">
      <div class="search-bar" style="flex: 1;">
        <input type="text" id="searchInput" placeholder="üîç ÊêúÁ¥¢‰ªªÂä°..." />
      </div>
      <button class="btn" id="statsBtn" title="Êü•ÁúãÁªüËÆ°">üìà ÁªüËÆ°</button>
    </div>

    <!-- ÁªüËÆ°Èù¢Êùø -->
    <div id="statsPanel" class="stats-grid" style="display: none;">
      <div class="stat-card">
        <div class="stat-number" id="statTotal">0</div>
        <div class="stat-label">ÊÄª‰ªªÂä°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statPlanning">0</div>
        <div class="stat-label">ËßÑÂàí‰∏≠</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statTodo">0</div>
        <div class="stat-label">ÂæÖÂÅö</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statDoing">0</div>
        <div class="stat-label">ËøõË°å‰∏≠</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statDone">0</div>
        <div class="stat-label">Â∑≤ÂÆåÊàê</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statProgress">0%</div>
        <div class="stat-label">ÂÆåÊàêÁéá</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
    </div>

    <main class="board" id="board">
      <section class="column" data-column="planning">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">ËßÑÂàí</div>
            <span class="task-count" id="count-planning">0</span>
          </div>
          <div class="small">Ideas</div>
        </div>
        <div class="col-list" id="planningList"></div>
        <div class="add-row">
          <input type="text" placeholder="Ê∑ªÂä†Âà∞ËßÑÂàí..." id="input-planning" />
          <button class="btn" data-add-to="planning" disabled>Ê∑ªÂä†</button>
        </div>
      </section>
      <section class="column" data-column="todo">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">ÂæÖÂÅö</div>
            <span class="task-count" id="count-todo">0</span>
          </div>
          <div class="small">To Do</div>
        </div>
        <div class="col-list" id="todoList"></div>
        <div class="add-row">
          <input type="text" placeholder="Ê∑ªÂä†Âà∞ÂæÖÂÅö..." id="input-todo" />
          <button class="btn" data-add-to="todo" disabled>Ê∑ªÂä†</button>
        </div>
      </section>
      <section class="column" data-column="doing">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">Ê≠£Âú®ÂÅö</div>
            <span class="task-count" id="count-doing">0</span>
          </div>
          <div class="small">In Progress</div>
        </div>
        <div class="col-list" id="doingList"></div>
        <div class="add-row">
          <input type="text" placeholder="Ê∑ªÂä†Âà∞Ê≠£Âú®ÂÅö..." id="input-doing" />
          <button class="btn" data-add-to="doing" disabled>Ê∑ªÂä†</button>
        </div>
      </section>
      <section class="column" data-column="done">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">ÂÆåÊàê</div>
            <span class="task-count" id="count-done">0</span>
          </div>
          <div class="small">Done</div>
        </div>
        <div class="col-list" id="doneList"></div>
        <div class="add-row">
          <input type="text" placeholder="Ê∑ªÂä†Âà∞ÂÆåÊàê..." id="input-done" />
          <button class="btn" data-add-to="done" disabled>Ê∑ªÂä†</button>
        </div>
      </section>
    </main>

    <footer>
      üìù ÂèåÂáªÁºñËæë | üñ±Ô∏è ÊãñÊãΩÁßªÂä® | üíæ Ëá™Âä®‰øùÂ≠ò | üìÖ ÊØèÂë®Áã¨Á´ãÂ≠òÂÇ®
      <span class="shortcut-hint">Âø´Êç∑ÈîÆ: <kbd>Ctrl</kbd>+<kbd>K</kbd> ÊêúÁ¥¢ | <kbd>Ctrl</kbd>+<kbd>S</kbd> ÁªüËÆ°</span>
    </footer>
  </div>

  <!-- Âø´Êç∑ÈîÆÊèêÁ§∫ -->
  <div class="keyboard-hint" id="keyboardHint">
    ‚å®Ô∏è Âø´Êç∑ÈîÆÂ∑≤ÂêØÁî®
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öôÔ∏è ËÆæÁΩÆ</h2>
        <button class="close-btn" id="closeSettingsBtn">&times;</button>
      </div>
      <div class="settings-body">
        <div class="settings-section">
          <h3>üìä Êï∞ÊçÆÁÆ°ÁêÜ</h3>
          <p class="small">ÂØºÂá∫ÂΩìÂâçÂë®ÁöÑÊï∞ÊçÆ‰∏∫Êñá‰ª∂,Áî®‰∫éÂ§á‰ªΩÊàñÂú®ÂÖ∂‰ªñÂ∫îÁî®‰∏≠‰ΩøÁî®„ÄÇ</p>
          <div class="settings-actions">
            <button class="btn" id="exportJsonBtn">üíæ ÂØºÂá∫JSON</button>
            <button class="btn" id="exportCsvBtn">üìÑ ÂØºÂá∫CSV</button>
            <button class="btn" id="exportImageBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">üéÜ ÁîüÊàêÊàêÂ∞±Âç°Áâá</button>
            <div class="file-input-wrapper">
              <button class="btn">üìÇ ÂØºÂÖ•JSON</button>
              <input type="file" id="importJsonInput" accept=".json" />
            </div>
          </div>
        </div>
        <div class="settings-section">
          <h3>üé® ‰∏™ÊÄßÂåñ</h3>
          <p class="small">Ëá™ÂÆö‰πâÊÇ®ÁöÑ‰ªªÂä°ÁúãÊùøÂ§ñËßÇÂíåË°å‰∏∫„ÄÇ</p>
          <div class="settings-actions">
            <label>
              <input type="checkbox" id="autoSaveToggle" checked /> Ëá™Âä®‰øùÂ≠ò
            </label>
            <label>
              <input type="checkbox" id="showTimestampToggle" checked /> ÊòæÁ§∫Êó∂Èó¥Êà≥
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h3>üë§ Áî®Êà∑‰ø°ÊÅØ</h3>
          <p class="small">ÁÆ°ÁêÜÊÇ®ÁöÑ‰∏™‰∫∫ËµÑÊñôÂíå‰∏™ÊÄßÂåñËÆæÁΩÆ„ÄÇ</p>
          <div class="settings-actions">
            <button class="btn" id="resetProfileBtn">üîÑ ÈáçÁΩÆ‰∏™‰∫∫‰ø°ÊÅØ</button>
            <button class="btn danger" id="clearAvatarBtn">üóëÔ∏è Ê∏ÖÈô§Â§¥ÂÉè</button>
          </div>
        </div>
        </div>
    </div>
  </div>


  <script>
    // ÂÖ®Â±ÄÈîôËØØÂ§ÑÁêÜ
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÈîôËØØ‰∏äÊä•ÈÄªËæë
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled Promise rejection:', event.reason);
      // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÈîôËØØ‰∏äÊä•ÈÄªËæë
    });
    
    document.addEventListener('DOMContentLoaded',()=>{
      // --- Â¢ûÂº∫ÁöÑÂ∑•ÂÖ∑ÂáΩÊï∞ÔºåÊ∑ªÂä†ÂèÇÊï∞È™åËØÅÂíåÈîôËØØÂ§ÑÁêÜ ---
      const startOfWeek=(d)=>{
        try {
          // ÂèÇÊï∞È™åËØÅ
          const date = d instanceof Date ? d : new Date(d);
          // Ê£ÄÊü•Êó•ÊúüÊòØÂê¶ÊúâÊïà
          if (isNaN(date.getTime())) {
            console.warn('Invalid date provided to startOfWeek, using current date');
            return startOfWeek(new Date());
          }
          const a = new Date(date); // ÂàõÂª∫ÂâØÊú¨ÈÅøÂÖç‰øÆÊîπÂéüÂßãÊó•Êúü
          const e = (a.getDay() + 6) % 7;
          a.setDate(a.getDate() - e);
          a.setHours(0, 0, 0, 0);
          return a;
        } catch (err) {
          console.error('Error in startOfWeek:', err);
          return new Date(); // ËøîÂõûÂΩìÂâçÊó•Êúü‰Ωú‰∏∫ÂêéÂ§á
        }
      };
      
      const weekKey=(a)=>{
        try {
          const startDate = startOfWeek(a);
          return `kanban:${startDate.toISOString().slice(0,10)}`;
        } catch (err) {
          console.error('Error in weekKey:', err);
          return `kanban:${startOfWeek(new Date()).toISOString().slice(0,10)}`;
        }
      };
      
      const fmtRange=(a)=>{
        try {
          const e = startOfWeek(a);
          const t = new Date(e);
          t.setDate(t.getDate() + 6);
          return `${e.getMonth() + 1}/${e.getDate()} ~ ${t.getMonth() + 1}/${t.getDate()}`;
        } catch (err) {
          console.error('Error in fmtRange:', err);
          return 'Êó•ÊúüËåÉÂõ¥ÈîôËØØ';
        }
      };
      
      const escapeHtml=(a)=>{
        try {
          // Á°Æ‰øùËæìÂÖ•ÊòØÂ≠óÁ¨¶‰∏≤
          const str = a === null || a === undefined ? '' : String(a);
          return str.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;"); // È¢ùÂ§ñËΩ¨‰πâÂçïÂºïÂè∑
        } catch (err) {
          console.error('Error in escapeHtml:', err);
          return '';
        }
      };
      
      const getWeekNumber=(d)=>{
        try {
          // ÂèÇÊï∞È™åËØÅ
          const date = d instanceof Date ? d : new Date(d);
          if (isNaN(date.getTime())) {
            console.warn('Invalid date provided to getWeekNumber, using current date');
            return getWeekNumber(new Date());
          }
          
          const adjustedDate = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
          adjustedDate.setUTCDate(adjustedDate.getUTCDate() + 4 - (adjustedDate.getUTCDay() || 7));
          const yearStart = new Date(Date.UTC(adjustedDate.getUTCFullYear(), 0, 1));
          return Math.ceil(((adjustedDate - yearStart) / 864e5 + 1) / 7);
        } catch (err) {
          console.error('Error in getWeekNumber:', err);
          return 0;
        }
      };
      let currentWeek=new Date,draggedEl=null;const columns=["planning","todo","doing","done"],board=document.getElementById("board");
      const loadForWeek=()=>{
          try {
            const key=weekKey(currentWeek);
            let data = null;
            
            // ÂÆâÂÖ®Âú∞‰ªélocalStorageËé∑ÂèñÊï∞ÊçÆ
            try {
              const storedData=localStorage.getItem(key);
              if (storedData) {
                data=JSON.parse(storedData);
                // È™åËØÅÊï∞ÊçÆÁªìÊûÑ
                if (!data || typeof data !== 'object') {
                  console.warn('Invalid data structure in localStorage, using empty board');
                  data={planning:[],todo:[],doing:[],done:[]};
                }
              } else {
                data={planning:[],todo:[],doing:[],done:[]};
              }
            } catch (parseError) {
              console.error('Error parsing data from localStorage:', parseError);
              data={planning:[],todo:[],doing:[],done:[]};
            }
            
            columns.forEach(col=>{
              const listElement=document.getElementById(col+"List");
              if (!listElement) {
                console.warn(`List element for column ${col} not found`);
                return;
              }
              
              listElement.innerHTML="";
              const tasksForColumn=(data[col]||[]).filter(Boolean); // ËøáÊª§ÊéânullÂíåundefined
              
              if(tasksForColumn.length===0){
                listElement.innerHTML='<div class="empty-state"><div class="empty-state-icon">‚ú®</div><div class="empty-state-text">ËøòÊ≤°Êúâ‰ªªÂä°ÔºåÁÇπÂáª‰∏ãÊñπÊ∑ªÂä†ÂêßÔºÅ</div></div>';
              }else{
                // ÊåâÁÖßÂ≠òÂÇ®È°∫Â∫èÊ∑ªÂä†‰ªªÂä°ÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
                tasksForColumn.forEach(taskData=>{
                  try {
                    const taskElement=renderTask(taskData);
                    if (taskElement && taskElement.nodeType === 1) { // Á°Æ‰øùÊòØÊúâÊïàÁöÑDOMÂÖÉÁ¥†
                      listElement.appendChild(taskElement);
                    }
                  } catch (taskError) {
                    console.error(`Error rendering task in column ${col}:`, taskError);
                  }
                });
              }
            });
            
            // Êõ¥Êñ∞UIÂÖÉÁ¥†ÔºåÊ∑ªÂä†Á©∫ÂÄºÊ£ÄÊü•
            const weekLabelEl=document.getElementById("weekLabel");
            if (weekLabelEl) weekLabelEl.textContent=fmtRange(currentWeek);
            
            const weekNumberLabelEl=document.getElementById("weekNumberLabel");
            if (weekNumberLabelEl) weekNumberLabelEl.textContent=`(Á¨¨ ${getWeekNumber(currentWeek)} Âë®)`;
            
            // Á°Æ‰øùËøô‰∫õÂáΩÊï∞Â≠òÂú®ÂÜçË∞ÉÁî®
            if (typeof updateTaskCounts === 'function') updateTaskCounts();
            if (typeof updateStats === 'function') updateStats();
            if (typeof checkEmptyStates === 'function') checkEmptyStates();
          } catch (err) {
            console.error('Error loading week data:', err);
            // Âç≥‰ΩøÂá∫Èîô‰πüÂ∞ùËØïÊÅ¢Â§çÂü∫Êú¨ÂäüËÉΩ
            if (typeof updateTaskCounts === 'function') updateTaskCounts();
          }
        };
      const saveForWeek=()=>{
          try {
            const key=weekKey(currentWeek);
            const data={};
            
            columns.forEach(col=>{
              const tasks=[];
              try {
                // ‰ªé‰∏äÂà∞‰∏ãÈÅçÂéÜDOMÂÖÉÁ¥†Ôºå‰øùÊåÅËßÜËßâÈ°∫Â∫è
                const taskElements=document.querySelectorAll(`#${col}List .task`);
                taskElements.forEach(taskElement=>{
                  try {
                    const contentElement=taskElement.querySelector(".content");
                    // Á°Æ‰øùÊâÄÊúâÂøÖË¶ÅÁöÑÂÖÉÁ¥†ÈÉΩÂ≠òÂú®
                    if (contentElement && taskElement.dataset.id) {
                      tasks.push({
                        id:taskElement.dataset.id,
                        text:contentElement.innerText || '',
                        created:taskElement.dataset.created || new Date().toISOString(),
                        priority:taskElement.dataset.priority||'none',
                        tags:taskElement.dataset.tags||'',
                        note:taskElement.dataset.note||''
                      });
                    }
                  } catch (taskError) {
                    console.error(`Error saving task in column ${col}:`, taskError);
                    // Ë∑≥ËøáÈîôËØØÁöÑ‰ªªÂä°ÔºåÁªßÁª≠‰øùÂ≠òÂÖ∂‰ªñ‰ªªÂä°
                  }
                });
              } catch (queryError) {
                console.error(`Error querying tasks for column ${col}:`, queryError);
              }
              data[col]=tasks;
            });
            
            // ÂÆâÂÖ®Âú∞‰øùÂ≠òÂà∞localStorage
            try {
              const jsonString=JSON.stringify(data);
              localStorage.setItem(key,jsonString);
            } catch (storageError) {
              console.error('Error saving data to localStorage:', storageError);
              // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†È¢ùÂ§ñÁöÑÈîôËØØÂ§ÑÁêÜÔºåÊØîÂ¶ÇÊòæÁ§∫Ë≠¶Âëä
              if (storageError instanceof DOMException && 
                  (storageError.name === 'QuotaExceededError' || 
                   storageError.name === 'NS_ERROR_DOM_QUOTA_REACHED')) {
                console.warn('localStorage quota exceeded, consider clearing old data');
              }
            }
            
            // Á°Æ‰øùËøô‰∫õÂáΩÊï∞Â≠òÂú®ÂÜçË∞ÉÁî®
            if (typeof updateTaskCounts === 'function') updateTaskCounts();
            if (typeof updateStats === 'function') updateStats();
            if (typeof checkEmptyStates === 'function') checkEmptyStates();
          } catch (err) {
            console.error('Error saving week data:', err);
          }
        };
      const renderTask=(taskData)=>{try {
          // È™åËØÅËæìÂÖ•ÂèÇÊï∞
          if (!taskData || typeof taskData !== 'object') {
            console.error('Invalid task data provided to renderTask:', taskData);
            return null;
          }
          
          // ÂàõÂª∫‰ªªÂä°ÂÖÉÁ¥†
          const taskElement=document.createElement("div");
          taskElement.className="task";
          taskElement.setAttribute("draggable","true");
          
          // ËÆæÁΩÆÊï∞ÊçÆÂ±ûÊÄßÔºåÁ°Æ‰øùÊúâÈªòËÆ§ÂÄº
          taskElement.dataset.id=taskData.id || `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          taskElement.dataset.created=taskData.created || new Date().toISOString();
          taskElement.dataset.priority=taskData.priority || 'none';
          taskElement.dataset.tags=taskData.tags || '';
          taskElement.dataset.note=taskData.note || '';
          
          // ËÆæÁΩÆ‰ºòÂÖàÁ∫ßÂ±ûÊÄß
          if(taskData.priority && taskData.priority!=='none'){
            taskElement.setAttribute('data-priority',taskData.priority);
          }
          
          // Ê†ºÂºèÂåñÂàõÂª∫Êó∂Èó¥
          const createdAt=new Date(taskElement.dataset.created);
          if (isNaN(createdAt.getTime())) {
            console.warn('Invalid date in task data, using current date');
            createdAt=new Date();
          }
          
          // ÊûÑÂª∫‰ºòÂÖàÁ∫ßÊ†áÁ≠æ
          let priorityBadge='';
          if(taskData.priority && taskData.priority!=='none'){
            // È™åËØÅ‰ºòÂÖàÁ∫ßÂÄºÁöÑÊúâÊïàÊÄß
            const validPriorities=['high', 'medium', 'low'];
            if (validPriorities.includes(taskData.priority)) {
              priorityBadge=`<span class="priority-badge ${taskData.priority}"></span>`;
            } else {
              console.warn(`Invalid priority value: ${taskData.priority}`);
            }
          }
          
          // ÊûÑÂª∫Ê†áÁ≠æHTML
          let tagsHtml='';
          if(taskData.tags){
            try {
              const tagList=taskData.tags.split(',').filter(tag=>tag.trim());
              if(tagList.length>0){
                tagsHtml='<div class="task-tags">'+tagList.map(tag=>`<span class="tag">${escapeHtml(tag.trim())}</span>`).join('')+'</div>';
              }
            } catch (tagsError) {
              console.error('Error processing tags:', tagsError);
            }
          }
          
          // ÊûÑÂª∫Â§áÊ≥®HTML
          let noteHtml='';
          if(taskData.note){
            noteHtml=`<div class="task-note">üìù ${escapeHtml(taskData.note)}</div>`;
          }
          
          // Ëé∑ÂèñÊó∂Èó¥Êà≥ÊòæÁ§∫ËÆæÁΩÆ
          const showTimeToggle=document.getElementById('showTimestampToggle');
          const showTime=showTimeToggle ? showTimeToggle.checked : true;
          
          // ËÆæÁΩÆHTMLÂÜÖÂÆπ
          taskElement.innerHTML=`
            ${priorityBadge}
            <div class="content">${escapeHtml(taskData.text || '')}</div>
            ${tagsHtml}
            ${noteHtml}
            <div class="meta">
              <span class="small timestamp" title="${createdAt.toLocaleString()}" style="display:${showTime?'inline':'none'}">ÂàõÂª∫‰∫é ${createdAt.toLocaleDateString()}</span>
              <button title="Âà†Èô§‰ªªÂä°" class="del-btn">\u2715</button>
            </div>
          `;
          
          // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÂåÖÂê´ÈîôËØØÂ§ÑÁêÜ
          try {
            const contentElement=taskElement.querySelector(".content");
            if (contentElement) {
              contentElement.addEventListener("dblclick",(e)=>{
                try {
                  e.target.setAttribute("contenteditable","true");
                  e.target.focus();
                } catch (editError) {
                  console.error('Error enabling task editing:', editError);
                }
              });
              
              contentElement.addEventListener("blur",(e)=>{
                try {
                  e.target.removeAttribute("contenteditable");
                  if (typeof saveForWeek === 'function') {
                    saveForWeek();
                  }
                } catch (saveError) {
                  console.error('Error saving task after edit:', saveError);
                }
              });
            }
            
            taskElement.addEventListener('contextmenu',(e)=>{
              try {
                e.preventDefault();
                if (typeof showTaskContextMenu === 'function') {
                  showTaskContextMenu(taskElement);
                }
              } catch (menuError) {
                console.error('Error showing task context menu:', menuError);
              }
            });
          } catch (eventError) {
            console.error('Error setting up task event listeners:', eventError);
          }
          
          return taskElement;
        } catch (err) {
          console.error('Error rendering task:', err);
          return null;
        }
      };
      const addTask=(columnName,taskText)=>{
        try {
          // È™åËØÅËæìÂÖ•ÂèÇÊï∞
          if (!columnName || typeof columnName !== 'string') {
            console.error('Invalid column name provided to addTask:', columnName);
            return null;
          }
          
          // È™åËØÅ‰ªªÂä°ÊñáÊú¨
          const trimmedText=(taskText || '').trim();
          if (!trimmedText) {
            console.warn('Empty task text provided, not adding task');
            return null;
          }
          
          // ÁîüÊàêÂîØ‰∏ÄID
          const taskId="t"+Date.now()+"_"+Math.random().toString(36).substr(2, 9);
          
          // ÂàõÂª∫‰ªªÂä°ÂØπË±°
          const taskData={
            id:taskId,
            text:trimmedText,
            created:new Date().toISOString(),
            priority:'none',
            tags:'',
            note:''
          };
          
          // Ê∏≤Êüì‰ªªÂä°ÂÖÉÁ¥†
          const taskElement=renderTask(taskData);
          if (!taskElement) {
            console.error('Failed to render new task');
            return null;
          }
          
          // Ëé∑ÂèñÁõÆÊ†áÂàóË°®ÂÖÉÁ¥†
          const listElement=document.getElementById(columnName+"List");
          if (!listElement) {
            console.error(`List element not found for column: ${columnName}`);
            return null;
          }
          
          // Ê∑ªÂä†Âä®ÁîªÊïàÊûúÂπ∂ËøΩÂä†Âà∞ÂàóË°®È°∂ÈÉ®
          taskElement.classList.add('newly-added');
          listElement.prepend(taskElement);
          
          // ‰øùÂ≠òÊï∞ÊçÆ
          if (typeof saveForWeek === 'function') {
            saveForWeek();
          }
          
          // Êõ¥Êñ∞Á©∫Áä∂ÊÄÅÊ£ÄÊü• - Á°Æ‰øùÊ∑ªÂä†‰ªªÂä°ÂêéÁßªÈô§Á©∫Áä∂ÊÄÅÊòæÁ§∫
          if(typeof checkEmptyStates === 'function') {
            checkEmptyStates();
          }
          
          // ÁßªÈô§Âä®ÁîªÁ±ª
          setTimeout(()=>{
            try {
              if (taskElement && taskElement.classList) {
                taskElement.classList.remove('newly-added');
              }
            } catch (timeoutError) {
              console.error('Error removing animation class:', timeoutError);
            }
          },400);
          
          return taskElement;
        } catch (err) {
          console.error('Error adding new task:', err);
          return null;
        }
      };
      const startClock=()=>{const a=document.getElementById("liveClock");if(!a)return;const e=()=>{a.textContent=(new Date).toLocaleTimeString("zh-CN",{hour12:!1})};e(),setInterval(e,1e3)};
      const updateCurrentDate=()=>{const dateEl=document.getElementById("currentDate");if(!dateEl)return;const now=new Date();const options={year:'numeric',month:'long',day:'numeric',weekday:'long'};dateEl.textContent=now.toLocaleDateString('zh-CN',options)};
      const initEventListeners=()=>{
        document.getElementById("prevWeek").addEventListener("click",()=>changeWeek(-1));
        document.getElementById("nextWeek").addEventListener("click",()=>changeWeek(1));
        document.getElementById("todayBtn").addEventListener("click",()=>{currentWeek=new Date;loadForWeek()});
        document.getElementById("clearBtn").addEventListener("click",clearCurrentWeek);
        
        board.addEventListener("click",a=>{
          if(a.target.matches("[data-add-to]")){
            const e=a.target.getAttribute("data-add-to");
            const t=document.getElementById("input-"+e);
            if(t.value.trim()){
              addTask(e,t.value.trim());
              t.value="";
              t.dispatchEvent(new Event("input"));
            }
          }
        });
        
          board.addEventListener("click",a=>{
          try {
            if(a.target.matches(".del-btn")){
              a.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
              const taskElement=a.target.closest(".task");
              
              // ÂÆâÂÖ®Ê£ÄÊü•
              if(!taskElement) {
                console.warn("No task element found to delete");
                return;
              }
              
              // Á°ÆËÆ§Âà†Èô§
              if(confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËØ•‰ªªÂä°ÂêóÔºü")){
                try {
                  // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
                  taskElement.style.transform="scale(0.8)";
                  taskElement.style.opacity="0";
                  taskElement.style.transition="transform 0.2s ease, opacity 0.2s ease";
                  
                  // Âª∂ËøüÂà†Èô§Âπ∂‰øùÂ≠ò
                  setTimeout(()=>{
                    try {
                      // ÂÜçÊ¨°Ê£ÄÊü•ÂÖÉÁ¥†ÊòØÂê¶‰ªçÁÑ∂Â≠òÂú®
                      if(document.body.contains(taskElement)) {
                        taskElement.remove();
                        // ÂÆâÂÖ®Âú∞Ë∞ÉÁî®‰øùÂ≠òÂáΩÊï∞
                        if(typeof saveForWeek === 'function') {
                          saveForWeek();
                        }
                        // Êõ¥Êñ∞Á©∫Áä∂ÊÄÅÊ£ÄÊü•
                        if(typeof checkEmptyStates === 'function') {
                          checkEmptyStates();
                        }
                      }
                    } catch (removeError) {
                      console.error('Error removing task element:', removeError);
                    }
                  },200);
                } catch (animationError) {
                  console.error('Error applying delete animation:', animationError);
                  // Âç≥‰ΩøÂä®ÁîªÂá∫Èîô‰πüÂ∞ùËØïÂà†Èô§‰ªªÂä°
                  if(document.body.contains(taskElement)) {
                    taskElement.remove();
                    if(typeof saveForWeek === 'function') {
                      saveForWeek();
                    }
                  }
                }
              }
            }
          } catch (deleteError) {
            console.error('Error in delete task handler:', deleteError);
          }
        });
        
        board.querySelectorAll('input[type="text"]').forEach(a=>{
          a.addEventListener("input",()=>{
            const e=a.id.replace("input-","");
            const t=document.querySelector(`button[data-add-to="${e}"]`);
            t.disabled=!a.value.trim();
          });
          a.addEventListener("keydown",e=>{
            if("Enter"===e.key){
              e.preventDefault();
              const t=document.querySelector(`button[data-add-to="${a.id.replace("input-","")}"]`);
              t.click();
            }
          });
        });
        
        const a=document.createElement("div");
        a.className="drop-indicator";
        
        board.addEventListener("dragstart",e=>{
          if(e.target.matches(".task")){
            draggedEl=e.target;
            draggedEl.classList.add("dragging");
            e.dataTransfer.effectAllowed="move";
            e.dataTransfer.setData("text/plain",draggedEl.dataset.id);
          }
        });
        
        board.addEventListener("dragend",e=>{
          if(draggedEl){
            draggedEl.classList.remove("dragging");
            draggedEl=null;
            a.remove();
            document.querySelectorAll(".col-list.drag-over").forEach(t=>t.classList.remove("drag-over"));
            saveForWeek();
            applySearchFilter();
          }
        });
        
        // üîß ‰øÆÂ§çÔºöÊãñÊãΩÊó∂Ê†πÊçÆÈº†Ê†á‰ΩçÁΩÆÁ≤æÁ°ÆÊîæÁΩÆ‰ªªÂä°
        board.addEventListener("dragover",e=>{
          e.preventDefault();
          const t=e.target.closest(".col-list");
          if(t){
            t.classList.add("drag-over");
            const o=getDragAfterElement(t,e.clientY);
            const tasks=t.querySelectorAll(".task:not(.dragging)");
            
            // Ëé∑ÂèñÂàóË°®ÂÆπÂô®ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
            const listRect=t.getBoundingClientRect();
            
            // Ê†πÊçÆÈº†Ê†á‰ΩçÁΩÆÂíåËøîÂõûÁöÑÂÖÉÁ¥†ÂÜ≥ÂÆöÊîæÁΩÆ‰ΩçÁΩÆ
            // ÁâπÂà´Â§ÑÁêÜundefinedÊÉÖÂÜµÔºöË°®Á§∫Á©∫ÂàóË°®‰∏îÈº†Ê†áÂú®‰∏äÂçäÈÉ®ÂàÜÔºåÂ∫îÊîæÂú®È°∂ÈÉ®
            if(o===undefined){
              // ÊîæÂú®È°∂ÈÉ®
              if(t.firstChild) {
                t.insertBefore(a,t.firstChild);
              } else {
                t.appendChild(a);
              }
            } else if(o==null){
              // Â¶ÇÊûúgetDragAfterElementËøîÂõûnull‰∏îÊúâ‰ªªÂä°ÔºåÊ£ÄÊü•Èº†Ê†á‰ΩçÁΩÆ
              if(tasks.length>0){
                // Ëé∑ÂèñÂàóË°®ÂÆπÂô®ÂíåÊúÄÂêé‰∏Ä‰∏™‰ªªÂä°ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
                const lastTask=tasks[tasks.length-1];
                const lastTaskRect=lastTask.getBoundingClientRect();
                const listCenter=listRect.top + listRect.height / 2;
                
                // ‰ºòÂåñÊîæÁΩÆÈÄªËæëÔºöÂè™ÊúâÂú®Èº†Ê†áÊòéÁ°ÆÂú®Â∫ïÈÉ®Âå∫ÂüüÊâçÊîæÂú®Êú´Â∞æ
                // Âê¶ÂàôÂ∞ùËØïÊîæÂú®ÂêàÈÄÇÁöÑ‰ΩçÁΩÆÔºåÈÅøÂÖçÊÄªÊòØÊîæÂú®ÂºÄÂ§¥ÊàñÊú´Â∞æ
                if(e.clientY > lastTaskRect.top + lastTaskRect.height * 0.9) {
                  // ÈùûÂ∏∏Êé•ËøëÂ∫ïÈÉ®Êó∂ÊâçÊîæÂú®Êú´Â∞æ
                  t.appendChild(a);
                } else if(e.clientY < listRect.top + listRect.height * 0.2) {
                  // Êé•ËøëÈ°∂ÈÉ®Êó∂ÊîæÂú®ÂºÄÂ§¥
                  t.insertBefore(a,tasks[0]);
                } else {
                  // ‰∏≠Èó¥Âå∫ÂüüÊó∂ÔºåÂ∞ùËØïÊâæÂà∞ÊúÄÊé•ËøëÁöÑ‰ΩçÁΩÆ
                  let closestIndex=0;
                  let minDistance=Math.abs(e.clientY - (tasks[0].getBoundingClientRect().top + tasks[0].getBoundingClientRect().height/2));
                  
                  for(let i=1;i<tasks.length;i++){
                    const taskCenter=tasks[i].getBoundingClientRect().top + tasks[i].getBoundingClientRect().height/2;
                    const distance=Math.abs(e.clientY - taskCenter);
                    if(distance<minDistance){
                      minDistance=distance;
                      closestIndex=i;
                    }
                  }
                  
                  // ÊèíÂÖ•Âà∞ÊúÄÊé•ËøëÁöÑ‰ªªÂä°‰πãÂâç
                  t.insertBefore(a,tasks[closestIndex]);
                }
              }else{
                // ÂàóË°®‰∏∫Á©∫Êó∂ÔºåÊ†πÊçÆÈº†Ê†á‰ΩçÁΩÆÂÜ≥ÂÆöÊîæÁΩÆÂú®È°∂ÈÉ®ËøòÊòØÂ∫ïÈÉ®
                // Ëé∑ÂèñÂàóË°®ÂÆπÂô®ÁöÑÂûÇÁõ¥‰∏≠ÂøÉÁÇπ
                const listMiddle=listRect.top + listRect.height / 2;
                
                // Â¶ÇÊûúÈº†Ê†áÂú®ÂàóË°®‰∏äÂçäÈÉ®ÂàÜÔºåÊîæÂú®È°∂ÈÉ®
                if(e.clientY < listMiddle) {
                  // ‰ΩøÁî®insertBeforeÊèíÂÖ•Âà∞Á¨¨‰∏Ä‰∏™Â≠êÂÖÉÁ¥†ÂâçÔºàÁ≠âÂêå‰∫éprependÔºâ
                  if(t.firstChild) {
                    t.insertBefore(a,t.firstChild);
                  } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÂ≠êÂÖÉÁ¥†ÔºåÊ≠£Â∏∏Ê∑ªÂä†
                    t.appendChild(a);
                  }
                } else {
                  // Èº†Ê†áÂú®‰∏ãÂçäÈÉ®ÂàÜÔºåÊîæÂú®Â∫ïÈÉ®
                  t.appendChild(a);
                }
              }
            }else{
              // Ê≠£Â∏∏ÊèíÂÖ•Âà∞ÊåáÂÆöÂÖÉÁ¥†‰πãÂâç
              t.insertBefore(a,o);
            }
          }
        });
        
        board.addEventListener("dragleave",e=>{
          const t=e.target.closest(".col-list");
          if(t)t.classList.remove("drag-over");
        });
        
        board.addEventListener("drop",e=>{
          e.preventDefault();
          const t=e.target.closest(".col-list");
          if(t&&draggedEl){
            if(a.parentNode){
              a.parentNode.insertBefore(draggedEl,a);
            }else{
              t.appendChild(draggedEl);
            }
          }
        });
        
        const getDragAfterElement=(e,t)=>{
          const o=[...e.querySelectorAll(".task:not(.dragging)")];
          if(o.length===0){
            // Á©∫ÂàóË°®Êó∂ÔºåÊ†πÊçÆÈº†Ê†á‰ΩçÁΩÆËøîÂõû‰∏çÂêåÂÄº
            // Ëé∑ÂèñÂàóË°®ÂÆπÂô®ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
            const listRect=e.getBoundingClientRect();
            // Ëé∑ÂèñÂàóË°®ÂÆπÂô®ÁöÑÂûÇÁõ¥‰∏≠ÂøÉÁÇπ
            const listMiddle=listRect.top + listRect.height / 2;
            
            // Â¶ÇÊûúÈº†Ê†áÂú®‰∏äÂçäÈÉ®ÂàÜÔºåËøîÂõû‰∏Ä‰∏™ÁâπÊÆäÊ†áËÆ∞ÔºàundefinedÔºâË°®Á§∫Â∫îËØ•ÊîæÂú®È°∂ÈÉ®
            // Â¶ÇÊûúÈº†Ê†áÂú®‰∏ãÂçäÈÉ®ÂàÜÔºåËøîÂõûnullË°®Á§∫ÊîæÂú®Â∫ïÈÉ®
            return t < listMiddle ? undefined : null;
          }
          
          // Ëé∑ÂèñÂàóË°®ÂÆπÂô®ÁöÑ‰ΩçÁΩÆ‰ø°ÊÅØ
          const listRect=e.getBoundingClientRect();
          
          // Â¶ÇÊûúÈº†Ê†á‰ΩçÁΩÆÂú®ÂàóË°®È°∂ÈÉ®Âå∫ÂüüÔºàÂâç15%È´òÂ∫¶ÔºâÔºåÁõ¥Êé•ËøîÂõûÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†
          if(t < listRect.top + listRect.height * 0.15) {
            return o[0];
          }
          
          // ÂáèÂ∞èÂ∫ïÈÉ®Âå∫ÂüüÂà§ÂÆöËåÉÂõ¥Ôºå‰ªé10%Êîπ‰∏∫5%ÔºåÂáèÂ∞ëÊÑèÂ§ñÊîæÁΩÆÂú®Â∫ïÈÉ®ÁöÑÊÉÖÂÜµ
          if(t > listRect.bottom - listRect.height * 0.05) {
            return null;
          }
          
          // Ê≠£Â∏∏ËÆ°ÁÆóÊîæÁΩÆ‰ΩçÁΩÆ - Êõ¥Á≤æÁ°ÆÁöÑ‰ªªÂä°Èó¥ÂÆö‰Ωç
          for(let i=0;i<o.length;i++){
            const elem=o[i];
            const box=elem.getBoundingClientRect();
            const offset=t-box.top-box.height/2;
            if(offset<0)return elem;
          }
          
          // Âè™ÊúâÂú®Èº†Ê†áÈùûÂ∏∏Êé•ËøëÂ∫ïÈÉ®Êó∂ÊâçÈªòËÆ§ÊîæÂú®Êú´Â∞æÔºåÂê¶ÂàôÂ∞ùËØïÊîæÂú®ÂÄíÊï∞Á¨¨‰∫å‰∏™‰ªªÂä°Ââç
          if(t > listRect.bottom - listRect.height * 0.2 && o.length > 1) {
            return o[o.length - 1];
          }
          
          return null;
        };
      };

      const changeWeek=a=>{currentWeek.setDate(currentWeek.getDate()+a*7),loadForWeek()},clearCurrentWeek=()=>{confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫Êú¨Âë®ÁöÑÊâÄÊúâ‰ªªÂä°ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ")&&(localStorage.removeItem(weekKey(currentWeek)),loadForWeek())};
      
      // ‚ú® ‰ºòÂåñÁöÑÂè≥ÈîÆËèúÂçï - ÂàÜÊ≠•È™§ËÆæÁΩÆ
      const showTaskContextMenu = (taskEl) => {
        try {
          // ÂèÇÊï∞È™åËØÅ
          if (!taskEl || !(taskEl instanceof HTMLElement) || !taskEl.classList.contains('task')) {
            console.error('Invalid task element provided to showTaskContextMenu:', taskEl);
            return;
          }
          
          const menuOptions = [
            'ËÆæÁΩÆ‰ºòÂÖàÁ∫ß',
            'ËÆæÁΩÆÊ†áÁ≠æ',
            'Ê∑ªÂä†Â§áÊ≥®',
            'ÂèñÊ∂à'
          ];
          
          const choice = prompt(`ËØ∑ÈÄâÊã©Êìç‰ΩúÔºö
1. ${menuOptions[0]}
2. ${menuOptions[1]}
3. ${menuOptions[2]}
4. ${menuOptions[3]}

ËØ∑ËæìÂÖ•Êï∞Â≠ó 1-4:`);
          
          if (!choice) return;
          
          // È™åËØÅËæìÂÖ•Ê†ºÂºè
          const trimmedChoice = choice.trim();
          if (!/^[1-4]$/.test(trimmedChoice)) {
            console.warn('Invalid menu choice:', trimmedChoice);
            alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊï∞Â≠ó 1-4');
            return;
          }
          
          switch(trimmedChoice) {
            case '1':
              if (typeof setPriority === 'function') setPriority(taskEl);
              break;
            case '2':
              if (typeof setTags === 'function') setTags(taskEl);
              break;
            case '3':
              if (typeof setNote === 'function') setNote(taskEl);
              break;
            default:
              return;
          }
        } catch (menuError) {
          console.error('Error in task context menu:', menuError);
          // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÂΩ±ÂìçÁî®Êà∑‰ΩìÈ™å
        }
      };
      
      const setPriority = (taskEl) => {
        try {
          // ÂèÇÊï∞È™åËØÅ
          if (!taskEl || !(taskEl instanceof HTMLElement)) {
            console.error('Invalid task element provided to setPriority:', taskEl);
            return;
          }
          
          const priority = prompt('ËÆæÁΩÆ‰ºòÂÖàÁ∫ß:\n- high (È´ò)\n- medium (‰∏≠)\n- low (‰Ωé)\n- none (Êó†)\n\nËØ∑ËæìÂÖ•:', taskEl.dataset.priority || 'none');
          
          // Â¶ÇÊûúÁî®Êà∑ÁÇπÂáªÂèñÊ∂à
          if (priority === null) return;
          
          // È™åËØÅ‰ºòÂÖàÁ∫ßÂÄº
          const trimmedPriority = priority.toLowerCase().trim();
          const validPriorities = ['high', 'medium', 'low', 'none'];
          
          if (!validPriorities.includes(trimmedPriority)) {
            console.warn('Invalid priority value:', trimmedPriority);
            alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ºòÂÖàÁ∫ßÂÄºÔºöhigh„ÄÅmedium„ÄÅlow Êàñ none');
            return;
          }
          
          try {
            // Êõ¥Êñ∞Êï∞ÊçÆÂ±ûÊÄß
            taskEl.dataset.priority = trimmedPriority;
            
            // Êõ¥Êñ∞DOMÂ±ûÊÄß
            if (trimmedPriority !== 'none') {
              taskEl.setAttribute('data-priority', trimmedPriority);
            } else {
              taskEl.removeAttribute('data-priority');
            }
            
            // Êõ¥Êñ∞UIÊòæÁ§∫
            const badge = taskEl.querySelector('.priority-badge');
            if (badge) {
              badge.remove();
            }
            
            if (trimmedPriority !== 'none') {
              const newBadge = document.createElement('span');
              newBadge.className = `priority-badge ${trimmedPriority}`;
              
              // ÂÆâÂÖ®Âú∞ÊèíÂÖ•ÂÖÉÁ¥†
              const firstChild = taskEl.firstChild;
              if (firstChild) {
                taskEl.insertBefore(newBadge, firstChild);
              } else {
                taskEl.appendChild(newBadge);
              }
            }
            
            // ‰øùÂ≠òÊõ¥Êîπ
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          } catch (domError) {
            console.error('Error updating priority DOM elements:', domError);
            // Âç≥‰ΩøDOMÊõ¥Êñ∞Â§±Ë¥•Ôºå‰πüÂ∞ùËØï‰øùÂ≠òÊï∞ÊçÆ
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          }
        } catch (error) {
          console.error('Error setting task priority:', error);
        }
      };
      
      const setTags = (taskEl) => {
        try {
          // ÂèÇÊï∞È™åËØÅ
          if (!taskEl || !(taskEl instanceof HTMLElement)) {
            console.error('Invalid task element provided to setTags:', taskEl);
            return;
          }
          
          const tags = prompt('ËÆæÁΩÆÊ†áÁ≠æ (Áî®ÈÄóÂè∑ÂàÜÈöîÂ§ö‰∏™Ê†áÁ≠æ):\n‰æã: Â∑•‰Ωú,Á¥ßÊÄ•,ÂâçÁ´Ø', taskEl.dataset.tags || '');
          
          // Â¶ÇÊûúÁî®Êà∑ÁÇπÂáªÂèñÊ∂à
          if (tags === null) return;
          
          try {
            // Êõ¥Êñ∞Êï∞ÊçÆÂ±ûÊÄß
            taskEl.dataset.tags = tags;
            
            // Êõ¥Êñ∞UIÊòæÁ§∫
            const tagDiv = taskEl.querySelector('.task-tags');
            if (tagDiv) {
              tagDiv.remove();
            }
            
            const trimmedTags = tags.trim();
            if (trimmedTags) {
              try {
                const tagList = tags.split(',').filter(t => t.trim());
                const newTagDiv = document.createElement('div');
                newTagDiv.className = 'task-tags';
                
                // ÂÆâÂÖ®Âú∞ÁîüÊàêÊ†áÁ≠æHTML
                if (typeof escapeHtml === 'function') {
                  newTagDiv.innerHTML = tagList.map(t => {
                    const trimmedTag = t.trim();
                    return `<span class="tag">${escapeHtml(trimmedTag)}</span>`;
                  }).join('');
                } else {
                  console.warn('escapeHtml function not available, using basic tag creation');
                  // Â§áÈÄâÊñπÊ°àÔºöÈÄê‰∏™ÂàõÂª∫ÂÖÉÁ¥†
                  tagList.forEach(t => {
                    const trimmedTag = t.trim();
                    if (trimmedTag) {
                      const tagSpan = document.createElement('span');
                      tagSpan.className = 'tag';
                      tagSpan.textContent = trimmedTag;
                      newTagDiv.appendChild(tagSpan);
                    }
                  });
                }
                
                // ÂÆâÂÖ®Âú∞ÊèíÂÖ•Ê†áÁ≠æÂÆπÂô®
                const contentElement = taskEl.querySelector('.content');
                if (contentElement && contentElement.parentNode === taskEl) {
                  contentElement.after(newTagDiv);
                } else {
                  console.warn('Content element not found or not a direct child, appending tags to end');
                  taskEl.appendChild(newTagDiv);
                }
              } catch (tagProcessingError) {
                console.error('Error processing tags:', tagProcessingError);
              }
            }
            
            // ‰øùÂ≠òÊõ¥Êîπ
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          } catch (domError) {
            console.error('Error updating tags DOM elements:', domError);
            // Âç≥‰ΩøDOMÊõ¥Êñ∞Â§±Ë¥•Ôºå‰πüÂ∞ùËØï‰øùÂ≠òÊï∞ÊçÆ
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          }
        } catch (error) {
          console.error('Error setting task tags:', error);
        }
      };
      
      const setNote = (taskEl) => {
        try {
          // ÂèÇÊï∞È™åËØÅ
          if (!taskEl || !(taskEl instanceof HTMLElement)) {
            console.error('Invalid task element provided to setNote:', taskEl);
            return;
          }
          
          const note = prompt('Ê∑ªÂä†Â§áÊ≥®Ôºö', taskEl.dataset.note || '');
          
          // Â¶ÇÊûúÁî®Êà∑ÁÇπÂáªÂèñÊ∂à
          if (note === null) return;
          
          try {
            // Êõ¥Êñ∞Êï∞ÊçÆÂ±ûÊÄß
            taskEl.dataset.note = note;
            
            // Êõ¥Êñ∞UIÊòæÁ§∫
            const noteDiv = taskEl.querySelector('.task-note');
            if (noteDiv) {
              noteDiv.remove();
            }
            
            const trimmedNote = note.trim();
            if (trimmedNote) {
              const newNoteDiv = document.createElement('div');
              newNoteDiv.className = 'task-note';
              
              // ÂÆâÂÖ®Âú∞ËÆæÁΩÆÂÜÖÂÆπÔºåÈÅøÂÖçXSS
              newNoteDiv.textContent = `üìù ${trimmedNote}`;
              
              // Á°ÆÂÆöÊèíÂÖ•‰ΩçÁΩÆ
              const tagElement = taskEl.querySelector('.task-tags');
              const contentElement = taskEl.querySelector('.content');
              
              if (tagElement && tagElement.parentNode === taskEl) {
                tagElement.after(newNoteDiv);
              } else if (contentElement && contentElement.parentNode === taskEl) {
                contentElement.after(newNoteDiv);
              } else {
                console.warn('Cannot find appropriate position for note, appending to end');
                taskEl.appendChild(newNoteDiv);
              }
            }
            
            // ‰øùÂ≠òÊõ¥Êîπ
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          } catch (domError) {
            console.error('Error updating note DOM elements:', domError);
            // Âç≥‰ΩøDOMÊõ¥Êñ∞Â§±Ë¥•Ôºå‰πüÂ∞ùËØï‰øùÂ≠òÊï∞ÊçÆ
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          }
        } catch (error) {
          console.error('Error setting task note:', error);
        }
      };
      
      // ‚ú® === Êñ∞Â¢ûÂäüËÉΩÔºöËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÈÄªËæë ===
      const settingsModal = document.getElementById('settingsModal');
      const openSettingsBtn = document.getElementById('settingsBtn');
      const closeSettingsBtn = document.getElementById('closeSettingsBtn');

      openSettingsBtn.addEventListener('click', () => settingsModal.classList.add('visible'));
      closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('visible'));
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) { settingsModal.classList.remove('visible'); }
      });
      
      // ‚ú® Ê∑±Ëâ≤Ê®°ÂºèÂàáÊç¢
      const themeToggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggle.checked = true;
      }
      themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
        }
      });
      
      // ‚ú® Êó∂Èó¥Êà≥ÊòæÁ§∫ÂàáÊç¢
      document.getElementById('showTimestampToggle')?.addEventListener('change', (e) => {
        const show = e.target.checked;
        document.querySelectorAll('.task .timestamp').forEach(timestamp => {
          timestamp.style.display = show ? 'inline' : 'none';
        });
        localStorage.setItem('showTimestamp', show ? 'true' : 'false');
      });
      
      // ÂàùÂßãÂåñÊó∂Èó¥Êà≥ÊòæÁ§∫ËÆæÁΩÆ
      const savedShowTimestamp = localStorage.getItem('showTimestamp');
      if (savedShowTimestamp === 'false') {
        document.getElementById('showTimestampToggle').checked = false;
      }

      // ‚ú® ÊêúÁ¥¢ÂäüËÉΩ (‰ºòÂåñÁâà)
      const searchInput = document.getElementById('searchInput');
      const applySearchFilter = () => {
        const query = searchInput.value.toLowerCase();
        document.querySelectorAll('.task').forEach(task => {
          if (!query) {
            task.style.display = ''; // Ê∏ÖÁ©∫ÊêúÁ¥¢Êó∂ÊòæÁ§∫ÊâÄÊúâ
            return;
          }
          const text = task.querySelector('.content').textContent.toLowerCase();
          const tags = task.dataset.tags?.toLowerCase() || '';
          const note = task.dataset.note?.toLowerCase() || '';
          if (text.includes(query) || tags.includes(query) || note.includes(query)) {
            task.style.display = '';
          } else {
            task.style.display = 'none';
          }
        });
      };
      
      searchInput.addEventListener('input', applySearchFilter);

      // ‚ú® ÁªüËÆ°ÂäüËÉΩ
      const updateTaskCounts = () => {
        columns.forEach(col => {
          const count = document.querySelectorAll(`#${col}List .task`).length;
          const countEl = document.getElementById(`count-${col}`);
          if (countEl) countEl.textContent = count;
        });
      };

      const updateStats = () => {
        const counts = {};
        let total = 0;
        columns.forEach(col => {
          const count = document.querySelectorAll(`#${col}List .task`).length;
          counts[col] = count;
          total += count;
        });
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statPlanning').textContent = counts.planning || 0;
        document.getElementById('statTodo').textContent = counts.todo || 0;
        document.getElementById('statDoing').textContent = counts.doing || 0;
        document.getElementById('statDone').textContent = counts.done || 0;
        const progress = total > 0 ? Math.round((counts.done / total) * 100) : 0;
        document.getElementById('statProgress').textContent = progress + '%';
        document.getElementById('progressFill').style.width = progress + '%';
        
        // Êõ¥Êñ∞Áî®Êà∑Âç°ÁâáÁªüËÆ°
        document.getElementById('userWeekTotal').textContent = total;
        document.getElementById('userWeekDone').textContent = counts.done || 0;
      };

      const statsBtn = document.getElementById('statsBtn');
      const statsPanel = document.getElementById('statsPanel');
      // ÂàùÂßãÂåñÁªüËÆ°Èù¢Êùø‰∏∫ÈöêËóèÁä∂ÊÄÅ
      statsBtn.addEventListener('click', () => {
        if (statsPanel.style.display === 'none') {
          statsPanel.style.display = 'grid';
          statsBtn.textContent = 'üìà ÈöêËóèÁªüËÆ°';
          updateStats();
        } else {
          statsPanel.style.display = 'none';
          statsBtn.textContent = 'üìà ÁªüËÆ°';
        }
      });
      
      // ‚ú® === Êñ∞Â¢ûÂäüËÉΩÔºöÊï∞ÊçÆÂØºÂá∫ÈÄªËæë ===
      const getCurrentWeekData = () => {
          const key = weekKey(currentWeek);
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : {planning:[], todo:[], doing:[], done:[]};
      };

      const downloadFile = (filename, content, mimeType) => {
          const blob = new Blob([content], { type: mimeType });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
      };

      // ÂØºÂá∫‰∏∫ JSON
      document.getElementById('exportJsonBtn').addEventListener('click', () => {
          const data = getCurrentWeekData();
          const jsonString = JSON.stringify(data, null, 2);
          const weekStartDate = startOfWeek(currentWeek).toISOString().slice(0, 10);
          downloadFile(`kanban-backup-${weekStartDate}.json`, jsonString, 'application/json');
      });

      // ÂØºÂá∫‰∏∫ CSV
      document.getElementById('exportCsvBtn').addEventListener('click', () => {
          const data = getCurrentWeekData();
          const statusMap = { planning: 'ËßÑÂàí', todo: 'ÂæÖÂÅö', doing: 'Ê≠£Âú®ÂÅö', done: 'ÂÆåÊàê' };
          let csvContent = '\uFEFF'; // BOM for Excel to recognize UTF-8
          csvContent += 'ID,ÂÜÖÂÆπ,Áä∂ÊÄÅ,ÂàõÂª∫Êó•Êúü,‰ºòÂÖàÁ∫ß,Ê†áÁ≠æ,Â§áÊ≥®\n';

          columns.forEach(col => {
              (data[col] || []).forEach(task => {
                  const id = task.id;
                  const text = `"${task.text.replace(/"/g, '""')}"`; // Handle quotes in text
                  const status = statusMap[col];
                  const created = new Date(task.created).toLocaleString('zh-CN');
                  const priority = task.priority || 'none';
                  const tags = task.tags || '';
                  const note = `"${(task.note || '').replace(/"/g, '""')}"`;
                  csvContent += [id, text, status, created, priority, tags, note].join(',') + '\n';
              });
          });
          
          const weekStartDate = startOfWeek(currentWeek).toISOString().slice(0, 10);
          downloadFile(`kanban-export-${weekStartDate}.csv`, csvContent, 'text/csv;charset=utf-8;');
      });

      // ‚ú® ÂØºÂá∫ÊàêÂ∞±Âç°Áâá‰∏∫JPGÂõæÁâáÔºà‰ºòÂåñÁâàÔºâ
      document.getElementById('exportImageBtn').addEventListener('click', () => {
        const data = getCurrentWeekData();
        const counts = {};
        let total = 0;
        columns.forEach(col => {
          counts[col] = (data[col] || []).length;
          total += counts[col];
        });
        const progress = total > 0 ? Math.round((counts.done / total) * 100) : 0;
        const userId = localStorage.getItem('userProfile_id') || 'ÊàëÁöÑ‰ªªÂä°ÁúãÊùø';
        const userMotto = localStorage.getItem('userProfile_motto') || '‰ªäÊó•‰∫ã, ‰ªäÊó•ÊØï üöÄ';
        
        // ÂàõÂª∫È´òÊ∏Ö Canvas
        const canvas = document.createElement('canvas');
        canvas.width = 1080;  // ÊèêÈ´òÂàÜËæ®Áéá
        canvas.height = 1350; // 16:9 ÊØî‰æã‰ºòÂåñ
        const ctx = canvas.getContext('2d');
        
        // ÂêØÁî®È´òË¥®ÈáèÊ∏≤Êüì
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        // Ê∏êÂèòËÉåÊôØÔºàÊõ¥‰∏∞ÂØåÁöÑÈ¢úËâ≤Ôºâ
        const gradient = ctx.createLinearGradient(0, 0, 1080, 1350);
        gradient.addColorStop(0, '#667eea');
        gradient.addColorStop(0.5, '#764ba2');
        gradient.addColorStop(1, '#f093fb');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 1080, 1350);
        
        // Ë£ÖÈ•∞ÂúÜÂΩ¢ÔºàÂ¢ûÂä†ËÆæËÆ°ÊÑüÔºâ
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.beginPath();
        ctx.arc(150, 150, 200, 0, 2 * Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(930, 1200, 250, 0, 2 * Math.PI);
        ctx.fill();
        
        // ÁôΩËâ≤Âç°ÁâáËÉåÊôØÔºàÂúÜËßí‰ºòÂåñÔºâ
        ctx.fillStyle = 'white';
        ctx.shadowColor = 'rgba(0,0,0,0.15)';
        ctx.shadowBlur = 40;
        ctx.shadowOffsetY = 15;
        // ÁªòÂà∂ÂúÜËßíÁü©ÂΩ¢
        const cardX = 60, cardY = 100, cardW = 960, cardH = 1150, cardRadius = 30;
        ctx.beginPath();
        ctx.moveTo(cardX + cardRadius, cardY);
        ctx.lineTo(cardX + cardW - cardRadius, cardY);
        ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + cardRadius);
        ctx.lineTo(cardX + cardW, cardY + cardH - cardRadius);
        ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - cardRadius, cardY + cardH);
        ctx.lineTo(cardX + cardRadius, cardY + cardH);
        ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - cardRadius);
        ctx.lineTo(cardX, cardY + cardRadius);
        ctx.quadraticCurveTo(cardX, cardY, cardX + cardRadius, cardY);
        ctx.closePath();
        ctx.fill();
        ctx.shadowColor = 'transparent';
        
        // È°∂ÈÉ®Ë£ÖÈ•∞Êù°
        const topBarGradient = ctx.createLinearGradient(60, 100, 1020, 100);
        topBarGradient.addColorStop(0, '#667eea');
        topBarGradient.addColorStop(1, '#764ba2');
        ctx.fillStyle = topBarGradient;
        ctx.beginPath();
        ctx.moveTo(cardX + cardRadius, cardY);
        ctx.lineTo(cardX + cardW - cardRadius, cardY);
        ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + cardRadius);
        ctx.lineTo(cardX + cardW, cardY + 120);
        ctx.lineTo(cardX, cardY + 120);
        ctx.lineTo(cardX, cardY + cardRadius);
        ctx.quadraticCurveTo(cardX, cardY, cardX + cardRadius, cardY);
        ctx.closePath();
        ctx.fill();
        
        // Ê†áÈ¢òÔºàÁôΩËâ≤Âú®Á¥´Ëâ≤Êù°‰∏äÔºâ
        ctx.fillStyle = 'white';
        ctx.font = 'bold 56px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('üéÜ Êú¨Âë®ÊàêÂ∞±Êä•Âëä', 540, 185);
        
        // Áî®Êà∑‰ø°ÊÅØÂå∫Âüü
        ctx.fillStyle = '#333';
        ctx.font = 'bold 38px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`üë§ ${userId}`, 120, 300);
        
        ctx.fillStyle = '#666';
        ctx.font = 'italic 24px "Microsoft Yahei", sans-serif';
        ctx.fillText(`"${userMotto}"`, 120, 350);
        
        // Êó•ÊúüÂíåÂë®Êï∞
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-CN', {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'});
        const weekNum = getWeekNumber(now);
        ctx.fillStyle = '#999';
        ctx.font = '20px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(dateStr, 960, 300);
        ctx.fillText(`Á¨¨ ${weekNum} Âë®`, 960, 330);
        
        // ÂàÜÈöîÁ∫ø
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(120, 380);
        ctx.lineTo(960, 380);
        ctx.stroke();
        
        // ÊÄª‰ªªÂä°Êï∞Âå∫ÂüüÔºàÂ∏¶ËÉåÊôØÔºâ
        const statY = 520;
        ctx.fillStyle = 'rgba(102, 126, 234, 0.08)';
        ctx.fillRect(120, 420, 840, 140);
        
        ctx.fillStyle = '#667eea';
        ctx.font = 'bold 90px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(total.toString(), 540, statY);
        
        ctx.fillStyle = '#666';
        ctx.font = '28px "Microsoft Yahei", sans-serif';
        ctx.fillText('Êú¨Âë®ÂàõÂª∫‰ªªÂä°Êï∞', 540, statY + 50);
        
        // ÂÆåÊàêÂ∫¶ÂúÜÁéØÔºàÊõ¥Á≤æÁæéÔºâ
        const centerX = 540;
        const centerY = 750;
        const circleRadius = 120;
        
        // ËÉåÊôØÂúÜ
        ctx.beginPath();
        ctx.arc(centerX, centerY, circleRadius, 0, 2 * Math.PI);
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 24;
        ctx.stroke();
        
        // ËøõÂ∫¶ÂúÜÔºàÊ∏êÂèòËâ≤Ôºâ
        ctx.beginPath();
        const progressAngle = (progress / 100) * 2 * Math.PI;
        ctx.arc(centerX, centerY, circleRadius, -0.5 * Math.PI, -0.5 * Math.PI + progressAngle);
        const progressGradient = ctx.createLinearGradient(centerX - circleRadius, centerY, centerX + circleRadius, centerY);
        progressGradient.addColorStop(0, '#20c997');
        progressGradient.addColorStop(0.5, '#38d9a9');
        progressGradient.addColorStop(1, '#51cf66');
        ctx.strokeStyle = progressGradient;
        ctx.lineWidth = 24;
        ctx.lineCap = 'round';
        ctx.stroke();
        
        // ÂÆåÊàêÂ∫¶ÊñáÂ≠ó
        ctx.fillStyle = '#667eea';
        ctx.font = 'bold 64px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(`${progress}%`, centerX, centerY + 18);
        
        ctx.fillStyle = '#666';
        ctx.font = '24px "Microsoft Yahei", sans-serif';
        ctx.fillText('ÂÆåÊàêÂ∫¶', centerX, centerY + 55);
        
        // ËØ¶ÁªÜÁªüËÆ°ÔºàÂ∏¶ËÉåÊôØÂç°ÁâáÔºâ
        const detailY = 960;
        const statItems = [
          { label: 'üí° ËßÑÂàí', value: counts.planning, color: '#339af0', bg: 'rgba(51, 154, 240, 0.1)' },
          { label: 'üìù ÂæÖÂÅö', value: counts.todo, color: '#845ef7', bg: 'rgba(132, 94, 247, 0.1)' },
          { label: '‚è≥ ËøõË°å‰∏≠', value: counts.doing, color: '#fd7e14', bg: 'rgba(253, 126, 20, 0.1)' },
          { label: '‚úÖ ÂÆåÊàê', value: counts.done, color: '#20c997', bg: 'rgba(32, 201, 151, 0.1)' }
        ];
        
        statItems.forEach((item, index) => {
          const x = 180 + index * 210;
          // ËÉåÊôØÂç°Áâá
          ctx.fillStyle = item.bg;
          ctx.fillRect(x - 75, detailY - 60, 150, 120);
          ctx.strokeStyle = item.color;
          ctx.lineWidth = 2;
          ctx.strokeRect(x - 75, detailY - 60, 150, 120);
          
          // Êï∞Â≠ó
          ctx.fillStyle = item.color;
          ctx.font = 'bold 42px "Microsoft Yahei", sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(item.value.toString(), x, detailY);
          
          // Ê†áÁ≠æ
          ctx.fillStyle = '#666';
          ctx.font = '20px "Microsoft Yahei", sans-serif';
          ctx.fillText(item.label, x, detailY + 40);
        });
        
        // Â∫ïÈÉ®ÈºìÂä±ËØ≠ÔºàÂ∏¶ËÉåÊôØÔºâ
        let encouragement = '';
        let encourageColor = '#667eea';
        if (progress >= 80) {
          encouragement = 'üéâ Ê£íÊûÅ‰∫ÜÔºÅ‰Ω†ÊòØÊâßË°åÂäõÂ§ßÂ∏àÔºÅ';
          encourageColor = '#20c997';
        } else if (progress >= 50) {
          encouragement = 'üí™ Âä†Ê≤πÔºÅ‰Ω†Â∑≤ÁªèÂÆåÊàê‰∏ÄÂçä‰∫ÜÔºÅ';
          encourageColor = '#fd7e14';
        } else if (total > 0) {
          encouragement = 'üåü ÁªßÁª≠Âä™ÂäõÔºåÊØè‰∏ÄÊ≠•ÈÉΩÊòØËøõÊ≠•ÔºÅ';
          encourageColor = '#845ef7';
        } else {
          encouragement = 'üöÄ ÂºÄÂßã‰Ω†ÁöÑÈ´òÊïà‰∏ÄÂë®ÂêßÔºÅ';
        }
        
        ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
        ctx.fillRect(120, 1120, 840, 70);
        
        ctx.fillStyle = encourageColor;
        ctx.font = 'bold 30px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(encouragement, 540, 1165);
        
        // Ê∞¥Âç∞ÔºàÊõ¥Á≤æËá¥Ôºâ
        ctx.fillStyle = '#bbb';
        ctx.font = '18px "Microsoft Yahei", sans-serif';
        ctx.fillText('üìä Âë®‰ªªÂä°ÁúãÊùø - ËÆ©ÊØè‰∏ÄÂë®ÈÉΩÊõ¥È´òÊïà', 540, 1230);
        
        // ËΩ¨Êç¢‰∏∫JPGÂπ∂‰∏ãËΩΩÔºàÊèêÈ´òË¥®ÈáèÔºâ
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const weekStartDate = startOfWeek(currentWeek).toISOString().slice(0, 10);
          const fileName = `ÊàëÁöÑÊàêÂ∞±-${userId}-${weekStartDate}.jpg`;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert('‚ú® ÊàêÂ∞±Âç°ÁâáÂ∑≤ÁîüÊàêÔºÅ\nÊñá‰ª∂Âêç: ' + fileName + '\nÂø´ÂéªÂàÜ‰∫´‰Ω†ÁöÑËøõÊ≠•ÂêßÔºÅ');
        }, 'image/jpeg', 0.98); // ÊèêÈ´òË¥®ÈáèÂà∞98%
      });

      // ‚ú® ÂØºÂÖ•JSON - Â¢ûÂº∫Áâà
      document.getElementById('importJsonInput')?.addEventListener('change', (e) => {
          try {
              // È™åËØÅ‰∫ã‰ª∂ÂØπË±°
              if (!e || !e.target) {
                  console.error('Invalid event object');
                  return;
              }
              
              const file = e.target.files[0];
              if (!file) {
                  console.warn('No file selected');
                  return;
              }
              
              // È™åËØÅÊñá‰ª∂Á±ªÂûã
              if (file.type && file.type !== 'application/json' && !file.name.endsWith('.json')) {
                  alert('‚ùå ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑJSONÊñá‰ª∂');
                  e.target.value = '';
                  return;
              }
              
              // È™åËØÅÊñá‰ª∂Â§ßÂ∞èÔºàÈôêÂà∂‰∏∫5MBÔºâ
              const maxSize = 5 * 1024 * 1024; // 5MB
              if (file.size > maxSize) {
                  alert('‚ùå Êñá‰ª∂ËøáÂ§ßÔºåËØ∑ÈÄâÊã©Â∞è‰∫é5MBÁöÑJSONÊñá‰ª∂');
                  e.target.value = '';
                  return;
              }
              
              const reader = new FileReader();
              
              // Ê∑ªÂä†ÈîôËØØÂ§ÑÁêÜ
              reader.onerror = () => {
                  console.error('Error reading file');
                  alert('‚ùå ËØªÂèñÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                  e.target.value = '';
              };
              
              reader.onload = (event) => {
                  try {
                      // È™åËØÅ‰∫ã‰ª∂ÁõÆÊ†áÂíåÁªìÊûú
                      if (!event || !event.target || !event.target.result) {
                          throw new Error('Êó†Ê≥ïËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ');
                      }
                      
                      const result = event.target.result;
                      if (typeof result !== 'string' || result.trim() === '') {
                          throw new Error('Êñá‰ª∂ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊó†Êïà');
                      }
                      
                      let data;
                      try {
                          data = JSON.parse(result);
                      } catch (parseError) {
                          throw new Error(`JSONÊ†ºÂºèÈîôËØØ: ${parseError.message}`);
                      }
                      
                      // ‰∏•Ê†ºÈ™åËØÅÊï∞ÊçÆÁªìÊûÑ
                      if (!data || typeof data !== 'object' || Array.isArray(data)) {
                          throw new Error('Êï∞ÊçÆÂøÖÈ°ªÊòØÂØπË±°Ê†ºÂºè');
                      }
                      
                      // ËØ¶ÁªÜÈ™åËØÅÊØè‰∏ÄÂàóÁöÑ‰ªªÂä°Êï∞ÊçÆ
                      let validTasksFound = false;
                      for (const col of columns) {
                          const columnData = data[col];
                          // ÂÖÅËÆ∏Âàó‰∏çÂ≠òÂú®Êàñ‰∏∫Á©∫Êï∞ÁªÑ
                          if (columnData !== undefined && !Array.isArray(columnData)) {
                              throw new Error(`Âàó ${col} ÁöÑÊï∞ÊçÆÂøÖÈ°ªÊòØÊï∞ÁªÑÊ†ºÂºè`);
                          }
                          
                          // È™åËØÅÊØè‰∏™‰ªªÂä°ÁöÑÁªìÊûÑ
                          if (Array.isArray(columnData)) {
                              for (let i = 0; i < columnData.length; i++) {
                                  const task = columnData[i];
                                  if (!task || typeof task !== 'object') {
                                      throw new Error(`Âàó ${col} ‰∏≠ÁöÑ‰ªªÂä° #${i+1} Ê†ºÂºèÊó†Êïà`);
                                  }
                                  // Ëá≥Â∞ëÈúÄË¶ÅidÂíåtextÂ≠óÊÆµ
                                  if (!task.id || typeof task.text !== 'string' || task.text.trim() === '') {
                                      throw new Error(`Âàó ${col} ‰∏≠ÁöÑ‰ªªÂä° #${i+1} Áº∫Â∞ëÂøÖË¶ÅÁöÑidÊàñtextÂ≠óÊÆµ`);
                                  }
                                  validTasksFound = true;
                              }
                          }
                      }
                      
                      // ËÆ°ÁÆó‰ªªÂä°ÊÄªÊï∞
                      const tasksCount = Object.values(data)
                        .filter(tasks => Array.isArray(tasks))
                        .reduce((sum, tasks) => sum + tasks.length, 0);
                      
                      if (tasksCount === 0 && !validTasksFound) {
                          alert('‚ö†Ô∏è JSONÊñá‰ª∂‰∏≠Ê≤°ÊúâÊúâÊïàÁöÑ‰ªªÂä°Êï∞ÊçÆÔºå‰ªçË¶ÅÂØºÂÖ•ÂêóÔºü');
                      }
                      
                      // ÊòæÁ§∫ÂØºÂÖ•Á°ÆËÆ§ÔºåÂåÖÂê´‰ªªÂä°Êï∞Èáè‰ø°ÊÅØ
                      if (confirm(`Á°ÆÂÆöË¶ÅÂØºÂÖ• ${tasksCount} ‰∏™‰ªªÂä°ÂêóÔºü\nËøôÂ∞ÜË¶ÜÁõñÂΩìÂâçÂë®ÁöÑÊâÄÊúâ‰ªªÂä°„ÄÇ`)) {
                          try {
                              // ÂàõÂª∫ÂÆâÂÖ®ÁöÑÂâØÊú¨ÔºåÁ°Æ‰øùÊâÄÊúâÂàóÈÉΩÂ≠òÂú®‰∏î‰∏∫Êï∞ÁªÑ
                              const safeData = {};
                              columns.forEach(col => {
                                  safeData[col] = Array.isArray(data[col]) ? data[col] : [];
                              });
                              
                              // Ê£ÄÊü•localStorageÁ©∫Èó¥
                              try {
                                  const testKey = 'import_test_key';
                                  const jsonString = JSON.stringify(safeData);
                                  localStorage.setItem(testKey, jsonString);
                                  localStorage.removeItem(testKey);
                              } catch(storageErr) {
                                  throw new Error('Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåÊó†Ê≥ïÂØºÂÖ•Êï∞ÊçÆ');
                              }
                              
                              // ‰øùÂ≠òÂà∞localStorage
                              localStorage.setItem(weekKey(currentWeek), JSON.stringify(safeData));
                              
                              // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                              if (typeof loadForWeek === 'function') {
                                  loadForWeek();
                              }
                              
                              // Ê∏ÖÁ©∫ÊâÄÊúâËæìÂÖ•Ê°ÜÂπ∂ÈáçÁΩÆÊåâÈíÆÁä∂ÊÄÅ
                              columns.forEach(col => {
                                  const input = document.getElementById(`input-${col}`);
                                  if (input) {
                                      try {
                                          input.value = '';
                                          input.dispatchEvent(new Event('input', { bubbles: true }));
                                      } catch (inputErr) {
                                          console.warn('Error resetting input:', inputErr);
                                      }
                                  }
                              });
                              
                              alert(`‚úÖ ÂØºÂÖ•ÊàêÂäüÔºÅÂÖ±ÂØºÂÖ• ${tasksCount} ‰∏™‰ªªÂä°„ÄÇ`);
                          } catch (saveError) {
                              console.error('Save error:', saveError);
                              throw new Error(`‰øùÂ≠òÊï∞ÊçÆÂ§±Ë¥•: ${saveError.message}`);
                          }
                      }
                  } catch (error) {
                      console.error('Import processing error:', error);
                      alert('‚ùå ÂØºÂÖ•Â§±Ë¥•Ôºö' + error.message);
                  } finally {
                      // ÈáçÁΩÆËæìÂÖ•Ê°Ü
                      try {
                          e.target.value = '';
                      } catch (resetErr) {
                          console.warn('Error resetting file input:', resetErr);
                      }
                  }
              };
              
              // ÂêØÂä®Êñá‰ª∂ËØªÂèñ
              try {
                  reader.readAsText(file, 'UTF-8');
              } catch (readError) {
                  console.error('Error initiating file read:', readError);
                  alert('‚ùå ËØªÂèñÊñá‰ª∂Â§±Ë¥•Ôºö' + readError.message);
                  e.target.value = '';
              }
          } catch (handlerError) {
              console.error('File input handler error:', handlerError);
              alert('‚ùå Â§ÑÁêÜÊñá‰ª∂Êó∂Âá∫ÈîôÔºö' + handlerError.message);
              if (e && e.target) {
                  e.target.value = '';
              }
          }
      });
      
      // ‚ú® ÈáçÁΩÆÁî®Êà∑‰ø°ÊÅØ
      document.getElementById('resetProfileBtn')?.addEventListener('click', () => {
        if (confirm('Á°ÆÂÆöË¶ÅÈáçÁΩÆ‰∏™‰∫∫‰ø°ÊÅØÂêóÔºü')) {
          localStorage.removeItem('userProfile_id');
          localStorage.removeItem('userProfile_motto');
          localStorage.removeItem('userProfile_avatar');
          loadUserProfile();
          alert('‚úÖ ‰∏™‰∫∫‰ø°ÊÅØÂ∑≤ÈáçÁΩÆÔºÅ');
        }
      });
      
      // ‚ú® Ê∏ÖÈô§Â§¥ÂÉè
      document.getElementById('clearAvatarBtn')?.addEventListener('click', () => {
        if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§Â§¥ÂÉèÂêóÔºü')) {
          localStorage.removeItem('userProfile_avatar');
          document.getElementById('avatarImg').style.display = 'none';
          document.getElementById('avatarInitial').style.display = 'block';
          const userId = localStorage.getItem('userProfile_id') || 'ÊàëÁöÑ‰ªªÂä°ÁúãÊùø';
          document.getElementById('avatarInitial').textContent = userId.charAt(0).toUpperCase();
          alert('‚úÖ Â§¥ÂÉèÂ∑≤Ê∏ÖÈô§ÔºÅ');
        }
      });


      // === ÂàùÂßãÂåñ ===
      (function(){const a=weekKey(new Date);if(!localStorage.getItem(a)){const e={planning:[{id:"seed1",text:"ÂÜô‰∏Ä‰ªΩÂë®ËÆ°Âàí",created:(new Date).toISOString()}],todo:[{id:"seed2",text:"Â≠¶‰π†Êñ∞ÁöÑCSSÊäÄÂ∑ß",created:(new Date).toISOString()}],doing:[],done:[]};localStorage.setItem(a,JSON.stringify(e))}})();
      
      // ‚ú® === Áî®Êà∑‰∏™‰∫∫‰ø°ÊÅØÁÆ°ÁêÜ ===
      const loadUserProfile = () => {
        const userId = localStorage.getItem('userProfile_id') || 'ÊàëÁöÑ‰ªªÂä°ÁúãÊùø';
        const userMotto = localStorage.getItem('userProfile_motto') || '‰ªäÊó•‰∫ã, ‰ªäÊó•ÊØï üöÄ';
        const userAvatar = localStorage.getItem('userProfile_avatar');
        
        document.getElementById('userIdDisplay').textContent = userId;
        document.getElementById('userMotto').textContent = userMotto;
        
        // Âä†ËΩΩÂ§¥ÂÉè
        if (userAvatar) {
          document.getElementById('avatarImg').src = userAvatar;
          document.getElementById('avatarImg').style.display = 'block';
          document.getElementById('avatarInitial').style.display = 'none';
        } else {
          // ÊòæÁ§∫È¶ñÂ≠óÊØç
          const initial = userId.charAt(0).toUpperCase();
          document.getElementById('avatarInitial').textContent = initial;
        }
      };
      
      // ÁºñËæëÁî®Êà∑ID - Â¢ûÂº∫Áâà
      document.getElementById('editUserId')?.addEventListener('click', () => {
        try {
          const userIdDisplay = document.getElementById('userIdDisplay');
          if (!userIdDisplay) {
            console.error('userIdDisplay element not found');
            alert('‚ùå È°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
            return;
          }
          
          const currentId = userIdDisplay.textContent;
          const newId = prompt('ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÁî®Êà∑ID:', currentId);
          
          // Áî®Êà∑ÁÇπÂáªÂèñÊ∂à
          if (newId === null) return;
          
          // È™åËØÅËæìÂÖ•
          if (!newId || newId.trim().length === 0) {
            alert('‚ùå Áî®Êà∑ID‰∏çËÉΩ‰∏∫Á©∫');
            return;
          }
          
          const trimmedId = newId.trim();
          
          // ÈïøÂ∫¶ÈôêÂà∂
          if (trimmedId.length > 50) {
            alert('‚ùå Áî®Êà∑ID‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶');
            return;
          }
          
          try {
            // Êõ¥Êñ∞ÊòæÁ§∫ÂíåÂ≠òÂÇ®
            userIdDisplay.textContent = trimmedId;
            localStorage.setItem('userProfile_id', trimmedId);
            
            // Êõ¥Êñ∞Â§¥ÂÉèÈ¶ñÂ≠óÊØç
            const avatarInitial = document.getElementById('avatarInitial');
            if (avatarInitial && !localStorage.getItem('userProfile_avatar')) {
              avatarInitial.textContent = trimmedId.charAt(0).toUpperCase();
            }
            
            console.log('User ID updated successfully');
          } catch (storageError) {
            console.error('Error saving user ID:', storageError);
            alert('‚ùå ‰øùÂ≠òÁî®Êà∑IDÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
            // ÂõûÊªöÊòæÁ§∫
            userIdDisplay.textContent = currentId;
          }
        } catch (error) {
          console.error('Error in editUserId handler:', error);
          alert('‚ùå Â§ÑÁêÜÁî®Êà∑IDÁºñËæëÊó∂Âá∫Èîô');
        }
      });
      
      // ÁºñËæëÊ†ºË®Ä - Â¢ûÂº∫Áâà
      document.getElementById('userMotto')?.addEventListener('click', () => {
        try {
          const userMottoElement = document.getElementById('userMotto');
          if (!userMottoElement) {
            console.error('userMotto element not found');
            alert('‚ùå È°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
            return;
          }
          
          const currentMotto = userMottoElement.textContent;
          const newMotto = prompt('ËØ∑ËæìÂÖ•ÊÇ®ÁöÑ‰∏™‰∫∫Ê†ºË®Ä:', currentMotto);
          
          // Áî®Êà∑ÁÇπÂáªÂèñÊ∂à
          if (newMotto === null) return;
          
          const trimmedMotto = newMotto.trim();
          
          // ÈïøÂ∫¶ÈôêÂà∂
          if (trimmedMotto.length > 200) {
            alert('‚ùå ‰∏™‰∫∫Ê†ºË®Ä‰∏çËÉΩË∂ÖËøá200‰∏™Â≠óÁ¨¶');
            return;
          }
          
          try {
            // Êõ¥Êñ∞ÊòæÁ§∫ÂíåÂ≠òÂÇ®
            userMottoElement.textContent = trimmedMotto || '‰ªäÊó•‰∫ã, ‰ªäÊó•ÊØï üöÄ';
            localStorage.setItem('userProfile_motto', trimmedMotto || '‰ªäÊó•‰∫ã, ‰ªäÊó•ÊØï üöÄ');
            
            console.log('User motto updated successfully');
          } catch (storageError) {
            console.error('Error saving user motto:', storageError);
            alert('‚ùå ‰øùÂ≠ò‰∏™‰∫∫Ê†ºË®ÄÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
            // ÂõûÊªöÊòæÁ§∫
            userMottoElement.textContent = currentMotto;
          }
        } catch (error) {
          console.error('Error in userMotto click handler:', error);
          alert('‚ùå Â§ÑÁêÜ‰∏™‰∫∫Ê†ºË®ÄÁºñËæëÊó∂Âá∫Èîô');
        }
      });
      
      // ‰∏ä‰º†Â§¥ÂÉè
      document.getElementById('avatarUploadBtn').addEventListener('click', () => {
        document.getElementById('avatarInput').click();
      });
      
      document.getElementById('userAvatar').addEventListener('click', () => {
        document.getElementById('avatarInput').click();
      });
      
      document.getElementById('avatarInput')?.addEventListener('change', (e) => {
        try {
          // È™åËØÅ‰∫ã‰ª∂ÂØπË±°
          if (!e || !e.target) {
            console.error('Invalid event object');
            return;
          }
          
          const file = e.target.files[0];
          if (!file) {
            console.warn('No file selected');
            return;
          }
          
          // È™åËØÅÊñá‰ª∂Á±ªÂûã
          const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
          const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
          
          const isTypeValid = file.type && validTypes.includes(file.type);
          const fileName = file.name.toLowerCase();
          const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
          
          if (!isTypeValid && !hasValidExtension) {
            alert('‚ùå ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂\nÊîØÊåÅÁöÑÊ†ºÂºè: JPG, PNG, GIF, WebP');
            e.target.value = '';
            return;
          }
          
          // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è (ÈôêÂà∂ 1.5MB ËÄÉËôëBase64ÁºñÁ†ÅÂ¢ûÂ§ß)
          const maxSize = 1.5 * 1024 * 1024; // 1.5MB
          if (file.size > maxSize) {
            alert('‚ùå ÂõæÁâáÂ§ßÂ∞è‰∏çËÉΩË∂ÖËøá1.5MB\n(Base64ÁºñÁ†ÅÂêéÁ∫¶‰∏∫2MB)');
            e.target.value = '';
            return;
          }
          
          const reader = new FileReader();
          
          // Ê∑ªÂä†ÈîôËØØÂ§ÑÁêÜ
          reader.onerror = () => {
            console.error('Error reading image file');
            alert('‚ùå ËØªÂèñÂõæÁâáÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            e.target.value = '';
          };
          
          reader.onload = (event) => {
            try {
              // È™åËØÅ‰∫ã‰ª∂ÁõÆÊ†áÂíåÁªìÊûú
              if (!event || !event.target || !event.target.result) {
                throw new Error('Êó†Ê≥ïËØªÂèñÂõæÁâáÂÜÖÂÆπ');
              }
              
              const avatarData = event.target.result;
              
              // È™åËØÅBase64Â≠óÁ¨¶‰∏≤Ê†ºÂºè
              if (typeof avatarData !== 'string' || !avatarData.startsWith('data:image/')) {
                throw new Error('Êó†ÊïàÁöÑÂõæÁâáÊï∞ÊçÆÊ†ºÂºè');
              }
              
              // Ê£ÄÊü•localStorageÊòØÂê¶Â∑≤Êª°
              const testKey = 'userProfile_avatar_test';
              try {
                localStorage.setItem(testKey, avatarData);
                localStorage.removeItem(testKey);
              } catch(storageErr) {
                console.error('Storage error:', storageErr);
                alert('‚ùå Â≠òÂÇ®Á©∫Èó¥‰∏çË∂≥ÔºåËØ∑ÈÄâÊã©Êõ¥Â∞èÁöÑÂõæÁâá');
                return;
              }
              
              // È™åËØÅÂõæÁâáÂÖÉÁ¥†Â≠òÂú®
              const avatarImg = document.getElementById('avatarImg');
              const avatarInitial = document.getElementById('avatarInitial');
              
              if (!avatarImg || !avatarInitial) {
                throw new Error('È°µÈù¢ÂÖÉÁ¥†Êú™ÊâæÂà∞ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
              }
              
              // ÂàõÂª∫ÂõæÁâáÂØπË±°ËøõË°å‰∫åÊ¨°È™åËØÅ
              const img = new Image();
              img.onload = () => {
                try {
                  // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÂõæÁâáÂ∞∫ÂØ∏È™åËØÅ
                  if (img.width < 50 || img.height < 50) {
                    alert('‚ö†Ô∏è ÂõæÁâáÂ∞∫ÂØ∏ËøáÂ∞èÔºåÂèØËÉΩÊòæÁ§∫ÊïàÊûú‰∏ç‰Ω≥');
                  }
                  
                  // Êõ¥Êñ∞UIÂíå‰øùÂ≠òÊï∞ÊçÆ
                  avatarImg.src = avatarData;
                  avatarImg.style.display = 'block';
                  avatarInitial.style.display = 'none';
                  
                  try {
                    localStorage.setItem('userProfile_avatar', avatarData);
                    alert('‚úÖ Â§¥ÂÉè‰∏ä‰º†ÊàêÂäüÔºÅ');
                  } catch (saveErr) {
                    console.error('Error saving avatar to localStorage:', saveErr);
                    alert('‚ùå ‰øùÂ≠òÂ§¥ÂÉèÂ§±Ë¥•ÔºöÂ≠òÂÇ®Á©∫Èó¥‰∏çË∂≥');
                    // ÂõûÊªöUIÂèòÂåñ
                    avatarImg.style.display = 'none';
                    const userId = localStorage.getItem('userProfile_id') || 'ÊàëÁöÑ‰ªªÂä°ÁúãÊùø';
                    avatarInitial.textContent = userId.charAt(0).toUpperCase();
                    avatarInitial.style.display = 'block';
                  }
                } catch (imgProcessError) {
                  console.error('Image processing error:', imgProcessError);
                  alert('‚ùå Â§ÑÁêÜÂõæÁâáÊó∂Âá∫ÈîôÔºö' + imgProcessError.message);
                }
              };
              
              img.onerror = () => {
                console.error('Invalid image data');
                alert('‚ùå Êó†ÊïàÁöÑÂõæÁâáÊñá‰ª∂ÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÂõæÁâá');
              };
              
              // Âä†ËΩΩÂõæÁâáËøõË°åÈ™åËØÅ
              img.src = avatarData;
            } catch (error) {
              console.error('Avatar upload processing error:', error);
              alert('‚ùå Â§¥ÂÉè‰∏ä‰º†Â§±Ë¥•Ôºö' + error.message);
            } finally {
              // ÈáçÁΩÆËæìÂÖ•Ê°Ü
              try {
                e.target.value = '';
              } catch (resetErr) {
                console.warn('Error resetting file input:', resetErr);
              }
            }
          };
          
          // ÂêØÂä®Êñá‰ª∂ËØªÂèñ
          try {
            reader.readAsDataURL(file);
          } catch (readError) {
            console.error('Error initiating file read:', readError);
            alert('‚ùå ËØªÂèñÂõæÁâáÂ§±Ë¥•Ôºö' + readError.message);
            e.target.value = '';
          }
        } catch (handlerError) {
          console.error('File input handler error:', handlerError);
          alert('‚ùå Â§ÑÁêÜÂõæÁâáÊó∂Âá∫ÈîôÔºö' + handlerError.message);
          if (e && e.target) {
            e.target.value = '';
          }
        }
      });
      
      loadUserProfile();
      initEventListeners();
      loadForWeek();
      startClock();
      updateCurrentDate();
      
      // Á©∫Áä∂ÊÄÅÊ£ÄÊü• - ‰ºòÂåñÁâà
      const checkEmptyStates=()=>{
        columns.forEach(col=>{
          const list=document.getElementById(col+'List');
          if(!list) return;
          
          const tasks=list.querySelectorAll('.task');
          const emptyStateElem=list.querySelector('.empty-state');
          const isEmpty=tasks.length===0;
          
          if(isEmpty){
            // Âàó‰∏∫Á©∫Êó∂ÔºåÁ°Æ‰øùÊòæÁ§∫Á©∫Áä∂ÊÄÅ
            if(!emptyStateElem){
              // ÂÖà‰øùÂ≠òÊâÄÊúâÈùû‰ªªÂä°ÂÖÉÁ¥†ÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
              const nonTaskElements=[];
              Array.from(list.children).forEach(child=>{
                if(!child.classList.contains('task')){
                  nonTaskElements.push(child);
                }
              });
              
              // Ê∏ÖÁ©∫ÂàóË°®
              list.innerHTML='';
              
              // Ê∑ªÂä†Á©∫Áä∂ÊÄÅÂÖÉÁ¥†
              const emptyState=document.createElement('div');
              emptyState.className='empty-state';
              emptyState.innerHTML='<div class="empty-state-icon">‚ú®</div><div class="empty-state-text">ËøòÊ≤°Êúâ‰ªªÂä°ÔºåÁÇπÂáª‰∏ãÊñπÊ∑ªÂä†ÂêßÔºÅ</div>';
              list.appendChild(emptyState);
              
              // ÈáçÊñ∞Ê∑ªÂä†Èùû‰ªªÂä°ÂÖÉÁ¥†
              nonTaskElements.forEach(el=>list.appendChild(el));
            }
          }else{
            // Âàó‰∏ç‰∏∫Á©∫Êó∂ÔºåÁßªÈô§Á©∫Áä∂ÊÄÅÂÖÉÁ¥†
            if(emptyStateElem){
              emptyStateElem.remove();
            }
          }
        });
      };
      
      // Âø´Êç∑ÈîÆÊîØÊåÅ
      const showKeyboardHint=()=>{const hint=document.getElementById('keyboardHint');hint.classList.add('show');setTimeout(()=>hint.classList.remove('show'),2000)};
      document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='k'){e.preventDefault();document.getElementById('searchInput').focus();showKeyboardHint();}if(e.ctrlKey&&e.key==='s'){e.preventDefault();document.getElementById('statsBtn').click();showKeyboardHint();}});
      
      // ÊØèÂ§©ÂáåÊô®Êõ¥Êñ∞Êó•Êúü
      setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
          updateCurrentDate();
        }
      }, 60000);
    });
  </script>
</body>
</html>