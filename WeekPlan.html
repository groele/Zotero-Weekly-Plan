<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‘¨ä»»åŠ¡é¢æ¿ â€” é«˜çº§ç‰ˆ</title>
  <style>
    :root{
      --bg: #f8f9fa; --card-bg: #ffffff; --accent: #007bff; --text-main: #343a40; 
      --text-muted: #6c757d; --border-color: rgba(0,0,0,0.1); --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      --col-plan: #339af0; --col-todo: #845ef7; --col-doing: #fd7e14; --col-done: #20c997;
      --col-plan-light: rgba(51, 154, 240, 0.08); --col-todo-light: rgba(132, 94, 247, 0.08);
      --col-doing-light: rgba(253, 126, 20, 0.08); --col-done-light: rgba(32, 201, 151, 0.08);
      --danger-text: #e03131; --danger-bg-hover: rgba(224, 49, 49, 0.1);
      --col-gap:18px; --radius:12px; --panel-padding:18px;
      --priority-high: #fa5252; --priority-medium: #ffd43b; --priority-low: #51cf66;
    }
    [data-theme="dark"] {
      --bg: #1a1a1a; --card-bg: #2d2d2d; --accent: #4dabf7; --text-main: #e9ecef; 
      --text-muted: #adb5bd; --border-color: rgba(255,255,255,0.1); --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      --col-plan-light: rgba(51, 154, 240, 0.15); --col-todo-light: rgba(132, 94, 247, 0.15);
      --col-doing-light: rgba(253, 126, 20, 0.15); --col-done-light: rgba(32, 201, 151, 0.15);
      --danger-text: #ff6b6b; --danger-bg-hover: rgba(255, 107, 107, 0.1);
    }
    *{box-sizing:border-box;font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", "Microsoft Yahei", sans-serif;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text-main); scroll-behavior: smooth;}
    
    /* é¡µé¢åŠ è½½åŠ¨ç”» */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .app{max-width:1200px;margin:28px auto;padding:18px; animation: fadeInUp 0.6s ease-out;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px; flex-wrap: wrap; gap: 12px;}
    header h1{font-size:28px;margin:0; color: var(--text-main); font-weight: 700; letter-spacing: -0.5px;}
    .header-info { display: flex; align-items: center; gap: 16px; }
    .week-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    #currentDate { font-size: 15px; color: var(--accent); font-weight: 600; margin-right: 12px; padding: 6px 12px; background: rgba(0, 123, 255, 0.08); border-radius: 6px; }
    #liveClock { font-size: 17px; color: var(--text-main); font-weight: 600; font-variant-numeric: tabular-nums; }
    .btn{background:var(--card-bg);border:1px solid var(--border-color);padding:9px 14px;border-radius:8px;cursor:pointer;color: var(--text-main);transition: all 0.2s ease; font-weight: 500;}
    .btn:hover{background: var(--accent); color: white; border-color: var(--accent); box-shadow: 0 2px 8px rgba(0, 123, 255, 0.25); transform: translateY(-1px);}
    .btn:active{transform:translateY(0px)}
    .btn:disabled {cursor: not-allowed; opacity: 0.5; background: #f1f3f5; transform: none;}
    .btn.danger { color: var(--danger-text); border-color: var(--danger-text); }
    .btn.danger:hover { background: var(--danger-text); color: white; box-shadow: 0 2px 8px rgba(224, 49, 49, 0.25); }
    .board{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--col-gap)}
    .column{background: var(--card-bg);padding:var(--panel-padding);border-radius:var(--radius);min-height:320px;border-top: 4px solid;transition: all 0.3s ease; position: relative; overflow: hidden;}
    .column::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; opacity: 0.05; pointer-events: none; transition: opacity 0.3s; }
    .column:hover::before { opacity: 0.08; }
    [data-theme="dark"] .column { background: #262626; }
    .column[data-column="planning"] { border-color: var(--col-plan); }
    .column[data-column="planning"]::before { background: linear-gradient(135deg, var(--col-plan) 0%, #4dabf7 100%); }
    .column[data-column="todo"] { border-color: var(--col-todo); }
    .column[data-column="todo"]::before { background: linear-gradient(135deg, var(--col-todo) 0%, #9775fa 100%); }
    .column[data-column="doing"] { border-color: var(--col-doing); }
    .column[data-column="doing"]::before { background: linear-gradient(135deg, var(--col-doing) 0%, #ff922b 100%); }
    .column[data-column="done"] { border-color: var(--col-done); }
    .column[data-column="done"]::before { background: linear-gradient(135deg, var(--col-done) 0%, #51cf66 100%); }
    .col-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .col-title{font-weight:700; font-size: 1.15em; letter-spacing: -0.3px;}
    .task-count { background: var(--accent); color: white; padding: 3px 9px; border-radius: 12px; font-size: 12px; margin-left: 8px; font-weight: 600; min-width: 24px; text-align: center; box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3); }
    .col-list{min-height:200px;display:flex;flex-direction:column;gap:10px}
    .task{background: var(--card-bg);padding:14px;border-radius:10px;border:1px solid var(--border-color);cursor:grab; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative;}
    .task:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12); border-color: var(--accent); }
    /* ä»»åŠ¡å¡ç‰‡æŒ‰æ ç›®ç€è‰² */
    .column[data-column="planning"] .task { border-left: 3px solid var(--col-plan); background: linear-gradient(to right, var(--col-plan-light), var(--card-bg)); }
    .column[data-column="todo"] .task { border-left: 3px solid var(--col-todo); background: linear-gradient(to right, var(--col-todo-light), var(--card-bg)); }
    .column[data-column="doing"] .task { border-left: 3px solid var(--col-doing); background: linear-gradient(to right, var(--col-doing-light), var(--card-bg)); }
    .column[data-column="done"] .task { border-left: 3px solid var(--col-done); background: linear-gradient(to right, var(--col-done-light), var(--card-bg)); }
    /* ä»»åŠ¡æ·»åŠ åŠ¨ç”» */
    @keyframes taskSlideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .task.newly-added { animation: taskSlideIn 0.4s ease-out; }
    .task[data-priority="high"] { border-left: 4px solid var(--priority-high); }
    .task[data-priority="medium"] { border-left: 4px solid var(--priority-medium); }
    .task[data-priority="low"] { border-left: 4px solid var(--priority-low); }
    .task-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
    .tag { background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .priority-badge { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; border-radius: 50%; }
    .priority-badge.high { background: var(--priority-high); }
    .priority-badge.medium { background: var(--priority-medium); }
    .priority-badge.low { background: var(--priority-low); }
    .task-note { font-size: 12px; color: var(--text-muted); margin-top: 6px; font-style: italic; border-top: 1px dashed var(--border-color); padding-top: 6px; }
    .task.dragging{opacity:0.9;transform:scale(0.98);background: var(--accent); color: white;}
    .task.dragging .meta, .task.dragging .del-btn { color: white; opacity: 0.8; }
    .task .content:focus { outline:2px solid var(--accent); }
    .meta{display:flex;justify-content:space-between;align-items: center;margin-top:8px;font-size:12px;color:var(--text-muted)}
    .del-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px 5px; border-radius: 4px; font-size: 14px; }
    .del-btn:hover { background-color: var(--danger-bg-hover); color: var(--danger-text); }
    .drop-indicator { height: 50px; background-color: rgba(0, 123, 255, 0.1); border: 2px dashed var(--accent); border-radius: 8px; margin: 5px 0; }
    .small{font-size:13px;color:var(--text-muted)}
    #weekNumberLabel { font-weight: 500; color: var(--accent); margin-left: 4px; }
    .add-row{display:flex;gap:6px;margin-top:12px}
    .add-row button { transition: all 0.2s ease; }
    .add-row button:not(:disabled):hover { transform: scale(1.05); }
    input[type='text']{flex:1;padding:10px 14px;border-radius:8px;border:2px solid var(--border-color);background:var(--card-bg);color:inherit; transition: all 0.2s ease; font-size: 14px;}
    input[type='text']:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(0,123,255,0.12); transform: translateY(-1px); }
    footer{margin-top:24px;color:var(--text-muted);font-size:13px; text-align: center; padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);}
    footer::before { content: 'ğŸ’¡ '; }
    footer .shortcut-hint { display: inline-block; margin-left: 12px; padding: 4px 8px; background: var(--bg); border-radius: 4px; font-size: 11px; }
    
    /* âœ¨ æ–°å¢ï¼šè®¾ç½®æ¨¡æ€æ¡†æ ·å¼ */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1000; }
    .modal.visible { opacity: 1; pointer-events: auto; }
    .modal-content { background: var(--card-bg); padding: 24px; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s; }
    .modal.visible .modal-content { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px;}
    .modal-header h2 { margin: 0; font-size: 18px; }
    .close-btn { font-size: 24px; cursor: pointer; color: var(--text-muted); background: none; border: none; }
    .settings-section { margin-bottom: 20px; }
    .settings-section h3 { margin: 0 0 12px; font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    .settings-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .search-bar { display: flex; align-items: center; }
    .search-bar input { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-bg); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .stat-card { background: var(--card-bg); padding: 16px; border-radius: 10px; text-align: center; border: 2px solid var(--border-color); transition: all 0.2s ease; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15); border-color: var(--accent); }
    .stat-number { font-size: 28px; font-weight: 800; color: var(--accent); letter-spacing: -1px; }
    .stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    .toolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; flex-wrap: wrap; }
    .toggle-switch { position: relative; display: inline-block; width: 48px; height: 24px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .3s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(24px); }
    .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
    .file-input-wrapper input[type=file] { position: absolute; left: -9999px; }
    /* ç©ºçŠ¶æ€æç¤º */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-text { font-size: 14px; line-height: 1.6; }
    
    /* è¿›åº¦æ¡ä¼˜åŒ– */
    .progress-bar { width: 100%; height: 10px; background: var(--border-color); border-radius: 5px; overflow: hidden; margin-top: 8px; position: relative; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent) 0%, #4dabf7 100%); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
    .progress-fill::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 2s infinite; }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* ç”¨æˆ·å¡ç‰‡æ ·å¼ */
    .user-card { background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%), var(--card-bg); border-radius: var(--radius); padding: 24px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); margin-bottom: 28px; display: flex; align-items: center; gap: 20px; border: 2px solid rgba(102, 126, 234, 0.15); transition: all 0.3s ease; }
    .user-card:hover { transform: translateY(-3px); box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2); border-color: rgba(102, 126, 234, 0.3); }
    .user-avatar-wrapper { position: relative; }
    .user-avatar { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 4px solid var(--accent); cursor: pointer; transition: all 0.3s ease; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px; font-weight: 700; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .user-avatar:hover { transform: scale(1.08) rotate(5deg); border-color: var(--col-doing); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
    .avatar-upload-btn { position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; border: 2px solid var(--card-bg); border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    .avatar-upload-btn:hover { background: var(--col-doing); }
    .user-info { flex: 1; }
    .user-id { font-size: 22px; font-weight: 700; color: var(--text-main); margin: 0 0 8px 0; display: flex; align-items: center; gap: 10px; }
    .user-id-edit { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; padding: 2px 6px; border-radius: 4px; transition: background 0.2s; }
    .user-id-edit:hover { background: var(--border-color); }
    .user-motto { font-size: 15px; color: var(--text-muted); font-style: italic; margin: 0 0 10px 0; line-height: 1.6; cursor: pointer; transition: all 0.2s; }
    .user-motto:hover { color: var(--accent); transform: translateX(2px); }
    .user-motto::before { content: '"'; }
    .user-motto::after { content: '"'; }
    .user-stats-mini { display: flex; gap: 12px; margin-top: 8px; }
    .user-stat-item { font-size: 13px; color: var(--text-muted); font-weight: 500; }
    .user-stat-item strong { color: var(--accent); font-weight: 700; font-size: 15px; }
    
    /* å¿«æ·é”®æç¤º */
    .keyboard-hint { position: fixed; bottom: 20px; right: 20px; background: var(--card-bg); padding: 12px 16px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 12px; color: var(--text-muted); border: 1px solid var(--border-color); opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; }
    .keyboard-hint.show { opacity: 1; }
    .keyboard-hint kbd { background: var(--bg); padding: 2px 6px; border-radius: 4px; border: 1px solid var(--border-color); font-family: monospace; margin: 0 2px; }
    
    @media (max-width:900px){.board{grid-template-columns:repeat(2,1fr)}.stats-grid{grid-template-columns:repeat(2,1fr)}.keyboard-hint{display:none;}}
    @media (max-width:600px){.board{grid-template-columns:1fr}.app{padding:12px}.header-info{width:100%;justify-content:space-between}.stats-grid{grid-template-columns:repeat(2,1fr)}.user-card{flex-direction:column;text-align:center}.user-avatar{width:70px;height:70px}}
  </style>
</head>
<body>
  <div class="app">
    <!-- ç”¨æˆ·ä¸ªäººä¿¡æ¯å¡ç‰‡ -->
    <div class="user-card">
      <div class="user-avatar-wrapper">
        <div class="user-avatar" id="userAvatar">
          <span id="avatarInitial">U</span>
          <img id="avatarImg" style="display:none; width:100%; height:100%; border-radius:50%; object-fit:cover;" />
        </div>
        <div class="avatar-upload-btn" id="avatarUploadBtn" title="ä¸Šä¼ å¤´åƒ">ğŸ“·</div>
        <input type="file" id="avatarInput" accept="image/*" style="display:none;" />
      </div>
      <div class="user-info">
        <h2 class="user-id">
          <span id="userIdDisplay">æˆ‘çš„ä»»åŠ¡çœ‹æ¿</span>
          <button class="user-id-edit" id="editUserId" title="ç¼–è¾‘ç”¨æˆ·ID">âœï¸</button>
        </h2>
        <p class="user-motto" id="userMotto" title="ç‚¹å‡»ç¼–è¾‘æ ¼è¨€">ä»Šæ—¥äº‹, ä»Šæ—¥æ¯• ğŸš€</p>
        <div class="user-stats-mini">
          <span class="user-stat-item">ğŸ¯ æœ¬å‘¨ä»»åŠ¡: <strong id="userWeekTotal">0</strong></span>
          <span class="user-stat-item">âœ… å·²å®Œæˆ: <strong id="userWeekDone">0</strong></span>
        </div>
      </div>
    </div>

    <header>
      <h1>ğŸ“Š å‘¨ä»»åŠ¡çœ‹æ¿</h1>
      <div class="header-info">
        <div class="week-controls">
          <div id="currentDate" style="font-size: 13px; color: var(--text-muted); margin-right: 12px;"></div>
          <button class="btn" id="prevWeek" title="ä¸Šä¸€å‘¨">â—€</button>
          <div class="small" id="weekLabel">â€”â€”</div>
          <div class="small" id="weekNumberLabel"></div>
          <button class="btn" id="nextWeek" title="ä¸‹ä¸€å‘¨">â–¶</button>
          <button class="btn" id="todayBtn">æœ¬å‘¨</button>
          <button class="btn danger" id="clearBtn" title="æ¸…ç©ºæœ¬å‘¨æ‰€æœ‰ä»»åŠ¡">æ¸…ç©º</button>
        </div>
        <div id="liveClock"></div>
        <label class="toggle-switch" title="åˆ‡æ¢æ·±è‰²æ¨¡å¼">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
        <button class="btn" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
      </div>
    </header>

    <!-- æœç´¢å’Œå·¥å…·æ  -->
    <div class="toolbar">
      <div class="search-bar" style="flex: 1;">
        <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ä»»åŠ¡..." />
      </div>
      <button class="btn" id="statsBtn" title="æŸ¥çœ‹ç»Ÿè®¡">ğŸ“ˆ ç»Ÿè®¡</button>
    </div>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div id="statsPanel" class="stats-grid" style="display: none;">
      <div class="stat-card">
        <div class="stat-number" id="statTotal">0</div>
        <div class="stat-label">æ€»ä»»åŠ¡</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statPlanning">0</div>
        <div class="stat-label">è§„åˆ’ä¸­</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statTodo">0</div>
        <div class="stat-label">å¾…åš</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statDoing">0</div>
        <div class="stat-label">è¿›è¡Œä¸­</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statDone">0</div>
        <div class="stat-label">å·²å®Œæˆ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statProgress">0%</div>
        <div class="stat-label">å®Œæˆç‡</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
    </div>

    <main class="board" id="board">
      <section class="column" data-column="planning">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">è§„åˆ’</div>
            <span class="task-count" id="count-planning">0</span>
          </div>
          <div class="small">Ideas</div>
        </div>
        <div class="col-list" id="planningList"></div>
        <div class="add-row">
          <input type="text" placeholder="æ·»åŠ åˆ°è§„åˆ’..." id="input-planning" />
          <button class="btn" data-add-to="planning" disabled>æ·»åŠ </button>
        </div>
      </section>
      <section class="column" data-column="todo">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">å¾…åš</div>
            <span class="task-count" id="count-todo">0</span>
          </div>
          <div class="small">To Do</div>
        </div>
        <div class="col-list" id="todoList"></div>
        <div class="add-row">
          <input type="text" placeholder="æ·»åŠ åˆ°å¾…åš..." id="input-todo" />
          <button class="btn" data-add-to="todo" disabled>æ·»åŠ </button>
        </div>
      </section>
      <section class="column" data-column="doing">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">æ­£åœ¨åš</div>
            <span class="task-count" id="count-doing">0</span>
          </div>
          <div class="small">In Progress</div>
        </div>
        <div class="col-list" id="doingList"></div>
        <div class="add-row">
          <input type="text" placeholder="æ·»åŠ åˆ°æ­£åœ¨åš..." id="input-doing" />
          <button class="btn" data-add-to="doing" disabled>æ·»åŠ </button>
        </div>
      </section>
      <section class="column" data-column="done">
        <div class="col-header">
          <div style="display:flex;align-items:center;">
            <div class="col-title">å®Œæˆ</div>
            <span class="task-count" id="count-done">0</span>
          </div>
          <div class="small">Done</div>
        </div>
        <div class="col-list" id="doneList"></div>
        <div class="add-row">
          <input type="text" placeholder="æ·»åŠ åˆ°å®Œæˆ..." id="input-done" />
          <button class="btn" data-add-to="done" disabled>æ·»åŠ </button>
        </div>
      </section>
    </main>

    <footer>
      ğŸ“ åŒå‡»ç¼–è¾‘ | ğŸ–±ï¸ æ‹–æ‹½ç§»åŠ¨ | ğŸ’¾ è‡ªåŠ¨ä¿å­˜ | ğŸ“… æ¯å‘¨ç‹¬ç«‹å­˜å‚¨
      <span class="shortcut-hint">å¿«æ·é”®: <kbd>Ctrl</kbd>+<kbd>K</kbd> æœç´¢ | <kbd>Ctrl</kbd>+<kbd>S</kbd> ç»Ÿè®¡</span>
    </footer>
  </div>

  <!-- å¿«æ·é”®æç¤º -->
  <div class="keyboard-hint" id="keyboardHint">
    âŒ¨ï¸ å¿«æ·é”®å·²å¯ç”¨
  </div>

  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âš™ï¸ è®¾ç½®</h2>
        <button class="close-btn" id="closeSettingsBtn">&times;</button>
      </div>
      <div class="settings-body">
        <div class="settings-section">
          <h3>ğŸ“Š æ•°æ®ç®¡ç†</h3>
          <p class="small">å¯¼å‡ºå½“å‰å‘¨çš„æ•°æ®ä¸ºæ–‡ä»¶,ç”¨äºå¤‡ä»½æˆ–åœ¨å…¶ä»–åº”ç”¨ä¸­ä½¿ç”¨ã€‚</p>
          <div class="settings-actions">
            <button class="btn" id="exportJsonBtn">ğŸ’¾ å¯¼å‡ºJSON</button>
            <button class="btn" id="exportCsvBtn">ğŸ“„ å¯¼å‡ºCSV</button>
            <button class="btn" id="exportImageBtn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">ğŸ† ç”Ÿæˆæˆå°±å¡ç‰‡</button>
            <div class="file-input-wrapper">
              <button class="btn">ğŸ“‚ å¯¼å…¥JSON</button>
              <input type="file" id="importJsonInput" accept=".json" />
            </div>
          </div>
        </div>
        <div class="settings-section">
          <h3>ğŸ¨ ä¸ªæ€§åŒ–</h3>
          <p class="small">è‡ªå®šä¹‰æ‚¨çš„ä»»åŠ¡çœ‹æ¿å¤–è§‚å’Œè¡Œä¸ºã€‚</p>
          <div class="settings-actions">
            <label>
              <input type="checkbox" id="autoSaveToggle" checked /> è‡ªåŠ¨ä¿å­˜
            </label>
            <label>
              <input type="checkbox" id="showTimestampToggle" checked /> æ˜¾ç¤ºæ—¶é—´æˆ³
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h3>ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯</h3>
          <p class="small">ç®¡ç†æ‚¨çš„ä¸ªäººèµ„æ–™å’Œä¸ªæ€§åŒ–è®¾ç½®ã€‚</p>
          <div class="settings-actions">
            <button class="btn" id="resetProfileBtn">ğŸ”„ é‡ç½®ä¸ªäººä¿¡æ¯</button>
            <button class="btn danger" id="clearAvatarBtn">ğŸ—‘ï¸ æ¸…é™¤å¤´åƒ</button>
          </div>
        </div>
        </div>
    </div>
  </div>


  <script>
    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯ä¸ŠæŠ¥é€»è¾‘
    });
    
    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled Promise rejection:', event.reason);
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é”™è¯¯ä¸ŠæŠ¥é€»è¾‘
    });
    
    document.addEventListener('DOMContentLoaded',()=>{
      // --- å¢å¼ºçš„å·¥å…·å‡½æ•°ï¼Œæ·»åŠ å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç† ---
      const startOfWeek=(d)=>{
        try {
          // å‚æ•°éªŒè¯
          const date = d instanceof Date ? d : new Date(d);
          // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
          if (isNaN(date.getTime())) {
            console.warn('Invalid date provided to startOfWeek, using current date');
            return startOfWeek(new Date());
          }
          const a = new Date(date); // åˆ›å»ºå‰¯æœ¬é¿å…ä¿®æ”¹åŸå§‹æ—¥æœŸ
          const e = (a.getDay() + 6) % 7;
          a.setDate(a.getDate() - e);
          a.setHours(0, 0, 0, 0);
          return a;
        } catch (err) {
          console.error('Error in startOfWeek:', err);
          return new Date(); // è¿”å›å½“å‰æ—¥æœŸä½œä¸ºåå¤‡
        }
      };
      
      const weekKey=(a)=>{
        try {
          const startDate = startOfWeek(a);
          return `kanban:${startDate.toISOString().slice(0,10)}`;
        } catch (err) {
          console.error('Error in weekKey:', err);
          return `kanban:${startOfWeek(new Date()).toISOString().slice(0,10)}`;
        }
      };
      
      const fmtRange=(a)=>{
        try {
          const e = startOfWeek(a);
          const t = new Date(e);
          t.setDate(t.getDate() + 6);
          return `${e.getMonth() + 1}/${e.getDate()} ~ ${t.getMonth() + 1}/${t.getDate()}`;
        } catch (err) {
          console.error('Error in fmtRange:', err);
          return 'æ—¥æœŸèŒƒå›´é”™è¯¯';
        }
      };
      
      const escapeHtml=(a)=>{
        try {
          // ç¡®ä¿è¾“å…¥æ˜¯å­—ç¬¦ä¸²
          const str = a === null || a === undefined ? '' : String(a);
          return str.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;"); // é¢å¤–è½¬ä¹‰å•å¼•å·
        } catch (err) {
          console.error('Error in escapeHtml:', err);
          return '';
        }
      };
      
      const getWeekNumber=(d)=>{
        try {
          // å‚æ•°éªŒè¯
          const date = d instanceof Date ? d : new Date(d);
          if (isNaN(date.getTime())) {
            console.warn('Invalid date provided to getWeekNumber, using current date');
            return getWeekNumber(new Date());
          }
          
          const adjustedDate = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
          adjustedDate.setUTCDate(adjustedDate.getUTCDate() + 4 - (adjustedDate.getUTCDay() || 7));
          const yearStart = new Date(Date.UTC(adjustedDate.getUTCFullYear(), 0, 1));
          return Math.ceil(((adjustedDate - yearStart) / 864e5 + 1) / 7);
        } catch (err) {
          console.error('Error in getWeekNumber:', err);
          return 0;
        }
      };
      let currentWeek=new Date,draggedEl=null;const columns=["planning","todo","doing","done"],board=document.getElementById("board");
      const loadForWeek=()=>{
          try {
            const key=weekKey(currentWeek);
            let data = null;
            
            // å®‰å…¨åœ°ä»localStorageè·å–æ•°æ®
            try {
              const storedData=localStorage.getItem(key);
              if (storedData) {
                data=JSON.parse(storedData);
                // éªŒè¯æ•°æ®ç»“æ„
                if (!data || typeof data !== 'object') {
                  console.warn('Invalid data structure in localStorage, using empty board');
                  data={planning:[],todo:[],doing:[],done:[]};
                }
              } else {
                data={planning:[],todo:[],doing:[],done:[]};
              }
            } catch (parseError) {
              console.error('Error parsing data from localStorage:', parseError);
              data={planning:[],todo:[],doing:[],done:[]};
            }
            
            columns.forEach(col=>{
              const listElement=document.getElementById(col+"List");
              if (!listElement) {
                console.warn(`List element for column ${col} not found`);
                return;
              }
              
              listElement.innerHTML="";
              const tasksForColumn=(data[col]||[]).filter(Boolean); // è¿‡æ»¤æ‰nullå’Œundefined
              
              if(tasksForColumn.length===0){
                listElement.innerHTML='<div class="empty-state"><div class="empty-state-icon">âœ¨</div><div class="empty-state-text">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ å§ï¼</div></div>';
              }else{
                // æŒ‰ç…§å­˜å‚¨é¡ºåºæ·»åŠ ä»»åŠ¡ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
                tasksForColumn.forEach(taskData=>{
                  try {
                    const taskElement=renderTask(taskData);
                    if (taskElement && taskElement.nodeType === 1) { // ç¡®ä¿æ˜¯æœ‰æ•ˆçš„DOMå…ƒç´ 
                      listElement.appendChild(taskElement);
                    }
                  } catch (taskError) {
                    console.error(`Error rendering task in column ${col}:`, taskError);
                  }
                });
              }
            });
            
            // æ›´æ–°UIå…ƒç´ ï¼Œæ·»åŠ ç©ºå€¼æ£€æŸ¥
            const weekLabelEl=document.getElementById("weekLabel");
            if (weekLabelEl) weekLabelEl.textContent=fmtRange(currentWeek);
            
            const weekNumberLabelEl=document.getElementById("weekNumberLabel");
            if (weekNumberLabelEl) weekNumberLabelEl.textContent=`(ç¬¬ ${getWeekNumber(currentWeek)} å‘¨)`;
            
            // ç¡®ä¿è¿™äº›å‡½æ•°å­˜åœ¨å†è°ƒç”¨
            if (typeof updateTaskCounts === 'function') updateTaskCounts();
            if (typeof updateStats === 'function') updateStats();
            if (typeof checkEmptyStates === 'function') checkEmptyStates();
          } catch (err) {
            console.error('Error loading week data:', err);
            // å³ä½¿å‡ºé”™ä¹Ÿå°è¯•æ¢å¤åŸºæœ¬åŠŸèƒ½
            if (typeof updateTaskCounts === 'function') updateTaskCounts();
          }
        };
      const saveForWeek=()=>{
          try {
            const key=weekKey(currentWeek);
            const data={};
            
            columns.forEach(col=>{
              const tasks=[];
              try {
                // ä»ä¸Šåˆ°ä¸‹éå†DOMå…ƒç´ ï¼Œä¿æŒè§†è§‰é¡ºåº
                const taskElements=document.querySelectorAll(`#${col}List .task`);
                taskElements.forEach(taskElement=>{
                  try {
                    const contentElement=taskElement.querySelector(".content");
                    // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å…ƒç´ éƒ½å­˜åœ¨
                    if (contentElement && taskElement.dataset.id) {
                      tasks.push({
                        id:taskElement.dataset.id,
                        text:contentElement.innerText || '',
                        created:taskElement.dataset.created || new Date().toISOString(),
                        priority:taskElement.dataset.priority||'none',
                        tags:taskElement.dataset.tags||'',
                        note:taskElement.dataset.note||''
                      });
                    }
                  } catch (taskError) {
                    console.error(`Error saving task in column ${col}:`, taskError);
                    // è·³è¿‡é”™è¯¯çš„ä»»åŠ¡ï¼Œç»§ç»­ä¿å­˜å…¶ä»–ä»»åŠ¡
                  }
                });
              } catch (queryError) {
                console.error(`Error querying tasks for column ${col}:`, queryError);
              }
              data[col]=tasks;
            });
            
            // å®‰å…¨åœ°ä¿å­˜åˆ°localStorage
            try {
              const jsonString=JSON.stringify(data);
              localStorage.setItem(key,jsonString);
            } catch (storageError) {
              console.error('Error saving data to localStorage:', storageError);
              // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„é”™è¯¯å¤„ç†ï¼Œæ¯”å¦‚æ˜¾ç¤ºè­¦å‘Š
              if (storageError instanceof DOMException && 
                  (storageError.name === 'QuotaExceededError' || 
                   storageError.name === 'NS_ERROR_DOM_QUOTA_REACHED')) {
                console.warn('localStorage quota exceeded, consider clearing old data');
              }
            }
            
            // ç¡®ä¿è¿™äº›å‡½æ•°å­˜åœ¨å†è°ƒç”¨
            if (typeof updateTaskCounts === 'function') updateTaskCounts();
            if (typeof updateStats === 'function') updateStats();
            if (typeof checkEmptyStates === 'function') checkEmptyStates();
          } catch (err) {
            console.error('Error saving week data:', err);
          }
        };
      const renderTask=(taskData)=>{try {
          // éªŒè¯è¾“å…¥å‚æ•°
          if (!taskData || typeof taskData !== 'object') {
            console.error('Invalid task data provided to renderTask:', taskData);
            return null;
          }
          
          // åˆ›å»ºä»»åŠ¡å…ƒç´ 
          const taskElement=document.createElement("div");
          taskElement.className="task";
          taskElement.setAttribute("draggable","true");
          
          // è®¾ç½®æ•°æ®å±æ€§ï¼Œç¡®ä¿æœ‰é»˜è®¤å€¼
          taskElement.dataset.id=taskData.id || `task_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          taskElement.dataset.created=taskData.created || new Date().toISOString();
          taskElement.dataset.priority=taskData.priority || 'none';
          taskElement.dataset.tags=taskData.tags || '';
          taskElement.dataset.note=taskData.note || '';
          
          // è®¾ç½®ä¼˜å…ˆçº§å±æ€§
          if(taskData.priority && taskData.priority!=='none'){
            taskElement.setAttribute('data-priority',taskData.priority);
          }
          
          // æ ¼å¼åŒ–åˆ›å»ºæ—¶é—´
          const createdAt=new Date(taskElement.dataset.created);
          if (isNaN(createdAt.getTime())) {
            console.warn('Invalid date in task data, using current date');
            createdAt=new Date();
          }
          
          // æ„å»ºä¼˜å…ˆçº§æ ‡ç­¾
          let priorityBadge='';
          if(taskData.priority && taskData.priority!=='none'){
            // éªŒè¯ä¼˜å…ˆçº§å€¼çš„æœ‰æ•ˆæ€§
            const validPriorities=['high', 'medium', 'low'];
            if (validPriorities.includes(taskData.priority)) {
              priorityBadge=`<span class="priority-badge ${taskData.priority}"></span>`;
            } else {
              console.warn(`Invalid priority value: ${taskData.priority}`);
            }
          }
          
          // æ„å»ºæ ‡ç­¾HTML
          let tagsHtml='';
          if(taskData.tags){
            try {
              const tagList=taskData.tags.split(',').filter(tag=>tag.trim());
              if(tagList.length>0){
                tagsHtml='<div class="task-tags">'+tagList.map(tag=>`<span class="tag">${escapeHtml(tag.trim())}</span>`).join('')+'</div>';
              }
            } catch (tagsError) {
              console.error('Error processing tags:', tagsError);
            }
          }
          
          // æ„å»ºå¤‡æ³¨HTML
          let noteHtml='';
          if(taskData.note){
            noteHtml=`<div class="task-note">ğŸ“ ${escapeHtml(taskData.note)}</div>`;
          }
          
          // è·å–æ—¶é—´æˆ³æ˜¾ç¤ºè®¾ç½®
          const showTimeToggle=document.getElementById('showTimestampToggle');
          const showTime=showTimeToggle ? showTimeToggle.checked : true;
          
          // è®¾ç½®HTMLå†…å®¹
          taskElement.innerHTML=`
            ${priorityBadge}
            <div class="content">${escapeHtml(taskData.text || '')}</div>
            ${tagsHtml}
            ${noteHtml}
            <div class="meta">
              <span class="small timestamp" title="${createdAt.toLocaleString()}" style="display:${showTime?'inline':'none'}">åˆ›å»ºäº ${createdAt.toLocaleDateString()}</span>
              <button title="åˆ é™¤ä»»åŠ¡" class="del-btn">\u2715</button>
            </div>
          `;
          
          // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ŒåŒ…å«é”™è¯¯å¤„ç†
          try {
            const contentElement=taskElement.querySelector(".content");
            if (contentElement) {
              contentElement.addEventListener("dblclick",(e)=>{
                try {
                  e.target.setAttribute("contenteditable","true");
                  e.target.focus();
                } catch (editError) {
                  console.error('Error enabling task editing:', editError);
                }
              });
              
              contentElement.addEventListener("blur",(e)=>{
                try {
                  e.target.removeAttribute("contenteditable");
                  if (typeof saveForWeek === 'function') {
                    saveForWeek();
                  }
                } catch (saveError) {
                  console.error('Error saving task after edit:', saveError);
                }
              });
            }
            
            taskElement.addEventListener('contextmenu',(e)=>{
              try {
                e.preventDefault();
                if (typeof showTaskContextMenu === 'function') {
                  showTaskContextMenu(taskElement);
                }
              } catch (menuError) {
                console.error('Error showing task context menu:', menuError);
              }
            });
          } catch (eventError) {
            console.error('Error setting up task event listeners:', eventError);
          }
          
          return taskElement;
        } catch (err) {
          console.error('Error rendering task:', err);
          return null;
        }
      };
      const addTask=(columnName,taskText)=>{
        try {
          // éªŒè¯è¾“å…¥å‚æ•°
          if (!columnName || typeof columnName !== 'string') {
            console.error('Invalid column name provided to addTask:', columnName);
            return null;
          }
          
          // éªŒè¯ä»»åŠ¡æ–‡æœ¬
          const trimmedText=(taskText || '').trim();
          if (!trimmedText) {
            console.warn('Empty task text provided, not adding task');
            return null;
          }
          
          // ç”Ÿæˆå”¯ä¸€ID
          const taskId="t"+Date.now()+"_"+Math.random().toString(36).substr(2, 9);
          
          // åˆ›å»ºä»»åŠ¡å¯¹è±¡
          const taskData={
            id:taskId,
            text:trimmedText,
            created:new Date().toISOString(),
            priority:'none',
            tags:'',
            note:''
          };
          
          // æ¸²æŸ“ä»»åŠ¡å…ƒç´ 
          const taskElement=renderTask(taskData);
          if (!taskElement) {
            console.error('Failed to render new task');
            return null;
          }
          
          // è·å–ç›®æ ‡åˆ—è¡¨å…ƒç´ 
          const listElement=document.getElementById(columnName+"List");
          if (!listElement) {
            console.error(`List element not found for column: ${columnName}`);
            return null;
          }
          
          // æ·»åŠ åŠ¨ç”»æ•ˆæœå¹¶è¿½åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
          taskElement.classList.add('newly-added');
          listElement.prepend(taskElement);
          
          // ä¿å­˜æ•°æ®
          if (typeof saveForWeek === 'function') {
            saveForWeek();
          }
          
          // æ›´æ–°ç©ºçŠ¶æ€æ£€æŸ¥ - ç¡®ä¿æ·»åŠ ä»»åŠ¡åç§»é™¤ç©ºçŠ¶æ€æ˜¾ç¤º
          if(typeof checkEmptyStates === 'function') {
            checkEmptyStates();
          }
          
          // ç§»é™¤åŠ¨ç”»ç±»
          setTimeout(()=>{
            try {
              if (taskElement && taskElement.classList) {
                taskElement.classList.remove('newly-added');
              }
            } catch (timeoutError) {
              console.error('Error removing animation class:', timeoutError);
            }
          },400);
          
          return taskElement;
        } catch (err) {
          console.error('Error adding new task:', err);
          return null;
        }
      };
      const startClock=()=>{const a=document.getElementById("liveClock");if(!a)return;const e=()=>{a.textContent=(new Date).toLocaleTimeString("zh-CN",{hour12:!1})};e(),setInterval(e,1e3)};
      const updateCurrentDate=()=>{const dateEl=document.getElementById("currentDate");if(!dateEl)return;const now=new Date();const options={year:'numeric',month:'long',day:'numeric',weekday:'long'};dateEl.textContent=now.toLocaleDateString('zh-CN',options)};
      const initEventListeners=()=>{
        document.getElementById("prevWeek").addEventListener("click",()=>changeWeek(-1));
        document.getElementById("nextWeek").addEventListener("click",()=>changeWeek(1));
        document.getElementById("todayBtn").addEventListener("click",()=>{currentWeek=new Date;loadForWeek()});
        document.getElementById("clearBtn").addEventListener("click",clearCurrentWeek);
        
        board.addEventListener("click",a=>{
          if(a.target.matches("[data-add-to]")){
            const e=a.target.getAttribute("data-add-to");
            const t=document.getElementById("input-"+e);
            if(t.value.trim()){
              addTask(e,t.value.trim());
              t.value="";
              t.dispatchEvent(new Event("input"));
            }
          }
        });
        
          board.addEventListener("click",a=>{
          try {
            if(a.target.matches(".del-btn")){
              a.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
              const taskElement=a.target.closest(".task");
              
              // å®‰å…¨æ£€æŸ¥
              if(!taskElement) {
                console.warn("No task element found to delete");
                return;
              }
              
              // ç¡®è®¤åˆ é™¤
              if(confirm("ç¡®å®šè¦åˆ é™¤è¯¥ä»»åŠ¡å—ï¼Ÿ")){
                try {
                  // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                  taskElement.style.transform="scale(0.8)";
                  taskElement.style.opacity="0";
                  taskElement.style.transition="transform 0.2s ease, opacity 0.2s ease";
                  
                  // å»¶è¿Ÿåˆ é™¤å¹¶ä¿å­˜
                  setTimeout(()=>{
                    try {
                      // å†æ¬¡æ£€æŸ¥å…ƒç´ æ˜¯å¦ä»ç„¶å­˜åœ¨
                      if(document.body.contains(taskElement)) {
                        taskElement.remove();
                        // å®‰å…¨åœ°è°ƒç”¨ä¿å­˜å‡½æ•°
                        if(typeof saveForWeek === 'function') {
                          saveForWeek();
                        }
                        // æ›´æ–°ç©ºçŠ¶æ€æ£€æŸ¥
                        if(typeof checkEmptyStates === 'function') {
                          checkEmptyStates();
                        }
                      }
                    } catch (removeError) {
                      console.error('Error removing task element:', removeError);
                    }
                  },200);
                } catch (animationError) {
                  console.error('Error applying delete animation:', animationError);
                  // å³ä½¿åŠ¨ç”»å‡ºé”™ä¹Ÿå°è¯•åˆ é™¤ä»»åŠ¡
                  if(document.body.contains(taskElement)) {
                    taskElement.remove();
                    if(typeof saveForWeek === 'function') {
                      saveForWeek();
                    }
                  }
                }
              }
            }
          } catch (deleteError) {
            console.error('Error in delete task handler:', deleteError);
          }
        });
        
        board.querySelectorAll('input[type="text"]').forEach(a=>{
          a.addEventListener("input",()=>{
            const e=a.id.replace("input-","");
            const t=document.querySelector(`button[data-add-to="${e}"]`);
            t.disabled=!a.value.trim();
          });
          a.addEventListener("keydown",e=>{
            if("Enter"===e.key){
              e.preventDefault();
              const t=document.querySelector(`button[data-add-to="${a.id.replace("input-","")}"]`);
              t.click();
            }
          });
        });
        
        const a=document.createElement("div");
        a.className="drop-indicator";
        
        board.addEventListener("dragstart",e=>{
          if(e.target.matches(".task")){
            draggedEl=e.target;
            draggedEl.classList.add("dragging");
            e.dataTransfer.effectAllowed="move";
            e.dataTransfer.setData("text/plain",draggedEl.dataset.id);
          }
        });
        
        board.addEventListener("dragend",e=>{
          if(draggedEl){
            draggedEl.classList.remove("dragging");
            draggedEl=null;
            a.remove();
            document.querySelectorAll(".col-list.drag-over").forEach(t=>t.classList.remove("drag-over"));
            saveForWeek();
            applySearchFilter();
          }
        });
        
        // ğŸ”§ ä¿®å¤ï¼šæ‹–æ‹½æ—¶æ ¹æ®é¼ æ ‡ä½ç½®ç²¾ç¡®æ”¾ç½®ä»»åŠ¡
        board.addEventListener("dragover",e=>{
          e.preventDefault();
          const t=e.target.closest(".col-list");
          if(t){
            t.classList.add("drag-over");
            const o=getDragAfterElement(t,e.clientY);
            const tasks=t.querySelectorAll(".task:not(.dragging)");
            
            // è·å–åˆ—è¡¨å®¹å™¨çš„ä½ç½®ä¿¡æ¯
            const listRect=t.getBoundingClientRect();
            
            // æ ¹æ®é¼ æ ‡ä½ç½®å’Œè¿”å›çš„å…ƒç´ å†³å®šæ”¾ç½®ä½ç½®
            // ç‰¹åˆ«å¤„ç†undefinedæƒ…å†µï¼šè¡¨ç¤ºç©ºåˆ—è¡¨ä¸”é¼ æ ‡åœ¨ä¸ŠåŠéƒ¨åˆ†ï¼Œåº”æ”¾åœ¨é¡¶éƒ¨
            if(o===undefined){
              // æ”¾åœ¨é¡¶éƒ¨
              if(t.firstChild) {
                t.insertBefore(a,t.firstChild);
              } else {
                t.appendChild(a);
              }
            } else if(o==null){
              // å¦‚æœgetDragAfterElementè¿”å›nullä¸”æœ‰ä»»åŠ¡ï¼Œæ£€æŸ¥é¼ æ ‡ä½ç½®
              if(tasks.length>0){
                // è·å–åˆ—è¡¨å®¹å™¨å’Œæœ€åä¸€ä¸ªä»»åŠ¡çš„ä½ç½®ä¿¡æ¯
                const lastTask=tasks[tasks.length-1];
                const lastTaskRect=lastTask.getBoundingClientRect();
                const listCenter=listRect.top + listRect.height / 2;
                
                // ä¼˜åŒ–æ”¾ç½®é€»è¾‘ï¼šåªæœ‰åœ¨é¼ æ ‡æ˜ç¡®åœ¨åº•éƒ¨åŒºåŸŸæ‰æ”¾åœ¨æœ«å°¾
                // å¦åˆ™å°è¯•æ”¾åœ¨åˆé€‚çš„ä½ç½®ï¼Œé¿å…æ€»æ˜¯æ”¾åœ¨å¼€å¤´æˆ–æœ«å°¾
                if(e.clientY > lastTaskRect.top + lastTaskRect.height * 0.9) {
                  // éå¸¸æ¥è¿‘åº•éƒ¨æ—¶æ‰æ”¾åœ¨æœ«å°¾
                  t.appendChild(a);
                } else if(e.clientY < listRect.top + listRect.height * 0.2) {
                  // æ¥è¿‘é¡¶éƒ¨æ—¶æ”¾åœ¨å¼€å¤´
                  t.insertBefore(a,tasks[0]);
                } else {
                  // ä¸­é—´åŒºåŸŸæ—¶ï¼Œå°è¯•æ‰¾åˆ°æœ€æ¥è¿‘çš„ä½ç½®
                  let closestIndex=0;
                  let minDistance=Math.abs(e.clientY - (tasks[0].getBoundingClientRect().top + tasks[0].getBoundingClientRect().height/2));
                  
                  for(let i=1;i<tasks.length;i++){
                    const taskCenter=tasks[i].getBoundingClientRect().top + tasks[i].getBoundingClientRect().height/2;
                    const distance=Math.abs(e.clientY - taskCenter);
                    if(distance<minDistance){
                      minDistance=distance;
                      closestIndex=i;
                    }
                  }
                  
                  // æ’å…¥åˆ°æœ€æ¥è¿‘çš„ä»»åŠ¡ä¹‹å‰
                  t.insertBefore(a,tasks[closestIndex]);
                }
              }else{
                // åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œæ ¹æ®é¼ æ ‡ä½ç½®å†³å®šæ”¾ç½®åœ¨é¡¶éƒ¨è¿˜æ˜¯åº•éƒ¨
                // è·å–åˆ—è¡¨å®¹å™¨çš„å‚ç›´ä¸­å¿ƒç‚¹
                const listMiddle=listRect.top + listRect.height / 2;
                
                // å¦‚æœé¼ æ ‡åœ¨åˆ—è¡¨ä¸ŠåŠéƒ¨åˆ†ï¼Œæ”¾åœ¨é¡¶éƒ¨
                if(e.clientY < listMiddle) {
                  // ä½¿ç”¨insertBeforeæ’å…¥åˆ°ç¬¬ä¸€ä¸ªå­å…ƒç´ å‰ï¼ˆç­‰åŒäºprependï¼‰
                  if(t.firstChild) {
                    t.insertBefore(a,t.firstChild);
                  } else {
                    // å¦‚æœæ²¡æœ‰å­å…ƒç´ ï¼Œæ­£å¸¸æ·»åŠ 
                    t.appendChild(a);
                  }
                } else {
                  // é¼ æ ‡åœ¨ä¸‹åŠéƒ¨åˆ†ï¼Œæ”¾åœ¨åº•éƒ¨
                  t.appendChild(a);
                }
              }
            }else{
              // æ­£å¸¸æ’å…¥åˆ°æŒ‡å®šå…ƒç´ ä¹‹å‰
              t.insertBefore(a,o);
            }
          }
        });
        
        board.addEventListener("dragleave",e=>{
          const t=e.target.closest(".col-list");
          if(t)t.classList.remove("drag-over");
        });
        
        board.addEventListener("drop",e=>{
          e.preventDefault();
          const t=e.target.closest(".col-list");
          if(t&&draggedEl){
            if(a.parentNode){
              a.parentNode.insertBefore(draggedEl,a);
            }else{
              t.appendChild(draggedEl);
            }
          }
        });
        
        const getDragAfterElement=(e,t)=>{
          const o=[...e.querySelectorAll(".task:not(.dragging)")];
          if(o.length===0){
            // ç©ºåˆ—è¡¨æ—¶ï¼Œæ ¹æ®é¼ æ ‡ä½ç½®è¿”å›ä¸åŒå€¼
            // è·å–åˆ—è¡¨å®¹å™¨çš„ä½ç½®ä¿¡æ¯
            const listRect=e.getBoundingClientRect();
            // è·å–åˆ—è¡¨å®¹å™¨çš„å‚ç›´ä¸­å¿ƒç‚¹
            const listMiddle=listRect.top + listRect.height / 2;
            
            // å¦‚æœé¼ æ ‡åœ¨ä¸ŠåŠéƒ¨åˆ†ï¼Œè¿”å›ä¸€ä¸ªç‰¹æ®Šæ ‡è®°ï¼ˆundefinedï¼‰è¡¨ç¤ºåº”è¯¥æ”¾åœ¨é¡¶éƒ¨
            // å¦‚æœé¼ æ ‡åœ¨ä¸‹åŠéƒ¨åˆ†ï¼Œè¿”å›nullè¡¨ç¤ºæ”¾åœ¨åº•éƒ¨
            return t < listMiddle ? undefined : null;
          }
          
          // è·å–åˆ—è¡¨å®¹å™¨çš„ä½ç½®ä¿¡æ¯
          const listRect=e.getBoundingClientRect();
          
          // å¦‚æœé¼ æ ‡ä½ç½®åœ¨åˆ—è¡¨é¡¶éƒ¨åŒºåŸŸï¼ˆå‰15%é«˜åº¦ï¼‰ï¼Œç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ 
          if(t < listRect.top + listRect.height * 0.15) {
            return o[0];
          }
          
          // å‡å°åº•éƒ¨åŒºåŸŸåˆ¤å®šèŒƒå›´ï¼Œä»10%æ”¹ä¸º5%ï¼Œå‡å°‘æ„å¤–æ”¾ç½®åœ¨åº•éƒ¨çš„æƒ…å†µ
          if(t > listRect.bottom - listRect.height * 0.05) {
            return null;
          }
          
          // æ­£å¸¸è®¡ç®—æ”¾ç½®ä½ç½® - æ›´ç²¾ç¡®çš„ä»»åŠ¡é—´å®šä½
          for(let i=0;i<o.length;i++){
            const elem=o[i];
            const box=elem.getBoundingClientRect();
            const offset=t-box.top-box.height/2;
            if(offset<0)return elem;
          }
          
          // åªæœ‰åœ¨é¼ æ ‡éå¸¸æ¥è¿‘åº•éƒ¨æ—¶æ‰é»˜è®¤æ”¾åœ¨æœ«å°¾ï¼Œå¦åˆ™å°è¯•æ”¾åœ¨å€’æ•°ç¬¬äºŒä¸ªä»»åŠ¡å‰
          if(t > listRect.bottom - listRect.height * 0.2 && o.length > 1) {
            return o[o.length - 1];
          }
          
          return null;
        };
      };

      const changeWeek=a=>{currentWeek.setDate(currentWeek.getDate()+a*7),loadForWeek()},clearCurrentWeek=()=>{confirm("ç¡®å®šè¦æ¸…ç©ºæœ¬å‘¨çš„æ‰€æœ‰ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")&&(localStorage.removeItem(weekKey(currentWeek)),loadForWeek())};
      
      // âœ¨ ä¼˜åŒ–çš„å³é”®èœå• - åˆ†æ­¥éª¤è®¾ç½®
      const showTaskContextMenu = (taskEl) => {
        try {
          // å‚æ•°éªŒè¯
          if (!taskEl || !(taskEl instanceof HTMLElement) || !taskEl.classList.contains('task')) {
            console.error('Invalid task element provided to showTaskContextMenu:', taskEl);
            return;
          }
          
          const menuOptions = [
            'è®¾ç½®ä¼˜å…ˆçº§',
            'è®¾ç½®æ ‡ç­¾',
            'æ·»åŠ å¤‡æ³¨',
            'å–æ¶ˆ'
          ];
          
          const choice = prompt(`è¯·é€‰æ‹©æ“ä½œï¼š
1. ${menuOptions[0]}
2. ${menuOptions[1]}
3. ${menuOptions[2]}
4. ${menuOptions[3]}

è¯·è¾“å…¥æ•°å­— 1-4:`);
          
          if (!choice) return;
          
          // éªŒè¯è¾“å…¥æ ¼å¼
          const trimmedChoice = choice.trim();
          if (!/^[1-4]$/.test(trimmedChoice)) {
            console.warn('Invalid menu choice:', trimmedChoice);
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­— 1-4');
            return;
          }
          
          switch(trimmedChoice) {
            case '1':
              if (typeof setPriority === 'function') setPriority(taskEl);
              break;
            case '2':
              if (typeof setTags === 'function') setTags(taskEl);
              break;
            case '3':
              if (typeof setNote === 'function') setNote(taskEl);
              break;
            default:
              return;
          }
        } catch (menuError) {
          console.error('Error in task context menu:', menuError);
          // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
        }
      };
      
      const setPriority = (taskEl) => {
        try {
          // å‚æ•°éªŒè¯
          if (!taskEl || !(taskEl instanceof HTMLElement)) {
            console.error('Invalid task element provided to setPriority:', taskEl);
            return;
          }
          
          const priority = prompt('è®¾ç½®ä¼˜å…ˆçº§:\n- high (é«˜)\n- medium (ä¸­)\n- low (ä½)\n- none (æ— )\n\nè¯·è¾“å…¥:', taskEl.dataset.priority || 'none');
          
          // å¦‚æœç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
          if (priority === null) return;
          
          // éªŒè¯ä¼˜å…ˆçº§å€¼
          const trimmedPriority = priority.toLowerCase().trim();
          const validPriorities = ['high', 'medium', 'low', 'none'];
          
          if (!validPriorities.includes(trimmedPriority)) {
            console.warn('Invalid priority value:', trimmedPriority);
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä¼˜å…ˆçº§å€¼ï¼šhighã€mediumã€low æˆ– none');
            return;
          }
          
          try {
            // æ›´æ–°æ•°æ®å±æ€§
            taskEl.dataset.priority = trimmedPriority;
            
            // æ›´æ–°DOMå±æ€§
            if (trimmedPriority !== 'none') {
              taskEl.setAttribute('data-priority', trimmedPriority);
            } else {
              taskEl.removeAttribute('data-priority');
            }
            
            // æ›´æ–°UIæ˜¾ç¤º
            const badge = taskEl.querySelector('.priority-badge');
            if (badge) {
              badge.remove();
            }
            
            if (trimmedPriority !== 'none') {
              const newBadge = document.createElement('span');
              newBadge.className = `priority-badge ${trimmedPriority}`;
              
              // å®‰å…¨åœ°æ’å…¥å…ƒç´ 
              const firstChild = taskEl.firstChild;
              if (firstChild) {
                taskEl.insertBefore(newBadge, firstChild);
              } else {
                taskEl.appendChild(newBadge);
              }
            }
            
            // ä¿å­˜æ›´æ”¹
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          } catch (domError) {
            console.error('Error updating priority DOM elements:', domError);
            // å³ä½¿DOMæ›´æ–°å¤±è´¥ï¼Œä¹Ÿå°è¯•ä¿å­˜æ•°æ®
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          }
        } catch (error) {
          console.error('Error setting task priority:', error);
        }
      };
      
      const setTags = (taskEl) => {
        try {
          // å‚æ•°éªŒè¯
          if (!taskEl || !(taskEl instanceof HTMLElement)) {
            console.error('Invalid task element provided to setTags:', taskEl);
            return;
          }
          
          const tags = prompt('è®¾ç½®æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”å¤šä¸ªæ ‡ç­¾):\nä¾‹: å·¥ä½œ,ç´§æ€¥,å‰ç«¯', taskEl.dataset.tags || '');
          
          // å¦‚æœç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
          if (tags === null) return;
          
          try {
            // æ›´æ–°æ•°æ®å±æ€§
            taskEl.dataset.tags = tags;
            
            // æ›´æ–°UIæ˜¾ç¤º
            const tagDiv = taskEl.querySelector('.task-tags');
            if (tagDiv) {
              tagDiv.remove();
            }
            
            const trimmedTags = tags.trim();
            if (trimmedTags) {
              try {
                const tagList = tags.split(',').filter(t => t.trim());
                const newTagDiv = document.createElement('div');
                newTagDiv.className = 'task-tags';
                
                // å®‰å…¨åœ°ç”Ÿæˆæ ‡ç­¾HTML
                if (typeof escapeHtml === 'function') {
                  newTagDiv.innerHTML = tagList.map(t => {
                    const trimmedTag = t.trim();
                    return `<span class="tag">${escapeHtml(trimmedTag)}</span>`;
                  }).join('');
                } else {
                  console.warn('escapeHtml function not available, using basic tag creation');
                  // å¤‡é€‰æ–¹æ¡ˆï¼šé€ä¸ªåˆ›å»ºå…ƒç´ 
                  tagList.forEach(t => {
                    const trimmedTag = t.trim();
                    if (trimmedTag) {
                      const tagSpan = document.createElement('span');
                      tagSpan.className = 'tag';
                      tagSpan.textContent = trimmedTag;
                      newTagDiv.appendChild(tagSpan);
                    }
                  });
                }
                
                // å®‰å…¨åœ°æ’å…¥æ ‡ç­¾å®¹å™¨
                const contentElement = taskEl.querySelector('.content');
                if (contentElement && contentElement.parentNode === taskEl) {
                  contentElement.after(newTagDiv);
                } else {
                  console.warn('Content element not found or not a direct child, appending tags to end');
                  taskEl.appendChild(newTagDiv);
                }
              } catch (tagProcessingError) {
                console.error('Error processing tags:', tagProcessingError);
              }
            }
            
            // ä¿å­˜æ›´æ”¹
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          } catch (domError) {
            console.error('Error updating tags DOM elements:', domError);
            // å³ä½¿DOMæ›´æ–°å¤±è´¥ï¼Œä¹Ÿå°è¯•ä¿å­˜æ•°æ®
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          }
        } catch (error) {
          console.error('Error setting task tags:', error);
        }
      };
      
      const setNote = (taskEl) => {
        try {
          // å‚æ•°éªŒè¯
          if (!taskEl || !(taskEl instanceof HTMLElement)) {
            console.error('Invalid task element provided to setNote:', taskEl);
            return;
          }
          
          const note = prompt('æ·»åŠ å¤‡æ³¨ï¼š', taskEl.dataset.note || '');
          
          // å¦‚æœç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
          if (note === null) return;
          
          try {
            // æ›´æ–°æ•°æ®å±æ€§
            taskEl.dataset.note = note;
            
            // æ›´æ–°UIæ˜¾ç¤º
            const noteDiv = taskEl.querySelector('.task-note');
            if (noteDiv) {
              noteDiv.remove();
            }
            
            const trimmedNote = note.trim();
            if (trimmedNote) {
              const newNoteDiv = document.createElement('div');
              newNoteDiv.className = 'task-note';
              
              // å®‰å…¨åœ°è®¾ç½®å†…å®¹ï¼Œé¿å…XSS
              newNoteDiv.textContent = `ğŸ“ ${trimmedNote}`;
              
              // ç¡®å®šæ’å…¥ä½ç½®
              const tagElement = taskEl.querySelector('.task-tags');
              const contentElement = taskEl.querySelector('.content');
              
              if (tagElement && tagElement.parentNode === taskEl) {
                tagElement.after(newNoteDiv);
              } else if (contentElement && contentElement.parentNode === taskEl) {
                contentElement.after(newNoteDiv);
              } else {
                console.warn('Cannot find appropriate position for note, appending to end');
                taskEl.appendChild(newNoteDiv);
              }
            }
            
            // ä¿å­˜æ›´æ”¹
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          } catch (domError) {
            console.error('Error updating note DOM elements:', domError);
            // å³ä½¿DOMæ›´æ–°å¤±è´¥ï¼Œä¹Ÿå°è¯•ä¿å­˜æ•°æ®
            if (typeof saveForWeek === 'function') {
              saveForWeek();
            }
          }
        } catch (error) {
          console.error('Error setting task note:', error);
        }
      };
      
      // âœ¨ === æ–°å¢åŠŸèƒ½ï¼šè®¾ç½®æ¨¡æ€æ¡†é€»è¾‘ ===
      const settingsModal = document.getElementById('settingsModal');
      const openSettingsBtn = document.getElementById('settingsBtn');
      const closeSettingsBtn = document.getElementById('closeSettingsBtn');

      openSettingsBtn.addEventListener('click', () => settingsModal.classList.add('visible'));
      closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('visible'));
      settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) { settingsModal.classList.remove('visible'); }
      });
      
      // âœ¨ æ·±è‰²æ¨¡å¼åˆ‡æ¢
      const themeToggle = document.getElementById('themeToggle');
      const savedTheme = localStorage.getItem('theme') || 'light';
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeToggle.checked = true;
      }
      themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
        } else {
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
        }
      });
      
      // âœ¨ æ—¶é—´æˆ³æ˜¾ç¤ºåˆ‡æ¢
      document.getElementById('showTimestampToggle')?.addEventListener('change', (e) => {
        const show = e.target.checked;
        document.querySelectorAll('.task .timestamp').forEach(timestamp => {
          timestamp.style.display = show ? 'inline' : 'none';
        });
        localStorage.setItem('showTimestamp', show ? 'true' : 'false');
      });
      
      // åˆå§‹åŒ–æ—¶é—´æˆ³æ˜¾ç¤ºè®¾ç½®
      const savedShowTimestamp = localStorage.getItem('showTimestamp');
      if (savedShowTimestamp === 'false') {
        document.getElementById('showTimestampToggle').checked = false;
      }

      // âœ¨ æœç´¢åŠŸèƒ½ (ä¼˜åŒ–ç‰ˆ)
      const searchInput = document.getElementById('searchInput');
      const applySearchFilter = () => {
        const query = searchInput.value.toLowerCase();
        document.querySelectorAll('.task').forEach(task => {
          if (!query) {
            task.style.display = ''; // æ¸…ç©ºæœç´¢æ—¶æ˜¾ç¤ºæ‰€æœ‰
            return;
          }
          const text = task.querySelector('.content').textContent.toLowerCase();
          const tags = task.dataset.tags?.toLowerCase() || '';
          const note = task.dataset.note?.toLowerCase() || '';
          if (text.includes(query) || tags.includes(query) || note.includes(query)) {
            task.style.display = '';
          } else {
            task.style.display = 'none';
          }
        });
      };
      
      searchInput.addEventListener('input', applySearchFilter);

      // âœ¨ ç»Ÿè®¡åŠŸèƒ½
      const updateTaskCounts = () => {
        columns.forEach(col => {
          const count = document.querySelectorAll(`#${col}List .task`).length;
          const countEl = document.getElementById(`count-${col}`);
          if (countEl) countEl.textContent = count;
        });
      };

      const updateStats = () => {
        const counts = {};
        let total = 0;
        columns.forEach(col => {
          const count = document.querySelectorAll(`#${col}List .task`).length;
          counts[col] = count;
          total += count;
        });
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statPlanning').textContent = counts.planning || 0;
        document.getElementById('statTodo').textContent = counts.todo || 0;
        document.getElementById('statDoing').textContent = counts.doing || 0;
        document.getElementById('statDone').textContent = counts.done || 0;
        const progress = total > 0 ? Math.round((counts.done / total) * 100) : 0;
        document.getElementById('statProgress').textContent = progress + '%';
        document.getElementById('progressFill').style.width = progress + '%';
        
        // æ›´æ–°ç”¨æˆ·å¡ç‰‡ç»Ÿè®¡
        document.getElementById('userWeekTotal').textContent = total;
        document.getElementById('userWeekDone').textContent = counts.done || 0;
      };

      const statsBtn = document.getElementById('statsBtn');
      const statsPanel = document.getElementById('statsPanel');
      // åˆå§‹åŒ–ç»Ÿè®¡é¢æ¿ä¸ºéšè—çŠ¶æ€
      statsBtn.addEventListener('click', () => {
        if (statsPanel.style.display === 'none') {
          statsPanel.style.display = 'grid';
          statsBtn.textContent = 'ğŸ“ˆ éšè—ç»Ÿè®¡';
          updateStats();
        } else {
          statsPanel.style.display = 'none';
          statsBtn.textContent = 'ğŸ“ˆ ç»Ÿè®¡';
        }
      });
      
      // âœ¨ === æ–°å¢åŠŸèƒ½ï¼šæ•°æ®å¯¼å‡ºé€»è¾‘ ===
      const getCurrentWeekData = () => {
          const key = weekKey(currentWeek);
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : {planning:[], todo:[], doing:[], done:[]};
      };

      const downloadFile = (filename, content, mimeType) => {
          const blob = new Blob([content], { type: mimeType });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
      };

      // å¯¼å‡ºä¸º JSON
      document.getElementById('exportJsonBtn').addEventListener('click', () => {
          const data = getCurrentWeekData();
          const jsonString = JSON.stringify(data, null, 2);
          const weekStartDate = startOfWeek(currentWeek).toISOString().slice(0, 10);
          downloadFile(`kanban-backup-${weekStartDate}.json`, jsonString, 'application/json');
      });

      // å¯¼å‡ºä¸º CSV
      document.getElementById('exportCsvBtn').addEventListener('click', () => {
          const data = getCurrentWeekData();
          const statusMap = { planning: 'è§„åˆ’', todo: 'å¾…åš', doing: 'æ­£åœ¨åš', done: 'å®Œæˆ' };
          let csvContent = '\uFEFF'; // BOM for Excel to recognize UTF-8
          csvContent += 'ID,å†…å®¹,çŠ¶æ€,åˆ›å»ºæ—¥æœŸ,ä¼˜å…ˆçº§,æ ‡ç­¾,å¤‡æ³¨\n';

          columns.forEach(col => {
              (data[col] || []).forEach(task => {
                  const id = task.id;
                  const text = `"${task.text.replace(/"/g, '""')}"`; // Handle quotes in text
                  const status = statusMap[col];
                  const created = new Date(task.created).toLocaleString('zh-CN');
                  const priority = task.priority || 'none';
                  const tags = task.tags || '';
                  const note = `"${(task.note || '').replace(/"/g, '""')}"`;
                  csvContent += [id, text, status, created, priority, tags, note].join(',') + '\n';
              });
          });
          
          const weekStartDate = startOfWeek(currentWeek).toISOString().slice(0, 10);
          downloadFile(`kanban-export-${weekStartDate}.csv`, csvContent, 'text/csv;charset=utf-8;');
      });

      // âœ¨ å¯¼å‡ºæˆå°±å¡ç‰‡ä¸ºJPGå›¾ç‰‡ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
      document.getElementById('exportImageBtn').addEventListener('click', () => {
        const data = getCurrentWeekData();
        const counts = {};
        let total = 0;
        columns.forEach(col => {
          counts[col] = (data[col] || []).length;
          total += counts[col];
        });
        const progress = total > 0 ? Math.round((counts.done / total) * 100) : 0;
        const userId = localStorage.getItem('userProfile_id') || 'æˆ‘çš„ä»»åŠ¡çœ‹æ¿';
        const userMotto = localStorage.getItem('userProfile_motto') || 'ä»Šæ—¥äº‹, ä»Šæ—¥æ¯• ğŸš€';
        
        // åˆ›å»ºé«˜æ¸… Canvas
        const canvas = document.createElement('canvas');
        canvas.width = 1080;  // æé«˜åˆ†è¾¨ç‡
        canvas.height = 1350; // 16:9 æ¯”ä¾‹ä¼˜åŒ–
        const ctx = canvas.getContext('2d');
        
        // å¯ç”¨é«˜è´¨é‡æ¸²æŸ“
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        // æ¸å˜èƒŒæ™¯ï¼ˆæ›´ä¸°å¯Œçš„é¢œè‰²ï¼‰
        const gradient = ctx.createLinearGradient(0, 0, 1080, 1350);
        gradient.addColorStop(0, '#667eea');
        gradient.addColorStop(0.5, '#764ba2');
        gradient.addColorStop(1, '#f093fb');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 1080, 1350);
        
        // è£…é¥°åœ†å½¢ï¼ˆå¢åŠ è®¾è®¡æ„Ÿï¼‰
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.beginPath();
        ctx.arc(150, 150, 200, 0, 2 * Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(930, 1200, 250, 0, 2 * Math.PI);
        ctx.fill();
        
        // ç™½è‰²å¡ç‰‡èƒŒæ™¯ï¼ˆåœ†è§’ä¼˜åŒ–ï¼‰
        ctx.fillStyle = 'white';
        ctx.shadowColor = 'rgba(0,0,0,0.15)';
        ctx.shadowBlur = 40;
        ctx.shadowOffsetY = 15;
        // ç»˜åˆ¶åœ†è§’çŸ©å½¢
        const cardX = 60, cardY = 100, cardW = 960, cardH = 1150, cardRadius = 30;
        ctx.beginPath();
        ctx.moveTo(cardX + cardRadius, cardY);
        ctx.lineTo(cardX + cardW - cardRadius, cardY);
        ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + cardRadius);
        ctx.lineTo(cardX + cardW, cardY + cardH - cardRadius);
        ctx.quadraticCurveTo(cardX + cardW, cardY + cardH, cardX + cardW - cardRadius, cardY + cardH);
        ctx.lineTo(cardX + cardRadius, cardY + cardH);
        ctx.quadraticCurveTo(cardX, cardY + cardH, cardX, cardY + cardH - cardRadius);
        ctx.lineTo(cardX, cardY + cardRadius);
        ctx.quadraticCurveTo(cardX, cardY, cardX + cardRadius, cardY);
        ctx.closePath();
        ctx.fill();
        ctx.shadowColor = 'transparent';
        
        // é¡¶éƒ¨è£…é¥°æ¡
        const topBarGradient = ctx.createLinearGradient(60, 100, 1020, 100);
        topBarGradient.addColorStop(0, '#667eea');
        topBarGradient.addColorStop(1, '#764ba2');
        ctx.fillStyle = topBarGradient;
        ctx.beginPath();
        ctx.moveTo(cardX + cardRadius, cardY);
        ctx.lineTo(cardX + cardW - cardRadius, cardY);
        ctx.quadraticCurveTo(cardX + cardW, cardY, cardX + cardW, cardY + cardRadius);
        ctx.lineTo(cardX + cardW, cardY + 120);
        ctx.lineTo(cardX, cardY + 120);
        ctx.lineTo(cardX, cardY + cardRadius);
        ctx.quadraticCurveTo(cardX, cardY, cardX + cardRadius, cardY);
        ctx.closePath();
        ctx.fill();
        
        // æ ‡é¢˜ï¼ˆç™½è‰²åœ¨ç´«è‰²æ¡ä¸Šï¼‰
        ctx.fillStyle = 'white';
        ctx.font = 'bold 56px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('ğŸ† æœ¬å‘¨æˆå°±æŠ¥å‘Š', 540, 185);
        
        // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
        ctx.fillStyle = '#333';
        ctx.font = 'bold 38px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`ğŸ‘¤ ${userId}`, 120, 300);
        
        ctx.fillStyle = '#666';
        ctx.font = 'italic 24px "Microsoft Yahei", sans-serif';
        ctx.fillText(`"${userMotto}"`, 120, 350);
        
        // æ—¥æœŸå’Œå‘¨æ•°
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-CN', {year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'});
        const weekNum = getWeekNumber(now);
        ctx.fillStyle = '#999';
        ctx.font = '20px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(dateStr, 960, 300);
        ctx.fillText(`ç¬¬ ${weekNum} å‘¨`, 960, 330);
        
        // åˆ†éš”çº¿
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(120, 380);
        ctx.lineTo(960, 380);
        ctx.stroke();
        
        // æ€»ä»»åŠ¡æ•°åŒºåŸŸï¼ˆå¸¦èƒŒæ™¯ï¼‰
        const statY = 520;
        ctx.fillStyle = 'rgba(102, 126, 234, 0.08)';
        ctx.fillRect(120, 420, 840, 140);
        
        ctx.fillStyle = '#667eea';
        ctx.font = 'bold 90px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(total.toString(), 540, statY);
        
        ctx.fillStyle = '#666';
        ctx.font = '28px "Microsoft Yahei", sans-serif';
        ctx.fillText('æœ¬å‘¨åˆ›å»ºä»»åŠ¡æ•°', 540, statY + 50);
        
        // å®Œæˆåº¦åœ†ç¯ï¼ˆæ›´ç²¾ç¾ï¼‰
        const centerX = 540;
        const centerY = 750;
        const circleRadius = 120;
        
        // èƒŒæ™¯åœ†
        ctx.beginPath();
        ctx.arc(centerX, centerY, circleRadius, 0, 2 * Math.PI);
        ctx.strokeStyle = '#f0f0f0';
        ctx.lineWidth = 24;
        ctx.stroke();
        
        // è¿›åº¦åœ†ï¼ˆæ¸å˜è‰²ï¼‰
        ctx.beginPath();
        const progressAngle = (progress / 100) * 2 * Math.PI;
        ctx.arc(centerX, centerY, circleRadius, -0.5 * Math.PI, -0.5 * Math.PI + progressAngle);
        const progressGradient = ctx.createLinearGradient(centerX - circleRadius, centerY, centerX + circleRadius, centerY);
        progressGradient.addColorStop(0, '#20c997');
        progressGradient.addColorStop(0.5, '#38d9a9');
        progressGradient.addColorStop(1, '#51cf66');
        ctx.strokeStyle = progressGradient;
        ctx.lineWidth = 24;
        ctx.lineCap = 'round';
        ctx.stroke();
        
        // å®Œæˆåº¦æ–‡å­—
        ctx.fillStyle = '#667eea';
        ctx.font = 'bold 64px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(`${progress}%`, centerX, centerY + 18);
        
        ctx.fillStyle = '#666';
        ctx.font = '24px "Microsoft Yahei", sans-serif';
        ctx.fillText('å®Œæˆåº¦', centerX, centerY + 55);
        
        // è¯¦ç»†ç»Ÿè®¡ï¼ˆå¸¦èƒŒæ™¯å¡ç‰‡ï¼‰
        const detailY = 960;
        const statItems = [
          { label: 'ğŸ’¡ è§„åˆ’', value: counts.planning, color: '#339af0', bg: 'rgba(51, 154, 240, 0.1)' },
          { label: 'ğŸ“ å¾…åš', value: counts.todo, color: '#845ef7', bg: 'rgba(132, 94, 247, 0.1)' },
          { label: 'â³ è¿›è¡Œä¸­', value: counts.doing, color: '#fd7e14', bg: 'rgba(253, 126, 20, 0.1)' },
          { label: 'âœ… å®Œæˆ', value: counts.done, color: '#20c997', bg: 'rgba(32, 201, 151, 0.1)' }
        ];
        
        statItems.forEach((item, index) => {
          const x = 180 + index * 210;
          // èƒŒæ™¯å¡ç‰‡
          ctx.fillStyle = item.bg;
          ctx.fillRect(x - 75, detailY - 60, 150, 120);
          ctx.strokeStyle = item.color;
          ctx.lineWidth = 2;
          ctx.strokeRect(x - 75, detailY - 60, 150, 120);
          
          // æ•°å­—
          ctx.fillStyle = item.color;
          ctx.font = 'bold 42px "Microsoft Yahei", sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(item.value.toString(), x, detailY);
          
          // æ ‡ç­¾
          ctx.fillStyle = '#666';
          ctx.font = '20px "Microsoft Yahei", sans-serif';
          ctx.fillText(item.label, x, detailY + 40);
        });
        
        // åº•éƒ¨é¼“åŠ±è¯­ï¼ˆå¸¦èƒŒæ™¯ï¼‰
        let encouragement = '';
        let encourageColor = '#667eea';
        if (progress >= 80) {
          encouragement = 'ğŸ‰ æ£’æäº†ï¼ä½ æ˜¯æ‰§è¡ŒåŠ›å¤§å¸ˆï¼';
          encourageColor = '#20c997';
        } else if (progress >= 50) {
          encouragement = 'ğŸ’ª åŠ æ²¹ï¼ä½ å·²ç»å®Œæˆä¸€åŠäº†ï¼';
          encourageColor = '#fd7e14';
        } else if (total > 0) {
          encouragement = 'ğŸŒŸ ç»§ç»­åŠªåŠ›ï¼Œæ¯ä¸€æ­¥éƒ½æ˜¯è¿›æ­¥ï¼';
          encourageColor = '#845ef7';
        } else {
          encouragement = 'ğŸš€ å¼€å§‹ä½ çš„é«˜æ•ˆä¸€å‘¨å§ï¼';
        }
        
        ctx.fillStyle = 'rgba(102, 126, 234, 0.1)';
        ctx.fillRect(120, 1120, 840, 70);
        
        ctx.fillStyle = encourageColor;
        ctx.font = 'bold 30px "Microsoft Yahei", sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(encouragement, 540, 1165);
        
        // æ°´å°ï¼ˆæ›´ç²¾è‡´ï¼‰
        ctx.fillStyle = '#bbb';
        ctx.font = '18px "Microsoft Yahei", sans-serif';
        ctx.fillText('ğŸ“Š å‘¨ä»»åŠ¡çœ‹æ¿ - è®©æ¯ä¸€å‘¨éƒ½æ›´é«˜æ•ˆ', 540, 1230);
        
        // è½¬æ¢ä¸ºJPGå¹¶ä¸‹è½½ï¼ˆæé«˜è´¨é‡ï¼‰
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const weekStartDate = startOfWeek(currentWeek).toISOString().slice(0, 10);
          const fileName = `æˆ‘çš„æˆå°±-${userId}-${weekStartDate}.jpg`;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert('âœ¨ æˆå°±å¡ç‰‡å·²ç”Ÿæˆï¼\næ–‡ä»¶å: ' + fileName + '\nå¿«å»åˆ†äº«ä½ çš„è¿›æ­¥å§ï¼');
        }, 'image/jpeg', 0.98); // æé«˜è´¨é‡åˆ°98%
      });

      // âœ¨ å¯¼å…¥JSON - å¢å¼ºç‰ˆ
      document.getElementById('importJsonInput')?.addEventListener('change', (e) => {
          try {
              // éªŒè¯äº‹ä»¶å¯¹è±¡
              if (!e || !e.target) {
                  console.error('Invalid event object');
                  return;
              }
              
              const file = e.target.files[0];
              if (!file) {
                  console.warn('No file selected');
                  return;
              }
              
              // éªŒè¯æ–‡ä»¶ç±»å‹
              if (file.type && file.type !== 'application/json' && !file.name.endsWith('.json')) {
                  alert('âŒ è¯·é€‰æ‹©æœ‰æ•ˆçš„JSONæ–‡ä»¶');
                  e.target.value = '';
                  return;
              }
              
              // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º5MBï¼‰
              const maxSize = 5 * 1024 * 1024; // 5MB
              if (file.size > maxSize) {
                  alert('âŒ æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº5MBçš„JSONæ–‡ä»¶');
                  e.target.value = '';
                  return;
              }
              
              const reader = new FileReader();
              
              // æ·»åŠ é”™è¯¯å¤„ç†
              reader.onerror = () => {
                  console.error('Error reading file');
                  alert('âŒ è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
                  e.target.value = '';
              };
              
              reader.onload = (event) => {
                  try {
                      // éªŒè¯äº‹ä»¶ç›®æ ‡å’Œç»“æœ
                      if (!event || !event.target || !event.target.result) {
                          throw new Error('æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹');
                      }
                      
                      const result = event.target.result;
                      if (typeof result !== 'string' || result.trim() === '') {
                          throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆ');
                      }
                      
                      let data;
                      try {
                          data = JSON.parse(result);
                      } catch (parseError) {
                          throw new Error(`JSONæ ¼å¼é”™è¯¯: ${parseError.message}`);
                      }
                      
                      // ä¸¥æ ¼éªŒè¯æ•°æ®ç»“æ„
                      if (!data || typeof data !== 'object' || Array.isArray(data)) {
                          throw new Error('æ•°æ®å¿…é¡»æ˜¯å¯¹è±¡æ ¼å¼');
                      }
                      
                      // è¯¦ç»†éªŒè¯æ¯ä¸€åˆ—çš„ä»»åŠ¡æ•°æ®
                      let validTasksFound = false;
                      for (const col of columns) {
                          const columnData = data[col];
                          // å…è®¸åˆ—ä¸å­˜åœ¨æˆ–ä¸ºç©ºæ•°ç»„
                          if (columnData !== undefined && !Array.isArray(columnData)) {
                              throw new Error(`åˆ— ${col} çš„æ•°æ®å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼`);
                          }
                          
                          // éªŒè¯æ¯ä¸ªä»»åŠ¡çš„ç»“æ„
                          if (Array.isArray(columnData)) {
                              for (let i = 0; i < columnData.length; i++) {
                                  const task = columnData[i];
                                  if (!task || typeof task !== 'object') {
                                      throw new Error(`åˆ— ${col} ä¸­çš„ä»»åŠ¡ #${i+1} æ ¼å¼æ— æ•ˆ`);
                                  }
                                  // è‡³å°‘éœ€è¦idå’Œtextå­—æ®µ
                                  if (!task.id || typeof task.text !== 'string' || task.text.trim() === '') {
                                      throw new Error(`åˆ— ${col} ä¸­çš„ä»»åŠ¡ #${i+1} ç¼ºå°‘å¿…è¦çš„idæˆ–textå­—æ®µ`);
                                  }
                                  validTasksFound = true;
                              }
                          }
                      }
                      
                      // è®¡ç®—ä»»åŠ¡æ€»æ•°
                      const tasksCount = Object.values(data)
                        .filter(tasks => Array.isArray(tasks))
                        .reduce((sum, tasks) => sum + tasks.length, 0);
                      
                      if (tasksCount === 0 && !validTasksFound) {
                          alert('âš ï¸ JSONæ–‡ä»¶ä¸­æ²¡æœ‰æœ‰æ•ˆçš„ä»»åŠ¡æ•°æ®ï¼Œä»è¦å¯¼å…¥å—ï¼Ÿ');
                      }
                      
                      // æ˜¾ç¤ºå¯¼å…¥ç¡®è®¤ï¼ŒåŒ…å«ä»»åŠ¡æ•°é‡ä¿¡æ¯
                      if (confirm(`ç¡®å®šè¦å¯¼å…¥ ${tasksCount} ä¸ªä»»åŠ¡å—ï¼Ÿ\nè¿™å°†è¦†ç›–å½“å‰å‘¨çš„æ‰€æœ‰ä»»åŠ¡ã€‚`)) {
                          try {
                              // åˆ›å»ºå®‰å…¨çš„å‰¯æœ¬ï¼Œç¡®ä¿æ‰€æœ‰åˆ—éƒ½å­˜åœ¨ä¸”ä¸ºæ•°ç»„
                              const safeData = {};
                              columns.forEach(col => {
                                  safeData[col] = Array.isArray(data[col]) ? data[col] : [];
                              });
                              
                              // æ£€æŸ¥localStorageç©ºé—´
                              try {
                                  const testKey = 'import_test_key';
                                  const jsonString = JSON.stringify(safeData);
                                  localStorage.setItem(testKey, jsonString);
                                  localStorage.removeItem(testKey);
                              } catch(storageErr) {
                                  throw new Error('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œæ— æ³•å¯¼å…¥æ•°æ®');
                              }
                              
                              // ä¿å­˜åˆ°localStorage
                              localStorage.setItem(weekKey(currentWeek), JSON.stringify(safeData));
                              
                              // é‡æ–°åŠ è½½æ•°æ®
                              if (typeof loadForWeek === 'function') {
                                  loadForWeek();
                              }
                              
                              // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†å¹¶é‡ç½®æŒ‰é’®çŠ¶æ€
                              columns.forEach(col => {
                                  const input = document.getElementById(`input-${col}`);
                                  if (input) {
                                      try {
                                          input.value = '';
                                          input.dispatchEvent(new Event('input', { bubbles: true }));
                                      } catch (inputErr) {
                                          console.warn('Error resetting input:', inputErr);
                                      }
                                  }
                              });
                              
                              alert(`âœ… å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${tasksCount} ä¸ªä»»åŠ¡ã€‚`);
                          } catch (saveError) {
                              console.error('Save error:', saveError);
                              throw new Error(`ä¿å­˜æ•°æ®å¤±è´¥: ${saveError.message}`);
                          }
                      }
                  } catch (error) {
                      console.error('Import processing error:', error);
                      alert('âŒ å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                  } finally {
                      // é‡ç½®è¾“å…¥æ¡†
                      try {
                          e.target.value = '';
                      } catch (resetErr) {
                          console.warn('Error resetting file input:', resetErr);
                      }
                  }
              };
              
              // å¯åŠ¨æ–‡ä»¶è¯»å–
              try {
                  reader.readAsText(file, 'UTF-8');
              } catch (readError) {
                  console.error('Error initiating file read:', readError);
                  alert('âŒ è¯»å–æ–‡ä»¶å¤±è´¥ï¼š' + readError.message);
                  e.target.value = '';
              }
          } catch (handlerError) {
              console.error('File input handler error:', handlerError);
              alert('âŒ å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™ï¼š' + handlerError.message);
              if (e && e.target) {
                  e.target.value = '';
              }
          }
      });
      
      // âœ¨ é‡ç½®ç”¨æˆ·ä¿¡æ¯
      document.getElementById('resetProfileBtn')?.addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦é‡ç½®ä¸ªäººä¿¡æ¯å—ï¼Ÿ')) {
          localStorage.removeItem('userProfile_id');
          localStorage.removeItem('userProfile_motto');
          localStorage.removeItem('userProfile_avatar');
          loadUserProfile();
          alert('âœ… ä¸ªäººä¿¡æ¯å·²é‡ç½®ï¼');
        }
      });
      
      // âœ¨ æ¸…é™¤å¤´åƒ
      document.getElementById('clearAvatarBtn')?.addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦æ¸…é™¤å¤´åƒå—ï¼Ÿ')) {
          localStorage.removeItem('userProfile_avatar');
          document.getElementById('avatarImg').style.display = 'none';
          document.getElementById('avatarInitial').style.display = 'block';
          const userId = localStorage.getItem('userProfile_id') || 'æˆ‘çš„ä»»åŠ¡çœ‹æ¿';
          document.getElementById('avatarInitial').textContent = userId.charAt(0).toUpperCase();
          alert('âœ… å¤´åƒå·²æ¸…é™¤ï¼');
        }
      });


      // === åˆå§‹åŒ– ===
      (function(){const a=weekKey(new Date);if(!localStorage.getItem(a)){const e={planning:[{id:"seed1",text:"å†™ä¸€ä»½å‘¨è®¡åˆ’",created:(new Date).toISOString()}],todo:[{id:"seed2",text:"å­¦ä¹ æ–°çš„CSSæŠ€å·§",created:(new Date).toISOString()}],doing:[],done:[]};localStorage.setItem(a,JSON.stringify(e))}})();
      
      // âœ¨ === ç”¨æˆ·ä¸ªäººä¿¡æ¯ç®¡ç† ===
      const loadUserProfile = () => {
        const userId = localStorage.getItem('userProfile_id') || 'æˆ‘çš„ä»»åŠ¡çœ‹æ¿';
        const userMotto = localStorage.getItem('userProfile_motto') || 'ä»Šæ—¥äº‹, ä»Šæ—¥æ¯• ğŸš€';
        const userAvatar = localStorage.getItem('userProfile_avatar');
        
        document.getElementById('userIdDisplay').textContent = userId;
        document.getElementById('userMotto').textContent = userMotto;
        
        // åŠ è½½å¤´åƒ
        if (userAvatar) {
          document.getElementById('avatarImg').src = userAvatar;
          document.getElementById('avatarImg').style.display = 'block';
          document.getElementById('avatarInitial').style.display = 'none';
        } else {
          // æ˜¾ç¤ºé¦–å­—æ¯
          const initial = userId.charAt(0).toUpperCase();
          document.getElementById('avatarInitial').textContent = initial;
        }
      };
      
      // ç¼–è¾‘ç”¨æˆ·ID - å¢å¼ºç‰ˆ
      document.getElementById('editUserId')?.addEventListener('click', () => {
        try {
          const userIdDisplay = document.getElementById('userIdDisplay');
          if (!userIdDisplay) {
            console.error('userIdDisplay element not found');
            alert('âŒ é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }
          
          const currentId = userIdDisplay.textContent;
          const newId = prompt('è¯·è¾“å…¥æ‚¨çš„ç”¨æˆ·ID:', currentId);
          
          // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
          if (newId === null) return;
          
          // éªŒè¯è¾“å…¥
          if (!newId || newId.trim().length === 0) {
            alert('âŒ ç”¨æˆ·IDä¸èƒ½ä¸ºç©º');
            return;
          }
          
          const trimmedId = newId.trim();
          
          // é•¿åº¦é™åˆ¶
          if (trimmedId.length > 50) {
            alert('âŒ ç”¨æˆ·IDä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦');
            return;
          }
          
          try {
            // æ›´æ–°æ˜¾ç¤ºå’Œå­˜å‚¨
            userIdDisplay.textContent = trimmedId;
            localStorage.setItem('userProfile_id', trimmedId);
            
            // æ›´æ–°å¤´åƒé¦–å­—æ¯
            const avatarInitial = document.getElementById('avatarInitial');
            if (avatarInitial && !localStorage.getItem('userProfile_avatar')) {
              avatarInitial.textContent = trimmedId.charAt(0).toUpperCase();
            }
            
            console.log('User ID updated successfully');
          } catch (storageError) {
            console.error('Error saving user ID:', storageError);
            alert('âŒ ä¿å­˜ç”¨æˆ·IDå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            // å›æ»šæ˜¾ç¤º
            userIdDisplay.textContent = currentId;
          }
        } catch (error) {
          console.error('Error in editUserId handler:', error);
          alert('âŒ å¤„ç†ç”¨æˆ·IDç¼–è¾‘æ—¶å‡ºé”™');
        }
      });
      
      // ç¼–è¾‘æ ¼è¨€ - å¢å¼ºç‰ˆ
      document.getElementById('userMotto')?.addEventListener('click', () => {
        try {
          const userMottoElement = document.getElementById('userMotto');
          if (!userMottoElement) {
            console.error('userMotto element not found');
            alert('âŒ é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            return;
          }
          
          const currentMotto = userMottoElement.textContent;
          const newMotto = prompt('è¯·è¾“å…¥æ‚¨çš„ä¸ªäººæ ¼è¨€:', currentMotto);
          
          // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆ
          if (newMotto === null) return;
          
          const trimmedMotto = newMotto.trim();
          
          // é•¿åº¦é™åˆ¶
          if (trimmedMotto.length > 200) {
            alert('âŒ ä¸ªäººæ ¼è¨€ä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦');
            return;
          }
          
          try {
            // æ›´æ–°æ˜¾ç¤ºå’Œå­˜å‚¨
            userMottoElement.textContent = trimmedMotto || 'ä»Šæ—¥äº‹, ä»Šæ—¥æ¯• ğŸš€';
            localStorage.setItem('userProfile_motto', trimmedMotto || 'ä»Šæ—¥äº‹, ä»Šæ—¥æ¯• ğŸš€');
            
            console.log('User motto updated successfully');
          } catch (storageError) {
            console.error('Error saving user motto:', storageError);
            alert('âŒ ä¿å­˜ä¸ªäººæ ¼è¨€å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
            // å›æ»šæ˜¾ç¤º
            userMottoElement.textContent = currentMotto;
          }
        } catch (error) {
          console.error('Error in userMotto click handler:', error);
          alert('âŒ å¤„ç†ä¸ªäººæ ¼è¨€ç¼–è¾‘æ—¶å‡ºé”™');
        }
      });
      
      // ä¸Šä¼ å¤´åƒ
      document.getElementById('avatarUploadBtn').addEventListener('click', () => {
        document.getElementById('avatarInput').click();
      });
      
      document.getElementById('userAvatar').addEventListener('click', () => {
        document.getElementById('avatarInput').click();
      });
      
      document.getElementById('avatarInput')?.addEventListener('change', (e) => {
        try {
          // éªŒè¯äº‹ä»¶å¯¹è±¡
          if (!e || !e.target) {
            console.error('Invalid event object');
            return;
          }
          
          const file = e.target.files[0];
          if (!file) {
            console.warn('No file selected');
            return;
          }
          
          // éªŒè¯æ–‡ä»¶ç±»å‹
          const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
          const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
          
          const isTypeValid = file.type && validTypes.includes(file.type);
          const fileName = file.name.toLowerCase();
          const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
          
          if (!isTypeValid && !hasValidExtension) {
            alert('âŒ è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶\næ”¯æŒçš„æ ¼å¼: JPG, PNG, GIF, WebP');
            e.target.value = '';
            return;
          }
          
          // æ£€æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ 1.5MB è€ƒè™‘Base64ç¼–ç å¢å¤§)
          const maxSize = 1.5 * 1024 * 1024; // 1.5MB
          if (file.size > maxSize) {
            alert('âŒ å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡1.5MB\n(Base64ç¼–ç åçº¦ä¸º2MB)');
            e.target.value = '';
            return;
          }
          
          const reader = new FileReader();
          
          // æ·»åŠ é”™è¯¯å¤„ç†
          reader.onerror = () => {
            console.error('Error reading image file');
            alert('âŒ è¯»å–å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            e.target.value = '';
          };
          
          reader.onload = (event) => {
            try {
              // éªŒè¯äº‹ä»¶ç›®æ ‡å’Œç»“æœ
              if (!event || !event.target || !event.target.result) {
                throw new Error('æ— æ³•è¯»å–å›¾ç‰‡å†…å®¹');
              }
              
              const avatarData = event.target.result;
              
              // éªŒè¯Base64å­—ç¬¦ä¸²æ ¼å¼
              if (typeof avatarData !== 'string' || !avatarData.startsWith('data:image/')) {
                throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ•°æ®æ ¼å¼');
              }
              
              // æ£€æŸ¥localStorageæ˜¯å¦å·²æ»¡
              const testKey = 'userProfile_avatar_test';
              try {
                localStorage.setItem(testKey, avatarData);
                localStorage.removeItem(testKey);
              } catch(storageErr) {
                console.error('Storage error:', storageErr);
                alert('âŒ å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡');
                return;
              }
              
              // éªŒè¯å›¾ç‰‡å…ƒç´ å­˜åœ¨
              const avatarImg = document.getElementById('avatarImg');
              const avatarInitial = document.getElementById('avatarInitial');
              
              if (!avatarImg || !avatarInitial) {
                throw new Error('é¡µé¢å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
              }
              
              // åˆ›å»ºå›¾ç‰‡å¯¹è±¡è¿›è¡ŒäºŒæ¬¡éªŒè¯
              const img = new Image();
              img.onload = () => {
                try {
                  // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å›¾ç‰‡å°ºå¯¸éªŒè¯
                  if (img.width < 50 || img.height < 50) {
                    alert('âš ï¸ å›¾ç‰‡å°ºå¯¸è¿‡å°ï¼Œå¯èƒ½æ˜¾ç¤ºæ•ˆæœä¸ä½³');
                  }
                  
                  // æ›´æ–°UIå’Œä¿å­˜æ•°æ®
                  avatarImg.src = avatarData;
                  avatarImg.style.display = 'block';
                  avatarInitial.style.display = 'none';
                  
                  try {
                    localStorage.setItem('userProfile_avatar', avatarData);
                    alert('âœ… å¤´åƒä¸Šä¼ æˆåŠŸï¼');
                  } catch (saveErr) {
                    console.error('Error saving avatar to localStorage:', saveErr);
                    alert('âŒ ä¿å­˜å¤´åƒå¤±è´¥ï¼šå­˜å‚¨ç©ºé—´ä¸è¶³');
                    // å›æ»šUIå˜åŒ–
                    avatarImg.style.display = 'none';
                    const userId = localStorage.getItem('userProfile_id') || 'æˆ‘çš„ä»»åŠ¡çœ‹æ¿';
                    avatarInitial.textContent = userId.charAt(0).toUpperCase();
                    avatarInitial.style.display = 'block';
                  }
                } catch (imgProcessError) {
                  console.error('Image processing error:', imgProcessError);
                  alert('âŒ å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™ï¼š' + imgProcessError.message);
                }
              };
              
              img.onerror = () => {
                console.error('Invalid image data');
                alert('âŒ æ— æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼Œè¯·é€‰æ‹©å…¶ä»–å›¾ç‰‡');
              };
              
              // åŠ è½½å›¾ç‰‡è¿›è¡ŒéªŒè¯
              img.src = avatarData;
            } catch (error) {
              console.error('Avatar upload processing error:', error);
              alert('âŒ å¤´åƒä¸Šä¼ å¤±è´¥ï¼š' + error.message);
            } finally {
              // é‡ç½®è¾“å…¥æ¡†
              try {
                e.target.value = '';
              } catch (resetErr) {
                console.warn('Error resetting file input:', resetErr);
              }
            }
          };
          
          // å¯åŠ¨æ–‡ä»¶è¯»å–
          try {
            reader.readAsDataURL(file);
          } catch (readError) {
            console.error('Error initiating file read:', readError);
            alert('âŒ è¯»å–å›¾ç‰‡å¤±è´¥ï¼š' + readError.message);
            e.target.value = '';
          }
        } catch (handlerError) {
          console.error('File input handler error:', handlerError);
          alert('âŒ å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™ï¼š' + handlerError.message);
          if (e && e.target) {
            e.target.value = '';
          }
        }
      });
      
      loadUserProfile();
      initEventListeners();
      loadForWeek();
      startClock();
      updateCurrentDate();
      
      // ç©ºçŠ¶æ€æ£€æŸ¥ - ä¼˜åŒ–ç‰ˆ
      const checkEmptyStates=()=>{
        columns.forEach(col=>{
          const list=document.getElementById(col+'List');
          if(!list) return;
          
          const tasks=list.querySelectorAll('.task');
          const emptyStateElem=list.querySelector('.empty-state');
          const isEmpty=tasks.length===0;
          
          if(isEmpty){
            // åˆ—ä¸ºç©ºæ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºç©ºçŠ¶æ€
            if(!emptyStateElem){
              // å…ˆä¿å­˜æ‰€æœ‰éä»»åŠ¡å…ƒç´ ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
              const nonTaskElements=[];
              Array.from(list.children).forEach(child=>{
                if(!child.classList.contains('task')){
                  nonTaskElements.push(child);
                }
              });
              
              // æ¸…ç©ºåˆ—è¡¨
              list.innerHTML='';
              
              // æ·»åŠ ç©ºçŠ¶æ€å…ƒç´ 
              const emptyState=document.createElement('div');
              emptyState.className='empty-state';
              emptyState.innerHTML='<div class="empty-state-icon">âœ¨</div><div class="empty-state-text">è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ å§ï¼</div>';
              list.appendChild(emptyState);
              
              // é‡æ–°æ·»åŠ éä»»åŠ¡å…ƒç´ 
              nonTaskElements.forEach(el=>list.appendChild(el));
            }
          }else{
            // åˆ—ä¸ä¸ºç©ºæ—¶ï¼Œç§»é™¤ç©ºçŠ¶æ€å…ƒç´ 
            if(emptyStateElem){
              emptyStateElem.remove();
            }
          }
        });
      };
      
      // å¿«æ·é”®æ”¯æŒ
      const showKeyboardHint=()=>{const hint=document.getElementById('keyboardHint');hint.classList.add('show');setTimeout(()=>hint.classList.remove('show'),2000)};
      document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.key==='k'){e.preventDefault();document.getElementById('searchInput').focus();showKeyboardHint();}if(e.ctrlKey&&e.key==='s'){e.preventDefault();document.getElementById('statsBtn').click();showKeyboardHint();}});
      
      // æ¯å¤©å‡Œæ™¨æ›´æ–°æ—¥æœŸ
      setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
          updateCurrentDate();
        }
      }, 60000);
    });
  </script>
</body>
</html>