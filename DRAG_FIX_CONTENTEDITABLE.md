# æ‹–æ‹½åŠŸèƒ½ä¿®å¤ï¼šè§£å†³ contentEditable å†²çªé—®é¢˜

## ğŸ“‹ é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šä»»åŠ¡æ¡ç›®ä¹‹é—´æ— æ³•æ‹–æ‹½ï¼Œé¼ æ ‡æ— æ³•å°†ä»»åŠ¡æ”¾ç½®åˆ°ä»»æ„çª—æ ¼

**ç”¨æˆ·åé¦ˆ**ï¼š"æ¡ç›®ä¹‹é—´çš„ä¿¡æ¯æ— æ³•æ‹–æ‹½"

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

ç»è¿‡æ·±å…¥æ’æŸ¥ï¼Œå‘ç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

### 1. contentEditable ä¸ draggable å±æ€§å†²çª

**ä»£ç ä½ç½®**ï¼š`src/modules/weekPlan.ts` ç¬¬ 660-664 è¡Œ

```typescript
const content = this.panelDoc.createElement("div");
content.className = "zoteroplan-task-content";
content.textContent = taskData.text || "";
content.contentEditable = "true"; // âŒ è¿™é‡Œå¯¼è‡´äº†é—®é¢˜
```

**é—®é¢˜è¯¦è§£**ï¼š

- ä»»åŠ¡å¡ç‰‡ï¼ˆ`.zoteroplan-task`ï¼‰è®¾ç½®äº† `draggable = true`
- ä½†å…¶å­å…ƒç´ ï¼ˆ`.zoteroplan-task-content`ï¼‰è®¾ç½®äº† `contentEditable = "true"`
- å½“ç”¨æˆ·å°è¯•æ‹–æ‹½ä»»åŠ¡æ—¶ï¼Œé¼ æ ‡ç‚¹å‡»çš„åŒºåŸŸé€šå¸¸æ˜¯å†…å®¹ç¼–è¾‘åŒºåŸŸ
- **contentEditable å…ƒç´ ä¼šæ‹¦æˆªé¼ æ ‡äº‹ä»¶**ï¼Œå¯¼è‡´çˆ¶å…ƒç´ çš„ `dragstart` äº‹ä»¶æ— æ³•è§¦å‘
- æµè§ˆå™¨ä¼˜å…ˆå¤„ç†å†…å®¹ç¼–è¾‘ï¼Œè€Œéæ‹–æ‹½æ“ä½œ

### 2. äº‹ä»¶å†’æ³¡é“¾è¢«ä¸­æ–­

```
ç”¨æˆ·ç‚¹å‡»ä»»åŠ¡å¡ç‰‡
  â†“
é¼ æ ‡å®é™…ç‚¹å‡»åœ¨ .zoteroplan-task-content ä¸Š
  â†“
contentEditable å…ƒç´ æ‹¦æˆªäº† mousedown äº‹ä»¶
  â†“
dragstart äº‹ä»¶æ²¡æœ‰è¢«è§¦å‘
  â†“
æ‹–æ‹½åŠŸèƒ½å¤±æ•ˆ âŒ
```

### 3. CSS ç¼ºå°‘å¿…è¦çš„æ ·å¼

- ä»»åŠ¡å…ƒç´ ç¼ºå°‘ `user-select: none`ï¼Œå¯¼è‡´æ‹–æ‹½æ—¶å¯èƒ½é€‰ä¸­æ–‡æœ¬
- å†…å®¹ç¼–è¾‘åŒºåŸŸç¼ºå°‘ `cursor: text`ï¼Œç”¨æˆ·ä½“éªŒä¸å¤Ÿæ˜ç¡®
- ç¼ºå°‘ `cursor: grabbing` çŠ¶æ€ï¼Œæ‹–æ‹½æ—¶æ²¡æœ‰è§†è§‰åé¦ˆ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1ï¼šé˜»æ­¢å†…å®¹ç¼–è¾‘åŒºåŸŸè§¦å‘æ‹–æ‹½

**æ–‡ä»¶**ï¼š`src/modules/weekPlan.ts`

**ä½ç½®**ï¼š`renderTask()` æ–¹æ³•ï¼Œç¬¬ 660-675 è¡Œ

```typescript
// ä»»åŠ¡å†…å®¹
const content = this.panelDoc.createElement("div");
content.className = "zoteroplan-task-content";
content.textContent = taskData.text || "";
content.contentEditable = "true";
content.addEventListener("blur", () => this.saveForWeek());

// é˜»æ­¢å†…å®¹ç¼–è¾‘åŒºåŸŸè§¦å‘æ‹–æ‹½ - å…³é”®ä¿®å¤ï¼
content.addEventListener("mousedown", (e: Event) => {
  e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°ä»»åŠ¡å…ƒç´ 
});

content.addEventListener("dragstart", (e: Event) => {
  e.preventDefault(); // é˜»æ­¢å†…å®¹åŒºåŸŸçš„æ‹–æ‹½
  e.stopPropagation();
});
```

**åŸç†è¯´æ˜**ï¼š

1. **`mousedown` äº‹ä»¶é˜»æ­¢å†’æ³¡**
   - å½“ç”¨æˆ·åœ¨å†…å®¹åŒºåŸŸç‚¹å‡»æ—¶ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°ä»»åŠ¡å…ƒç´ 
   - è¿™æ ·å†…å®¹åŒºåŸŸå¯ä»¥æ­£å¸¸è¿›å…¥ç¼–è¾‘æ¨¡å¼
   - ä½†ä¸ä¼šå¹²æ‰°ä»»åŠ¡å…ƒç´ çš„æ‹–æ‹½åŠŸèƒ½

2. **`dragstart` äº‹ä»¶é˜»æ­¢å’Œåœæ­¢ä¼ æ’­**
   - å¦‚æœç”¨æˆ·åœ¨å†…å®¹åŒºåŸŸå°è¯•æ‹–æ‹½ï¼Œé˜»æ­¢è¯¥åŒºåŸŸçš„æ‹–æ‹½è¡Œä¸º
   - é˜²æ­¢å†…å®¹è¢«æ‹–æ‹½è€Œéæ•´ä¸ªä»»åŠ¡å¡ç‰‡

### ä¿®å¤ 2ï¼šä¼˜åŒ–ä»»åŠ¡å¡ç‰‡çš„ CSS æ ·å¼

**æ–‡ä»¶**ï¼š`addon/content/weekPlan.css`

**ä¿®æ”¹ 1**ï¼šä»»åŠ¡å¡ç‰‡æ·»åŠ  `user-select: none`

```css
.zoteroplan-task {
  background: var(--wp-card-bg);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid var(--wp-border-color);
  cursor: grab;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  user-select: none; /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡æœ¬ */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
```

**ä¿®æ”¹ 2**ï¼šå†…å®¹ç¼–è¾‘åŒºåŸŸæ·»åŠ ç‰¹å®šæ ·å¼

```css
.zoteroplan-task-content {
  padding: 2px 4px;
  outline: none;
  word-wrap: break-word;
  line-height: 1.5;
  font-size: 14px;
  cursor: text; /* ç¼–è¾‘åŒºåŸŸæ˜¾ç¤ºæ–‡æœ¬å…‰æ ‡ */
  user-select: text; /* å…è®¸é€‰æ‹©æ–‡æœ¬ */
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
}
```

**ä¿®æ”¹ 3**ï¼šæ·»åŠ æ‹–æ‹½æ—¶çš„å…‰æ ‡åé¦ˆ

```css
.zoteroplan-task:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
  border-color: var(--wp-accent);
}

.zoteroplan-task:active {
  cursor: grabbing; /* æ‹–æ‹½æ—¶æ˜¾ç¤ºæŠ“å–å…‰æ ‡ */
}
```

---

## ğŸ¯ å…³é”®æŠ€æœ¯ç‚¹

### 1. äº‹ä»¶å§”æ‰˜æœºåˆ¶

æ‹–æ‹½äº‹ä»¶å·²åœ¨ `board` å…ƒç´ ä¸Šç»Ÿä¸€ç»‘å®šï¼Œä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†ï¼š

```typescript
board.addEventListener("dragstart", (e: Event) => {
  const target = e.target as HTMLElement;
  if (!target || !target.classList.contains("zoteroplan-task")) {
    return;
  }
  // å¤„ç†æ‹–æ‹½...
});
```

### 2. åˆ†å±‚äº‹ä»¶å¤„ç†

- **ä»»åŠ¡å…ƒç´ å±‚**ï¼š`draggable = true`ï¼Œå¤„ç†æ‹–æ‹½
- **å†…å®¹ç¼–è¾‘å±‚**ï¼š`contentEditable = true`ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡
- **ä¸¤å±‚ç‹¬ç«‹å·¥ä½œ**ï¼Œäº’ä¸å¹²æ‰°

### 3. CSS é€‰æ‹©å™¨ä¼˜å…ˆçº§

```
.zoteroplan-task { user-select: none; }  â† çˆ¶å…ƒç´ ç¦æ­¢é€‰æ‹©
.zoteroplan-task-content { user-select: text; }  â† å­å…ƒç´ å…è®¸é€‰æ‹©
```

å­å…ƒç´ çš„ `user-select: text` ä¼šè¦†ç›–çˆ¶å…ƒç´ çš„ `user-select: none`

---

## ğŸ“Š ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### æ‹–æ‹½æ“ä½œæµç¨‹

1. **æ‚¬åœçŠ¶æ€**
   - é¼ æ ‡æ‚¬åœåœ¨ä»»åŠ¡å¡ç‰‡ä¸Š
   - `cursor: grab`ï¼ˆæ‰‹å½¢å…‰æ ‡ï¼‰
   - ä»»åŠ¡å¡ç‰‡è½»å¾®ä¸Šæµ®ï¼ˆ`translateY(-2px)`ï¼‰

2. **ç‚¹å‡»æ‹–æ‹½**
   - ç‚¹å‡»ä»»åŠ¡å¡ç‰‡çš„ç©ºç™½åŒºåŸŸï¼ˆéå†…å®¹ç¼–è¾‘åŒºåŸŸï¼‰
   - `cursor: grabbing`ï¼ˆæŠ“å–å…‰æ ‡ï¼‰
   - ä»»åŠ¡å¡ç‰‡æ·»åŠ  `.dragging` ç±»ï¼ŒåŠé€æ˜æ˜¾ç¤º

3. **ç¼–è¾‘å†…å®¹**
   - ç‚¹å‡»ä»»åŠ¡å†…å®¹åŒºåŸŸ
   - `cursor: text`ï¼ˆæ–‡æœ¬å…‰æ ‡ï¼‰
   - å†…å®¹åŒºåŸŸè·å¾—ç„¦ç‚¹ï¼Œå¯ä»¥ç¼–è¾‘

4. **æ‹–æ‹½æ”¾ç½®**
   - æ‹–æ‹½åˆ°ç›®æ ‡åˆ—
   - æ˜¾ç¤ºè“è‰²è™šçº¿æ”¾ç½®æŒ‡ç¤ºå™¨
   - æ¾å¼€é¼ æ ‡ï¼Œä»»åŠ¡ç§»åŠ¨åˆ°æ–°ä½ç½®

---

## ğŸ§ª æµ‹è¯•æ¸…å•

### âœ… åŸºç¡€åŠŸèƒ½æµ‹è¯•

- [ ] ä»»åŠ¡å¯ä»¥åœ¨åŒä¸€åˆ—å†…æ‹–æ‹½æ’åº
- [ ] ä»»åŠ¡å¯ä»¥åœ¨ä¸åŒåˆ—ä¹‹é—´æ‹–æ‹½
- [ ] æ‹–æ‹½æ—¶æ˜¾ç¤ºæ”¾ç½®æŒ‡ç¤ºå™¨
- [ ] æ‹–æ‹½åä»»åŠ¡ä½ç½®æ­£ç¡®
- [ ] æ‹–æ‹½åæ•°æ®è‡ªåŠ¨ä¿å­˜

### âœ… ç¼–è¾‘åŠŸèƒ½æµ‹è¯•

- [ ] ç‚¹å‡»ä»»åŠ¡å†…å®¹å¯ä»¥è¿›å…¥ç¼–è¾‘æ¨¡å¼
- [ ] ç¼–è¾‘æ—¶å…‰æ ‡ä¸ºæ–‡æœ¬å…‰æ ‡ï¼ˆ`cursor: text`ï¼‰
- [ ] ç¼–è¾‘å®Œæˆå¤±ç„¦åè‡ªåŠ¨ä¿å­˜
- [ ] ç¼–è¾‘æ—¶ä¸ä¼šè§¦å‘æ‹–æ‹½

### âœ… è§†è§‰åé¦ˆæµ‹è¯•

- [ ] æ‚¬åœæ—¶æ˜¾ç¤º `grab` å…‰æ ‡
- [ ] æ‹–æ‹½æ—¶æ˜¾ç¤º `grabbing` å…‰æ ‡
- [ ] ç¼–è¾‘æ—¶æ˜¾ç¤º `text` å…‰æ ‡
- [ ] æ‹–æ‹½æ—¶ä»»åŠ¡å¡ç‰‡åŠé€æ˜
- [ ] æ”¾ç½®æŒ‡ç¤ºå™¨è“è‰²è™šçº¿æ˜¾ç¤ºæ­£ç¡®

### âœ… è¾¹ç•Œæƒ…å†µæµ‹è¯•

- [ ] ç©ºåˆ—è¡¨å¯ä»¥æ¥æ”¶æ‹–æ‹½çš„ä»»åŠ¡
- [ ] æ‹–æ‹½åˆ°åˆ—è¡¨é¡¶éƒ¨æ­£ç¡®æ’å…¥
- [ ] æ‹–æ‹½åˆ°åˆ—è¡¨åº•éƒ¨æ­£ç¡®æ’å…¥
- [ ] å¿«é€Ÿæ‹–æ‹½ä¸ä¼šå‡ºç°é”™è¯¯
- [ ] åŒæ—¶ç¼–è¾‘å’Œæ‹–æ‹½ä¸ä¼šå†²çª

---

## ğŸ”§ å¦‚ä½•éªŒè¯ä¿®å¤

### æ­¥éª¤ 1ï¼šé‡æ–°æ„å»ºæ’ä»¶

```bash
npm run build
```

### æ­¥éª¤ 2ï¼šåœ¨ Zotero ä¸­é‡æ–°åŠ è½½æ’ä»¶

1. æ‰“å¼€ Zotero
2. å·¥å…· â†’ æ’ä»¶ â†’ é½¿è½®å›¾æ ‡ â†’ Install Plugin From File
3. é€‰æ‹© `.scaffold/build/zotero-plan.xpi`
4. é‡å¯ Zotero

### æ­¥éª¤ 3ï¼šæ‰“å¼€å‘¨è®¡åˆ’çª—å£

- ç‚¹å‡»æ’ä»¶èœå• â†’ Weekly Plan

### æ­¥éª¤ 4ï¼šæµ‹è¯•æ‹–æ‹½åŠŸèƒ½

1. **åˆ›å»ºå‡ ä¸ªæµ‹è¯•ä»»åŠ¡**
   - åœ¨"è§„åˆ’"åˆ—æ·»åŠ ä»»åŠ¡ 1ã€2ã€3
   - åœ¨"å¾…åš"åˆ—æ·»åŠ ä»»åŠ¡ 4ã€5

2. **æµ‹è¯•åŒåˆ—æ‹–æ‹½**
   - æ‹–æ‹½ä»»åŠ¡ 1 åˆ°ä»»åŠ¡ 3 ä¸‹æ–¹
   - éªŒè¯é¡ºåºå˜ä¸ºï¼š2ã€3ã€1

3. **æµ‹è¯•è·¨åˆ—æ‹–æ‹½**
   - æ‹–æ‹½ä»»åŠ¡ 1 åˆ°"å¾…åš"åˆ—
   - éªŒè¯ä»»åŠ¡æ­£ç¡®ç§»åŠ¨åˆ°"å¾…åš"

4. **æµ‹è¯•ç¼–è¾‘åŠŸèƒ½**
   - ç‚¹å‡»ä»»åŠ¡ 1 çš„æ–‡æœ¬å†…å®¹
   - éªŒè¯å¯ä»¥æ­£å¸¸ç¼–è¾‘
   - éªŒè¯ç¼–è¾‘æ—¶ä¸ä¼šè§¦å‘æ‹–æ‹½

5. **æµ‹è¯•è§†è§‰åé¦ˆ**
   - æ‚¬åœåœ¨ä»»åŠ¡ä¸Šï¼ŒéªŒè¯ `grab` å…‰æ ‡
   - æ‹–æ‹½ä»»åŠ¡ï¼ŒéªŒè¯ `grabbing` å…‰æ ‡
   - ç‚¹å‡»å†…å®¹ï¼ŒéªŒè¯ `text` å…‰æ ‡

### æ­¥éª¤ 5ï¼šæŸ¥çœ‹è°ƒè¯•æ—¥å¿—ï¼ˆå¯é€‰ï¼‰

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹æ‹–æ‹½ç›¸å…³æ—¥å¿—ï¼š

```
å¼€å§‹åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
å¼€å§‹æ‹–æ‹½ä»»åŠ¡: task_1234567890_abc123
æ”¾ç½®åˆ°åˆ—è¡¨: zoteroplan-todoList
æ”¾ç½®æˆåŠŸ
æ‹–æ‹½ç»“æŸ
```

---

## ğŸ“ æŠ€æœ¯æ€»ç»“

### é—®é¢˜çš„æœ¬è´¨

**HTML5 Drag and Drop API** ä¸ **contentEditable** åœ¨åŒä¸€ DOM æ ‘ä¸­ä¼šäº§ç”Ÿäº‹ä»¶å†²çªã€‚

### è§£å†³çš„æ ¸å¿ƒæ€è·¯

1. **åˆ†å±‚å¤„ç†**ï¼šçˆ¶å…ƒç´ è´Ÿè´£æ‹–æ‹½ï¼Œå­å…ƒç´ è´Ÿè´£ç¼–è¾‘
2. **äº‹ä»¶éš”ç¦»**ï¼šå­å…ƒç´ é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…å¹²æ‰°çˆ¶å…ƒç´ 
3. **CSS è¦†ç›–**ï¼šå­å…ƒç´ çš„ `user-select` è¦†ç›–çˆ¶å…ƒç´ çš„è®¾ç½®

### ç±»ä¼¼é—®é¢˜çš„é€šç”¨è§£å†³æ–¹æ¡ˆ

å¦‚æœä½ çš„é¡¹ç›®ä¸­æœ‰ç±»ä¼¼é—®é¢˜ï¼ˆå¯æ‹–æ‹½å…ƒç´ åŒ…å«å¯ç¼–è¾‘å†…å®¹ï¼‰ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹æ¨¡å¼ï¼š

```typescript
// çˆ¶å…ƒç´ ï¼šå¯æ‹–æ‹½
parentElement.draggable = true;

// å­å…ƒç´ ï¼šå¯ç¼–è¾‘ï¼Œä½†é˜»æ­¢æ‹–æ‹½äº‹ä»¶å†’æ³¡
editableChild.contentEditable = "true";
editableChild.addEventListener("mousedown", (e) => {
  e.stopPropagation(); // å…³é”®ï¼
});
editableChild.addEventListener("dragstart", (e) => {
  e.preventDefault();
  e.stopPropagation();
});
```

```css
/* çˆ¶å…ƒç´ ï¼šç¦æ­¢æ–‡æœ¬é€‰æ‹© */
.parent {
  user-select: none;
  cursor: grab;
}

/* å­å…ƒç´ ï¼šå…è®¸æ–‡æœ¬é€‰æ‹© */
.editable-child {
  user-select: text;
  cursor: text;
}
```

---

## ğŸ‰ ä¿®å¤ç»“æœ

âœ… **ä»»åŠ¡å¡ç‰‡å¯ä»¥æ­£å¸¸æ‹–æ‹½**  
âœ… **ä»»åŠ¡å†…å®¹å¯ä»¥æ­£å¸¸ç¼–è¾‘**  
âœ… **æ‹–æ‹½å’Œç¼–è¾‘äº’ä¸å¹²æ‰°**  
âœ… **è§†è§‰åé¦ˆæ¸…æ™°æ˜ç¡®**  
âœ… **ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡**

---

## ğŸ“š ç›¸å…³èµ„æº

- [MDN: HTML Drag and Drop API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API)
- [MDN: contentEditable](https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/contenteditable)
- [MDN: Event.stopPropagation()](https://developer.mozilla.org/en-US/docs/Web/API/Event/stopPropagation)
- [CSS user-select](https://developer.mozilla.org/en-US/docs/Web/CSS/user-select)

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025-10-17  
**ç‰ˆæœ¬**ï¼š1.0.0  
**å¼€å‘è€…**ï¼šZotero Weekly Plan Team
