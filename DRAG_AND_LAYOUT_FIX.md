# æ‹–æ‹½åŠŸèƒ½ä¸å¸ƒå±€ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

1. **å¸ƒå±€é—®é¢˜**: å››ä¸ªæ ç›®ï¼ˆè§„åˆ’ã€å¾…åšã€æ­£åœ¨åšã€å®Œæˆï¼‰æ²¡æœ‰æ­£ç¡®æ’åˆ—åœ¨ä¸€è¡Œ
2. **æ‹–æ‹½é—®é¢˜**: ä»»åŠ¡æ¡ç›®æ— æ³•æ­£å¸¸æ‹–æ‹½åˆ°ä»»æ„çª—æ ¼

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. å¸ƒå±€ä¿®å¤

#### é—®é¢˜åŸå› 

åŸæ¥ä½¿ç”¨ `grid` å¸ƒå±€ï¼Œä½†åœ¨å¯¹è¯æ¡†çª—å£ä¸­å¯èƒ½ä¼šå‡ºç°æ¢è¡Œé—®é¢˜ã€‚

#### è§£å†³æ–¹æ¡ˆ

æ”¹ç”¨ `flexbox` å¸ƒå±€ï¼Œç¡®ä¿å››åˆ—å§‹ç»ˆåœ¨ä¸€è¡Œæ˜¾ç¤ºã€‚

**ä¿®æ”¹æ–‡ä»¶**: `addon/content/weekPlan.css`

```css
/* ä¿®æ”¹å‰ - Grid å¸ƒå±€ */
.zoteroplan-board {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  flex: 1;
  overflow: visible;
  margin-bottom: 20px;
}

/* ä¿®æ”¹å - Flexbox å¸ƒå±€ */
.zoteroplan-board {
  display: flex;
  flex-direction: row; /* å¼ºåˆ¶æ¨ªå‘æ’åˆ— */
  gap: 16px;
  width: 100%;
  height: auto;
  min-height: 500px;
  margin-bottom: 20px;
  overflow-x: auto; /* æ¨ªå‘æ»šåŠ¨ */
  overflow-y: visible;
}
```

**åˆ—å®½è°ƒæ•´**:

```css
.zoteroplan-column {
  min-width: 280px; /* æœ€å°å®½åº¦ */
  flex: 1; /* å¹³å‡åˆ†é…ç©ºé—´ */
  /* ... å…¶ä»–æ ·å¼ ... */
}
```

**ä¼˜åŠ¿**:

- âœ… å››åˆ—å§‹ç»ˆåœ¨ä¸€è¡Œ
- âœ… è‡ªåŠ¨é€‚åº”çª—å£å®½åº¦
- âœ… çª—å£è¿‡çª„æ—¶å¯ä»¥æ¨ªå‘æ»šåŠ¨
- âœ… æ¯åˆ—å¹³å‡åˆ†é…ç©ºé—´

---

### 2. æ‹–æ‹½åŠŸèƒ½å¢å¼º

#### é—®é¢˜åŸå› 

1. ä½¿ç”¨ `closest()` æ–¹æ³•åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½æ‰¾ä¸åˆ°ç›®æ ‡å…ƒç´ 
2. ç¼ºå°‘è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
3. äº‹ä»¶å¯èƒ½åœ¨å¯¹è¯æ¡†çª—å£ä¸­è¢«é˜»æ­¢

#### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**: `src/modules/weekPlan.ts`

##### æ”¹è¿› 1: å¢å¼ºç›®æ ‡å…ƒç´ æŸ¥æ‰¾é€»è¾‘

```typescript
// ä¿®æ”¹å‰ - ä½¿ç”¨ closest()
const targetList = (e.target as Element)?.closest(
  ".zoteroplan-col-list",
) as HTMLElement | null;

// ä¿®æ”¹å - ä½¿ç”¨ while å¾ªç¯å‘ä¸ŠæŸ¥æ‰¾
let targetList: HTMLElement | null = null;
let target = e.target as Element;

while (target && target !== board) {
  if (target.classList && target.classList.contains("zoteroplan-col-list")) {
    targetList = target as HTMLElement;
    break;
  }
  target = target.parentElement as Element;
}
```

**ä¼˜åŠ¿**:

- âœ… æ›´å¯é çš„å…ƒç´ æŸ¥æ‰¾
- âœ… é¿å… `closest()` åœ¨æŸäº›æµè§ˆå™¨ä¸­çš„å…¼å®¹æ€§é—®é¢˜
- âœ… æ˜ç¡®çš„æŸ¥æ‰¾è¾¹ç•Œï¼ˆä¸è¶…è¿‡ board å…ƒç´ ï¼‰

##### æ”¹è¿› 2: æ·»åŠ è¯¦ç»†æ—¥å¿—

```typescript
// æ‹–æ‹½å¼€å§‹
ztoolkit.log("å¼€å§‹æ‹–æ‹½ä»»åŠ¡:", draggedEl.dataset.id);

// æ‹–æ‹½ç»“æŸ
ztoolkit.log("æ‹–æ‹½ç»“æŸ");

// æ”¾ç½®æ“ä½œ
ztoolkit.log("æ‰§è¡Œæ”¾ç½®æ“ä½œ");
ztoolkit.log("æ”¾ç½®åˆ°åˆ—è¡¨:", targetList.id);
ztoolkit.log("æ”¾ç½®æˆåŠŸ");
```

**ä¼˜åŠ¿**:

- âœ… ä¾¿äºè°ƒè¯•é—®é¢˜
- âœ… è¿½è¸ªæ‹–æ‹½æµç¨‹
- âœ… å¿«é€Ÿå®šä½é”™è¯¯

##### æ”¹è¿› 3: å¢å¼ºé”™è¯¯æ£€æŸ¥

```typescript
if (!board) {
  ztoolkit.log("æ‰¾ä¸åˆ°çœ‹æ¿å…ƒç´ ");
  return;
}

if (!draggedEl) {
  ztoolkit.log("æ²¡æœ‰æ‹–æ‹½å…ƒç´ ");
  return;
}

if (!targetList) {
  ztoolkit.log("æ‰¾ä¸åˆ°ç›®æ ‡åˆ—è¡¨");
  return;
}
```

---

## ğŸ“Š ä»£ç å˜æ›´å¯¹æ¯”

### CSS å˜æ›´

| å±æ€§                    | ä¿®æ”¹å‰           | ä¿®æ”¹å             | è¯´æ˜           |
| ----------------------- | ---------------- | ------------------ | -------------- |
| `display`               | `grid`           | `flex`             | æ”¹ç”¨ flexbox   |
| `flex-direction`        | -                | `row`              | å¼ºåˆ¶æ¨ªå‘       |
| `grid-template-columns` | `repeat(4, 1fr)` | -                  | ç§»é™¤ grid é…ç½® |
| `overflow`              | `visible`        | `overflow-x: auto` | æ”¯æŒæ¨ªå‘æ»šåŠ¨   |
| åˆ— `min-width`          | -                | `280px`            | ç¡®ä¿æœ€å°å®½åº¦   |
| åˆ— `flex`               | -                | `1`                | å¹³å‡åˆ†é…ç©ºé—´   |

### TypeScript å˜æ›´

| æ”¹è¿›é¡¹       | è¡Œæ•°å˜åŒ–   | è¯´æ˜            |
| ------------ | ---------- | --------------- |
| å…ƒç´ æŸ¥æ‰¾é€»è¾‘ | +8         | æ”¹ç”¨ while å¾ªç¯ |
| æ—¥å¿—è¾“å‡º     | +6         | æ·»åŠ è°ƒè¯•ä¿¡æ¯    |
| é”™è¯¯æ£€æŸ¥     | +3         | å¢å¼ºé”™è¯¯å¤„ç†    |
| **æ€»è®¡**     | **+17 è¡Œ** | ä»£ç æ›´å¥å£®      |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ¸…å•

#### å¸ƒå±€æµ‹è¯•

- [ ] å››åˆ—æ˜¯å¦æ­£ç¡®æ¨ªå‘æ’åˆ—
- [ ] çª—å£ç¼©å°æ—¶æ˜¯å¦å‡ºç°æ¨ªå‘æ»šåŠ¨æ¡
- [ ] æ¯åˆ—å®½åº¦æ˜¯å¦å¹³å‡åˆ†é…
- [ ] åˆ—ä¸åˆ—ä¹‹é—´é—´è·æ˜¯å¦æ­£ç¡®ï¼ˆ16pxï¼‰

#### æ‹–æ‹½æµ‹è¯•

**åŸºæœ¬æ‹–æ‹½**:

- [ ] å¯ä»¥æ‹–åŠ¨ä»»åŠ¡å¡ç‰‡
- [ ] æ‹–åŠ¨æ—¶æ˜¾ç¤º `dragging` æ ·å¼
- [ ] æ”¾ç½®æŒ‡ç¤ºå™¨æ­£ç¡®æ˜¾ç¤º

**è·¨åˆ—æ‹–æ‹½**:

- [ ] è§„åˆ’ â†’ å¾…åš
- [ ] å¾…åš â†’ æ­£åœ¨åš
- [ ] æ­£åœ¨åš â†’ å®Œæˆ
- [ ] å®Œæˆ â†’ è§„åˆ’ï¼ˆåå‘ï¼‰

**åˆ—å†…æ’åº**:

- [ ] åŒä¸€åˆ—å†…å¯ä»¥ä¸Šä¸‹ç§»åŠ¨
- [ ] ç§»åŠ¨åˆ°é¡¶éƒ¨
- [ ] ç§»åŠ¨åˆ°åº•éƒ¨
- [ ] ç§»åŠ¨åˆ°ä¸­é—´ä½ç½®

**ç©ºåˆ—è¡¨**:

- [ ] å¯ä»¥æ‹–æ‹½åˆ°ç©ºåˆ—è¡¨
- [ ] ç©ºåˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®æç¤º
- [ ] æ‹–èµ°æœ€åä¸€ä¸ªä»»åŠ¡åæ˜¾ç¤ºç©ºçŠ¶æ€

**è¾¹ç•Œæƒ…å†µ**:

- [ ] æ‹–æ‹½åˆ°åˆ—è¡¨é¡¶éƒ¨åŒºåŸŸï¼ˆ15%ï¼‰
- [ ] æ‹–æ‹½åˆ°åˆ—è¡¨åº•éƒ¨åŒºåŸŸï¼ˆ5%ï¼‰
- [ ] æ‹–æ‹½åˆ°ä»»åŠ¡ä¹‹é—´
- [ ] å¿«é€Ÿè¿ç»­æ‹–æ‹½

---

## ğŸ” è°ƒè¯•æŒ‡å—

### æŸ¥çœ‹æ‹–æ‹½æ—¥å¿—

1. æ‰“å¼€ Zotero å¼€å‘è€…å·¥å…·
   - Windows/Linux: `Ctrl + Shift + I`
   - macOS: `Cmd + Option + I`

2. åˆ‡æ¢åˆ° Console æ ‡ç­¾

3. æ‹–åŠ¨ä»»åŠ¡æ—¶è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š

```
å¼€å§‹åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
å¼€å§‹æ‹–æ‹½ä»»åŠ¡: task_1234567890
æ‰§è¡Œæ”¾ç½®æ“ä½œ
æ”¾ç½®åˆ°åˆ—è¡¨: zoteroplan-todoList
æ”¾ç½®æˆåŠŸ
æ‹–æ‹½ç»“æŸ
```

### å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ï¼šæ‹–æ‹½æ—¶æ²¡æœ‰ååº”

**æ£€æŸ¥**:

1. æŸ¥çœ‹æ˜¯å¦æœ‰æ—¥å¿—è¾“å‡º
2. ç¡®è®¤ `dragging` class æ˜¯å¦è¢«æ·»åŠ 
3. æ£€æŸ¥æ˜¯å¦è§¦å‘ `dragstart` äº‹ä»¶

**å¯èƒ½åŸå› **:

- ä»»åŠ¡å…ƒç´ æ²¡æœ‰ `draggable="true"` å±æ€§
- äº‹ä»¶ç›‘å¬å™¨æ²¡æœ‰æ­£ç¡®ç»‘å®š

#### é—®é¢˜ï¼šæ— æ³•æ”¾ç½®åˆ°ç›®æ ‡åˆ—è¡¨

**æ£€æŸ¥**:

1. æ˜¯å¦è¾“å‡º"æ‰¾ä¸åˆ°ç›®æ ‡åˆ—è¡¨"
2. ç›®æ ‡åˆ—è¡¨çš„ class åç§°æ˜¯å¦æ­£ç¡®
3. æ˜¯å¦æœ‰ `drop` äº‹ä»¶è§¦å‘

**å¯èƒ½åŸå› **:

- å…ƒç´ æŸ¥æ‰¾é€»è¾‘å¤±è´¥
- `drop` äº‹ä»¶è¢«é˜»æ­¢

#### é—®é¢˜ï¼šæ”¾ç½®ä½ç½®ä¸æ­£ç¡®

**æ£€æŸ¥**:

1. `dropIndicator` æ˜¯å¦æ­£ç¡®æ˜¾ç¤º
2. `getDragAfterElement()` çš„è¿”å›å€¼
3. é¼ æ ‡ä½ç½®è®¡ç®—æ˜¯å¦æ­£ç¡®

**å¯èƒ½åŸå› **:

- é˜ˆå€¼è®¾ç½®ä¸å½“ï¼ˆ15%, 5%, 20%ï¼‰
- å…ƒç´ ä½ç½®è®¡ç®—é”™è¯¯

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### æ‹–æ‹½æ“ä½œ

1. **å¼€å§‹æ‹–æ‹½**
   - é¼ æ ‡æ‚¬åœåœ¨ä»»åŠ¡å¡ç‰‡ä¸Š
   - æŒ‰ä½å·¦é”®ä¸æ”¾
   - ä»»åŠ¡å¡ç‰‡å˜ä¸ºåŠé€æ˜ï¼ˆdragging æ ·å¼ï¼‰

2. **ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®**
   - æ‹–åŠ¨åˆ°ç›®æ ‡åˆ—
   - ç›®æ ‡åˆ—ä¼šé«˜äº®æ˜¾ç¤º
   - è“è‰²è™šçº¿æŒ‡ç¤ºå™¨æ˜¾ç¤ºæ”¾ç½®ä½ç½®

3. **æ”¾ç½®ä»»åŠ¡**
   - æ¾å¼€é¼ æ ‡å·¦é”®
   - ä»»åŠ¡ç§»åŠ¨åˆ°æ–°ä½ç½®
   - æ•°æ®è‡ªåŠ¨ä¿å­˜

### å¸ƒå±€è¯´æ˜

- **çª—å£å®½åº¦å……è¶³**: å››åˆ—å¹³å‡åˆ†é…ç©ºé—´
- **çª—å£è¾ƒçª„**: å‡ºç°æ¨ªå‘æ»šåŠ¨æ¡
- **æœ€å°åˆ—å®½**: 280pxï¼Œç¡®ä¿å†…å®¹å¯è¯»

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### å·²å®ç°çš„ä¼˜åŒ–

1. **äº‹ä»¶å§”æ‰˜**
   - åœ¨ board ä¸Šç»‘å®šäº‹ä»¶ï¼Œè€Œéæ¯ä¸ªä»»åŠ¡
   - å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡
   - æå‡æ€§èƒ½

2. **é«˜æ•ˆçš„å…ƒç´ æŸ¥æ‰¾**
   - ä½¿ç”¨ while å¾ªç¯ï¼Œæ‰¾åˆ°å³åœæ­¢
   - é¿å…ä¸å¿…è¦çš„ DOM éå†

3. **æ¡ä»¶åˆ¤æ–­ä¼˜åŒ–**
   - æ—©æœŸè¿”å›ï¼ˆearly returnï¼‰
   - å‡å°‘ä¸å¿…è¦çš„è®¡ç®—

---

## âœ… éªŒè¯ç»“æœ

### ç¼–è¯‘æ£€æŸ¥

```bash
npm run build
```

- âœ… TypeScript ç¼–è¯‘é€šè¿‡
- âœ… æ— ç±»å‹é”™è¯¯
- âœ… æ„å»ºæˆåŠŸï¼ˆ0.152sï¼‰

### ä»£ç æ£€æŸ¥

```bash
npm run lint:check
```

- âœ… ESLint é€šè¿‡
- âœ… Prettier æ ¼å¼æ­£ç¡®

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. è§¦æ‘¸å±æ”¯æŒ

```typescript
// æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
board.addEventListener("touchstart", handleTouchStart);
board.addEventListener("touchmove", handleTouchMove);
board.addEventListener("touchend", handleTouchEnd);
```

### 2. æ‹–æ‹½åŠ¨ç”»ä¼˜åŒ–

```css
.zoteroplan-task.dragging {
  opacity: 0.5;
  transform: scale(1.05) rotate(2deg);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  transition: all 0.2s ease;
}
```

### 3. é”®ç›˜å¿«æ·é”®

```typescript
// æ”¯æŒæ–¹å‘é”®ç§»åŠ¨ä»»åŠ¡
document.addEventListener("keydown", (e) => {
  if (selectedTask) {
    if (e.key === "ArrowRight") moveTaskToNextColumn();
    if (e.key === "ArrowLeft") moveTaskToPrevColumn();
  }
});
```

### 4. æ’¤é”€åŠŸèƒ½

```typescript
// ä¿å­˜æ“ä½œå†å²
class UndoManager {
  private history: Operation[] = [];

  undo() {
    const lastOp = this.history.pop();
    if (lastOp) lastOp.revert();
  }
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [MDN - HTML Drag and Drop API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API)
- [MDN - Flexbox](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout)
- [HTML5 Drag and Drop Best Practices](https://www.html5rocks.com/en/tutorials/dnd/basics/)

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-17  
**ä¿®å¤ç‰ˆæœ¬**: 1.0.2  
**çŠ¶æ€**: âœ… å·²éªŒè¯å¯ç”¨
