# 🎯 拖拽功能验证指南

## ✨ 已修复的问题

**问题**：条目之间的信息无法拖拽  
**状态**：✅ 已修复  
**版本**：1.0.0  
**修复时间**：2025-10-17

---

## 🔧 快速验证步骤

### 1️⃣ 重新加载插件

```bash
# 已自动构建完成，直接在 Zotero 中操作：
```

1. 打开 **Zotero**
2. 点击 **工具** → **插件**
3. 点击右上角 **⚙️ 齿轮图标** → **Install Plugin From File...**
4. 选择文件：`.scaffold/build/zotero-plan.xpi`
5. 点击 **确定**，然后 **重启 Zotero**

### 2️⃣ 打开周计划窗口

- 在 Zotero 主界面，点击菜单栏 → **Weekly Plan**
- 或者使用快捷键（如果已设置）

### 3️⃣ 测试拖拽功能

#### ✅ 测试 1：创建任务

1. 在 **"规划"** 列底部输入框输入：`测试任务1`，点击 **+** 添加
2. 再添加：`测试任务2`、`测试任务3`
3. 在 **"待做"** 列添加：`测试任务4`

#### ✅ 测试 2：同列内拖拽排序

1. **拖拽** `测试任务1` 到 `测试任务3` 下方
2. 观察：
   - ✔️ 任务顺序变为：2 → 3 → 1
   - ✔️ 拖拽时显示蓝色虚线放置指示器
   - ✔️ 松开鼠标后任务位置正确

#### ✅ 测试 3：跨列拖拽

1. **拖拽** `测试任务1` 到 **"待做"** 列
2. 观察：
   - ✔️ 任务从"规划"列消失
   - ✔️ 任务出现在"待做"列
   - ✔️ 任务计数更新正确

#### ✅ 测试 4：编辑任务内容

1. **点击** `测试任务1` 的文字内容
2. 观察：
   - ✔️ 光标变为文本光标（`|`）
   - ✔️ 可以正常编辑文字
   - ✔️ 编辑时不会触发拖拽
3. 修改文字为：`已编辑的任务1`
4. **点击** 任务外部区域
5. 观察：
   - ✔️ 修改自动保存
   - ✔️ 文字更新显示

#### ✅ 测试 5：拖拽到空列

1. 在 **"正在做"** 列（如果为空）
2. **拖拽** `测试任务4` 到该列
3. 观察：
   - ✔️ 空列可以正常接收任务
   - ✔️ "还没有任务"提示消失
   - ✔️ 任务正确显示

---

## 🎨 视觉反馈检查

### 光标状态

| 操作区域         | 期望光标              | 说明         |
| ---------------- | --------------------- | ------------ |
| 悬停在任务卡片上 | ✋ `grab`（手形）     | 表示可拖拽   |
| 拖拽任务时       | ✊ `grabbing`（抓取） | 表示正在拖拽 |
| 点击任务内容编辑 | `I` `text`（文本）    | 表示可编辑   |

### 拖拽动画

- ✔️ 拖拽时任务卡片半透明（90% 不透明度）
- ✔️ 拖拽时任务略微缩小（`scale(0.98)`）
- ✔️ 放置指示器为蓝色虚线矩形
- ✔️ 目标列背景色变为淡蓝色

---

## 🐛 如果仍然无法拖拽

### 检查清单

1. **确认插件版本**
   - 打开 Zotero → 工具 → 插件
   - 查看 "Zotero Weekly Plan" 版本是否为 **1.0.0**

2. **清除缓存**
   - 关闭 Zotero
   - 删除 Zotero 配置目录中的缓存文件
   - 重新启动 Zotero

3. **查看控制台日志**
   - 按 `F12` 打开浏览器控制台
   - 查看是否有错误信息
   - 拖拽时应看到：
     ```
     开始初始化拖拽功能
     开始拖拽任务: task_xxx
     放置到列表: zoteroplan-todoList
     放置成功
     拖拽结束
     ```

4. **浏览器兼容性**
   - 确认 Zotero 版本 ≥ 7.0
   - 插件需要现代浏览器引擎支持

---

## 📊 核心修复内容

### TypeScript 修改

**文件**：`src/modules/weekPlan.ts`

**关键代码**：

```typescript
// 阻止内容编辑区域触发拖拽
content.addEventListener("mousedown", (e: Event) => {
  e.stopPropagation(); // 阻止事件冒泡
});

content.addEventListener("dragstart", (e: Event) => {
  e.preventDefault(); // 阻止内容区域的拖拽
  e.stopPropagation();
});
```

### CSS 修改

**文件**：`addon/content/weekPlan.css`

**关键样式**：

```css
/* 任务卡片：禁止文本选择 */
.zoteroplan-task {
  cursor: grab;
  user-select: none;
}

/* 内容区域：允许文本选择 */
.zoteroplan-task-content {
  cursor: text;
  user-select: text;
}

/* 拖拽时光标 */
.zoteroplan-task:active {
  cursor: grabbing;
}
```

---

## 🎯 预期效果

### ✅ 拖拽操作流程

```
1. 悬停任务卡片
   ↓ cursor: grab (手形光标)

2. 点击空白区域开始拖拽
   ↓ cursor: grabbing (抓取光标)
   ↓ 任务半透明显示

3. 拖动到目标位置
   ↓ 显示蓝色虚线指示器
   ↓ 目标列背景变淡蓝色

4. 松开鼠标
   ↓ 任务移动到新位置
   ↓ 自动保存数据
   ✅ 完成！
```

### ✅ 编辑操作流程

```
1. 点击任务文字内容
   ↓ cursor: text (文本光标)
   ↓ 内容获得焦点

2. 修改文字
   ↓ 正常输入/删除

3. 点击外部区域
   ↓ 失去焦点
   ↓ 自动保存修改
   ✅ 完成！
```

---

## 📝 已知限制

1. **拖拽起点**：必须点击任务卡片的**空白区域**（非文字内容）才能拖拽
   - ✅ 正确：点击任务卡片的边缘、背景、元数据区域
   - ❌ 错误：点击任务的文字内容区域

2. **编辑状态**：正在编辑任务时，该任务暂时无法拖拽
   - 解决方法：点击外部区域退出编辑模式后再拖拽

3. **快速操作**：极快速的双击可能同时触发编辑和拖拽
   - 这是浏览器事件机制的限制，属于正常现象

---

## 💡 使用技巧

### 技巧 1：拖拽手柄区域

为了更好的拖拽体验，建议从以下区域开始拖拽：

- ✅ 任务卡片的**上边缘**
- ✅ 任务卡片的**左边缘**
- ✅ 任务卡片的**底部元数据区域**（创建时间、删除按钮附近）

### 技巧 2：快速排序

按住 `Shift` 或 `Ctrl` 键拖拽可能有特殊效果（未来功能）

### 技巧 3：批量移动

先选中多个任务（未来功能），然后一次性拖拽

---

## 📞 问题反馈

如果验证过程中发现问题，请提供以下信息：

1. **操作步骤**：详细描述你的操作
2. **期望结果**：你期望发生什么
3. **实际结果**：实际发生了什么
4. **控制台日志**：F12 打开控制台，复制错误信息
5. **截图/录屏**：如果可能，提供截图或录屏

---

## ✅ 验证完成

如果以上所有测试都通过，恭喜你！🎉

**拖拽功能已完全修复，可以正常使用了！**

---

**验证日期**：**\*\***\_**\*\***  
**验证人员**：**\*\***\_**\*\***  
**测试结果**：☐ 通过 ☐ 未通过  
**备注**：**\*\***\_**\*\***
